System.register(["jimu-core","jimu-ui","jimu-arcgis","esri/views/3d/externalRenderers","jimu-ui/advanced/map"],(function(t,e){var i={},s={},n={},r={},a={};return{setters:[function(t){i.BaseVersionManager=t.BaseVersionManager,i.React=t.React,i.appActions=t.appActions,i.classNames=t.classNames,i.css=t.css,i.getAppStore=t.getAppStore,i.jsx=t.jsx,i.polished=t.polished,i.utils=t.utils},function(t){s.Button=t.Button,s.Dropdown=t.Dropdown,s.DropdownButton=t.DropdownButton,s.DropdownItem=t.DropdownItem,s.DropdownMenu=t.DropdownMenu,s.Icon=t.Icon,s.Nav=t.Nav,s.NumericInput=t.NumericInput,s.Progress=t.Progress,s.Select=t.Select,s.Slider=t.Slider,s.WidgetPlaceholder=t.WidgetPlaceholder,s.defaultMessages=t.defaultMessages},function(t){n.JimuMapViewComponent=t.JimuMapViewComponent,n.loadArcGISJSAPIModules=t.loadArcGISJSAPIModules},function(t){r.default=t.default},function(t){a.Draw=t.Draw}],execute:function(){t((()=>{var t={41553:t=>{t.exports='<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.438.994c.213 0 .397.146.44.35.151.722.257 1.34.316 1.852.374.16.725.362 1.048.599l1.728-.676a.455.455 0 01.556.188l1.42 2.394a.43.43 0 01-.091.547 21.98 21.98 0 01-1.49 1.194 5.17 5.17 0 01-.007 1.183l1.464 1.119a.43.43 0 01.111.563l-1.42 2.394a.454.454 0 01-.53.197 22.445 22.445 0 01-1.807-.66c-.325.233-.679.43-1.055.586l-.263 1.794a.446.446 0 01-.445.376H6.574a.446.446 0 01-.44-.35 21.019 21.019 0 01-.317-1.853 5.34 5.34 0 01-1.047-.598l-1.728.675a.455.455 0 01-.556-.187l-1.42-2.395a.43.43 0 01.091-.546c.567-.49 1.063-.888 1.49-1.194a5.167 5.167 0 01.008-1.183L1.19 6.243a.43.43 0 01-.112-.562l1.42-2.395a.455.455 0 01.531-.196c.719.233 1.321.453 1.807.66.324-.233.679-.43 1.056-.587l.262-1.794A.446.446 0 016.6.994h2.839zm-.365 1H6.985l-.28 1.866-.467.19c-.235.095-.46.21-.672.34l-.207.136-.42.293-.476-.197c-.328-.137-.718-.281-1.169-.433l-.221-.074-1.045 1.719L3.59 6.999l-.06.479a4.127 4.127 0 00-.021.816l.014.144.058.492-.419.294c-.288.203-.615.451-.979.746l-.177.145 1.043 1.72 1.845-.703.406.29c.204.146.42.274.645.384l.228.103.474.199.059.49c.04.338.103.731.19 1.177l.043.219h2.088l.282-1.867.466-.19c.236-.095.46-.21.672-.34l.207-.136.419-.293.476.198c.33.136.72.28 1.17.433l.22.072 1.044-1.718-1.56-1.165.06-.479a4.131 4.131 0 00.02-.815l-.013-.144-.06-.492.42-.295a18.1 18.1 0 00.98-.746l.176-.146-1.043-1.72-1.844.705-.406-.29a4.496 4.496 0 00-.646-.385l-.228-.103-.474-.199-.058-.49c-.032-.27-.08-.576-.14-.916l-.094-.48zm-1.067 3a3 3 0 110 6 3 3 0 010-6zm0 1a2 2 0 100 4 2 2 0 000-4z" fill="#000"></path></svg>'},7182:t=>{t.exports='<svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M20 1l-3.803 14-7.38-2.184 2.796-3.497-4.711 2.965L0 10.279 20 1zm-1.605 1.864l-15.519 7.2 3.856 1.12L16.24 5.2l-5.665 7.084 4.869 1.44 2.95-10.86z" fill="#000"></path><path d="M8.8 14l3 .695L8.8 18v-4z" fill="#000"></path></svg>'},82633:t=>{t.exports='<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.838 3l-1.94-1.616.641-.768L16 3.5l-3.46 2.884-.641-.768L13.838 4H3.37C2.061 4 1 5.191 1 6.5S2.061 9 3.37 9h9.25C14.487 9 16 10.133 16 12s-1.513 3-3.38 3H1v-1h11.62c1.314 0 2.38-.686 2.38-2s-1.066-2-2.38-2H3.37C1.509 10 0 8.361 0 6.5S1.509 3 3.37 3h10.468z" fill="#000"></path></svg>'},74904:t=>{t.exports='<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8.793 1.14a.984.984 0 011.32-.085l.094.085 5.5 5.624c.36.368.388.948.083 1.35l-.083.096-6.5 6.646a.992.992 0 01-.576.291l-.131.009h-4a.986.986 0 01-.608-.21l-.099-.09-3.5-3.579a1.04 1.04 0 01-.083-1.35l.083-.096 8.5-8.691zm.707.706l-8.492 8.685c-.007.007-.01.02-.007.032l.007.015 3.497 3.577h3.989l6.498-6.644c.007-.008.01-.022.007-.033l-.007-.015L9.5 1.846zM3.006 10.19l1.838-1.85 3.922 4.107.005.01c.002.01 0 .02-.005.025l-.413.358h-2.85l-2.497-2.615L3 10.214c-.002-.009 0-.019.005-.024z" fill="#000"></path></svg>'},65283:t=>{t.exports='<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M.438 1C.196 1 0 1.224 0 1.5s.196.5.438.5h15.124c.242 0 .438-.224.438-.5s-.196-.5-.438-.5H.438zM0 7.5c0-.276.196-.5.438-.5h15.124c.242 0 .438.224.438.5s-.196.5-.438.5H.438C.196 8 0 7.776 0 7.5zM0 13.5c0-.276.196-.5.438-.5h15.124c.242 0 .438.224.438.5s-.196.5-.438.5H.438C.196 14 0 13.776 0 13.5z" fill="#000"></path></svg>'},57986:t=>{t.exports='<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 1H4v14h1V1zm7 0h-1v14h1V1z" fill="#000"></path></svg>'},56097:t=>{t.exports='<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 1l12 7-12 7V1zm9.983 6.999L3 2.723v10.553l8.983-5.277z" fill="#000"></path></svg>'},10466:t=>{t.exports='<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.489.072l.848.29-.989 2.71-.784-.465.925-2.535zM12.594 2.974l-2.44 1.128.25.85 2.579-1.194-.39-.784zM2.04 7.854l.39.784 2.578-1.191-.529-.72L2.04 7.853zM5.554 2.862L4.58.896 5.392.52l.974 1.966-.812.375zM4.272 4.591l-2.624-.894-.299.82 2.805.957.118-.883z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M6.3 3.383l9 6.285h-3.874l2.315 4.421-2.686 1.294-2.373-4.498L6.3 14.009V3.383zM7.299 5.3v5.748l1.537-2.014 2.653 5.03.886-.427-2.601-4.97h2.347L7.299 5.3z" fill="#000"></path></svg>'},84205:t=>{t.exports='<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 1a1 1 0 11-2 0 1 1 0 012 0zm-4 2a1 1 0 100-2 1 1 0 000 2zm-1.812 10L11 4 3 9.328l4.438.337L10.188 13zM2 15a1 1 0 11-2 0 1 1 0 012 0zm2 0a1 1 0 100-2 1 1 0 000 2zm3-3a1 1 0 11-2 0 1 1 0 012 0z" fill="#000"></path></svg>'},29786:t=>{t.exports='<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 2h2a2 2 0 012 2v7.817l-3 2.812-3-2.812V4a2 2 0 012-2zm5 2v8.25L8 16l-4-3.75V4a3 3 0 013-3h2a3 3 0 013 3zM9 6a1 1 0 11-2 0 1 1 0 012 0zm1 0a2 2 0 11-4 0 2 2 0 014 0z" fill="#000"></path></svg>'},43126:t=>{t.exports='<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.582 5L11 10.949V12H9v-1.274L5.316 7h-.515L2 12.383V14H0v-2h1.073L4 6.374V5h2v1.27L9.688 10h.716L14 4.029V3h2v2h-1.418z" fill="#000"></path></svg>'},65615:t=>{t.exports='<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7.734.46L2.86 5.377v-2.99L1 0l6.734.46zM1.764 2.99A8 8 0 108.956.057l-.743.946a7 7 0 11-6.107 3.22l-.094-.992-.248-.242zM9 8a1 1 0 11-2 0 1 1 0 012 0z" fill="#000"></path></svg>'},58884:t=>{"use strict";t.exports=r},26826:t=>{"use strict";t.exports=n},48891:t=>{"use strict";t.exports=i},30726:t=>{"use strict";t.exports=s},58290:t=>{"use strict";t.exports=a}},e={};function o(i){var s=e[i];if(void 0!==s)return s.exports;var n=e[i]={exports:{}};return t[i](n,n.exports,o),n.exports}o.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return o.d(e,{a:e}),e},o.d=(t,e)=>{for(var i in e)o.o(e,i)&&!o.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},o.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),o.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.p="";var l={};return o.p=window.jimuConfig.baseUrl,(()=>{"use strict";o.r(l),o.d(l,{default:()=>Be});var t,e,i,s,n,r=o(48891),a=o(30726),h=o(26826),c=o(58884);!function(t){t.Rotate="ROTATE",t.Path="PATH",t.Route="ROUTE"}(t||(t={})),function(t){t.CW="CW",t.CCW="CCW"}(e||(e={})),function(t){t.Smoothed="CURVED",t.RealPath="LINE"}(i||(i={})),function(t){t.Forward="FORWARD",t.Backward="BACKWARD"}(s||(s={})),function(t){t.Horizontal="HORIZONTAL",t.Vertical="VERTICAL",t.Palette="PALETTE"}(n||(n={}));const d="Rotate fly",u="Fly along path",p="Plan routes",g="Speed";var v,m=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{l(s.next(t))}catch(t){r(t)}}function o(t){try{l(s.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((s=s.apply(t,e||[])).next())}))};class y{constructor(){this.symbolJsonUtils=null,this.getDefaultPointSymbol=t=>this.symbolJsonUtils.fromJSON({type:"PointSymbol3D",symbolLayers:[{type:"Icon",material:{color:t},size:12,outline:{color:[255,255,255],size:.75}}],verticalOffset:{screenLength:5,minWorldLength:5,maxWorldLength:10},callout:{type:"line",color:[255,255,255],size:2,border:{color:[50,50,50]}}}),this.getDefaultLineSymbol=t=>this.symbolJsonUtils.fromJSON({type:"LineSymbol3D",symbolLayers:[{type:"Line",material:{color:t,transparency:50},join:"round",cap:"round",size:2.25}]})}setup(){return m(this,void 0,void 0,(function*(){return yield(0,h.loadArcGISJSAPIModules)(["esri/symbols/support/jsonUtils"]).then((t=>m(this,void 0,void 0,(function*(){[this.symbolJsonUtils]=t})))),this}))}}!function(t){t[t.Default=0]="Default",t[t.Custom=1]="Custom"}(v||(v={}));class f{constructor(t){return this.update(t)}update(t){const{graphics:e,isPicked:i}=t;return this.setGraphics(e),this.isPicked=i,this.symbolType=v.Default,this}setGraphics(t){this.graphics=t}getGraphics(){return this.graphics}destructor(){}getMainGraphic(){return this.graphics?this.graphics[0]:null}updateByConfig(){}getConfig(){var t;const e={graphics:null,isPicked:this.isPicked,symbolType:v.Default};return e.graphics=null===(t=this.graphics)||void 0===t?void 0:t.map((t=>{const e=t.clone();if(e.symbol=null,e.toJSON)return e.toJSON()})),e}}const w=0,P=1,S=8,C=3,b=50,M=0,I=800,x=10,G=0,L=90,A=1,R=0,T=1;function j(t,e,i){const s=q(e)?e:1,n=[];return c.default.toRenderCoordinates(i,t,0,null,n,0,s),n}function D(t,e,i){const s=q(e)?e:1,n=[];return c.default.fromRenderCoordinates(i,t,0,n,0,null,s),n}function k(t){return t*Math.PI/180}function O(t){return 180*t/Math.PI}function V(t,e){const i=e[0]-t[0],s=e[1]-t[1],n=e[2]-t[2],r=i*i+s*s+n*n;return Math.sqrt(r)}function F(t,e,i){const s=[];return s[0]=(e[0]-t[0])*i+t[0],s[1]=(e[1]-t[1])*i+t[1],s[2]=(e[2]-t[2])*i+t[2],s}function N(t,e,i,s,n,r,a){const o=t,l=null!=e?e:null,h=null!=i?i:null;if(null===l||null===h)return 0;const c=n.create();s.subtract(c,l,o);const d=n.create();s.subtract(d,h,l);const u=n.create();return r.renderCoordsHelper.worldUpAtPosition(l,u),O(a.angle(c,d,u))}function _(t,e){return e.groundView.elevationSampler.queryElevation(t)}function U(t){let e=0;for(let i=0,s=t.length;i<s;i++){const s=t[i];q(s)&&!1!==s.isInUse&&e++}return e}function E(t,e){let i;const s=(P-w)/2;return t<s?i=1/((s-t)/s*S):(i=(t-s)/(P-s)*S,0===i&&(i=1)),parseFloat(i.toFixed(q(e)?e:C))}function H(t,e){return(i=Number(t),B((null==i?void 0:i.toFixed)?parseFloat(i.toFixed(R)):NaN)).toString()+" "+e;var i}function B(t){return null===t||isNaN(t)?0:t}function z(t,e){const i=null==t?void 0:t.find((t=>t.idx===e.routeUuid));return i}function W(t,e){var i;const s=z(t,e);return null===(i=null==s?void 0:s.records)||void 0===i?void 0:i.find((t=>t.idx===e.recordUuid))}function J(t,e,i){const s=z(t,e);return null==s?void 0:s.records[i]}function $(t){return(null==t?void 0:t.startsWith("fly__"))?t.replace("fly__",""):t}function q(t){return null!=t}var Z;!function(t){t[t.Choose3DMap=0]="Choose3DMap",t[t.ConfigError=1]="ConfigError"}(Z||(Z={}));class Q{constructor(t){this.getDefaultError=()=>this.chooseMapTip,this.isError=()=>this.isNoMapId()||this.isNoScene()||this.isNoModeInSetting(),this.setError=t=>{t!==this.widget.state.errorTip&&this.widget.setState({errorTip:t})},this.setErrorByType=t=>{t===Z.Choose3DMap&&this.setError(this.chooseMapTip)},this.isNoScene=()=>!q(this.widget.state.jimuMapView),this.isNoModeInSetting=()=>U(this.widget.props.config.itemsList)<1,this.isNoMapId=()=>!q(this.widget.props.useMapWidgetIds)||!q(this.widget.props.useMapWidgetIds[0]),this.checkErrorInConfig=()=>{this.isNoScene()||this.isNoMapId()?this.setError(this.chooseMapTip):this.isNoModeInSetting()?this.setError(this.configErrorTip):q(this.widget.jimuMapView)&&this.setError("")},this.widget=t.widget,this.chooseMapTip=this.widget.props.intl.formatMessage({id:"chooseMapTip",defaultMessage:"Please select a map with 3D data."}),this.configErrorTip=this.widget.props.intl.formatMessage({id:"configErrorTip",defaultMessage:"Please select at least one fly style."})}}function Y(t){const e=t.surfaces[1];return r.css`
    position: relative;
    border: ${e.border.width} solid ${e.border.color};

    .bar {
      display: flex;
      background-color: ${e.bg};

      .btns, dropdowns{
        width: 32px;
        height: 32px;
        border: none;
      }
      .btns {
        margin: 5px;
        border-radius: 0;
      }

      .speed-controller{
        margin: 0 8px;
      }

      .progress-bar-wapper {
        /*display: flex;*/
        position: absolute;
        width: 100%;
        bottom: 0px;
      }
      .items {
        display: flex;
        position: relative;
      }
      .items .item {
        display: flex;
        background: ${e.bg};
      }
      /*.items .btn .jimu-icon{
        margin: 0;
      }*/
      .separator-line{
        width: 2px;
        margin: 4px 1px;
        border-right: ${e.border.width} solid ${e.border.color};
      }
      .speed-wapper{
        width: 214px;
      }
    }
    .bar .hide,
    .bar .items.hide {
      display: none;
    }
    `}function K(t){let e="hide";return t&&(e=""),e}function X(t){let e="";return t&&(e="hide"),e}class tt extends r.React.PureComponent{renderSeparator(){return(0,r.jsx)("div",{className:"separator-line"})}render(){return(0,r.jsx)("div",{css:Y(this.props.theme),className:"fly-wapper d-flex"},(0,r.jsx)(a.Nav,{navbar:!0,className:"bar"},(0,r.jsx)("div",{className:"items d-flex flex-row justify-content-around"},(0,r.jsx)("div",{className:"d-flex"},(0,r.jsx)("div",{className:"setting-btns-wapper items "+X(this.props.isPlaying)},(0,r.jsx)("div",{className:"item"},this.props.flyStyleContent),!this.props.isRouteMode&&(0,r.jsx)(r.React.Fragment,null,(0,r.jsx)("div",{className:"item"},(0,r.jsx)("div",{className:"d-flex"},this.renderSeparator(),this.props.graphicInteractionManager)),(0,r.jsx)("div",{className:"item"},this.props.liveviewSettingContent)),this.props.isRouteMode&&(0,r.jsx)(r.React.Fragment,null,this.props.graphicInteractionManager,this.props.routeListContent)),(0,r.jsx)("div",{className:K(this.props.isPlaying)},(0,r.jsx)("div",{className:"speed-wapper h-100"},this.props.speedController))),(0,r.jsx)("div",{className:"d-flex"},(0,r.jsx)("div",{className:"item"},this.renderSeparator(),this.props.playStateContent)),(0,r.jsx)("div",{className:"progress-bar-wapper "+K(this.props.isPlaying)},this.props.progressBar))))}}function et(t){const e=t.surfaces[1],i="left",s="right";return r.css`
    .plan-route-mode {
      margin-top: ${-44}px;
    }

    .palette-wapper {
      position: relative;
      width: ${144}px;
      height: ${92}px;

      .hide{
        display: none;
      }

      .btns,
      .dropdowns{
        position: absolute;
        width: ${32}px;
        height: ${32}px;
        border-radius: 50%;
      }
      .btns:not(.active){
        background-color: ${e.bg};
        border: ${e.border.width} solid ${e.border.color};
      }

      .play-btn{
        width: ${48}px;
        height: ${48}px;
        bottom: 0;
        ${i}: ${48}px;
      }
      .draw-btn{
        ${i}: 16px;
        top: 16px;
      }
      .pick-btn{
        top: 0;
        ${i}: ${56}px;
      }
      .clear-btn{
        ${s}: 16px;
        top: 16px;
      }

      .flystyle-btn{
        ${i}: 0;
        bottom: ${8}px;
      }
      .routes-dropdown,
      .liveview-btn{
        ${s}: 0;
        bottom: ${8}px;
      }

      .progress-bar-wapper{
        position: absolute;
        width: ${54}px;
        height: ${54}px;
        ${i}: ${45}px;
        bottom: 20px;
      }

      .speedcontroller-btn{
        position: absolute;
        width: ${40}px;
        height: ${16}px;
        bottom: 0;
        ${i}: 78px;
        border: ${e.border.width} solid ${e.border.color};
        border-radius: 10px;
        background-color: ${e.bg};
      }

      .speedcontroller-text{
        font-size: 10px;
        padding: 0;

        .icon-btn-sizer{
          min-height: 0;
        }
      }
    }`}function it(t){let e=" hide ";return t&&(e=""),e}function st(t){let e="";return t&&(e=" hide "),e}function nt(t){let e="";return t&&(e=" plan-route-mode "),e}class rt extends r.React.PureComponent{render(){return(0,r.jsx)("div",{css:et(this.props.theme),className:"fly-wapper d-flex"},(0,r.jsx)("div",{className:"palette-wapper"+nt(this.props.isRouteMode)},(0,r.jsx)("div",{className:"progress-bar-wapper"+it(this.props.isPlaying)},this.props.progressBar),(0,r.jsx)("div",{className:st(this.props.isPlaying)},this.props.flyStyleContent,!this.props.isRouteMode&&(0,r.jsx)(r.React.Fragment,null,this.props.graphicInteractionManager,this.props.liveviewSettingContent),this.props.isRouteMode&&(0,r.jsx)(r.React.Fragment,null,this.props.graphicInteractionManager,this.props.routeListContent)),this.props.playStateContent,(0,r.jsx)("div",{className:it(this.props.isPlaying)},this.props.speedController)))}}function at(t){return r.css`
  padding: 5px 10px;
  border: 1px solid ${t.colors.palette.light[400]};

  .dropdown-items{
    padding: 10px;
  }
  .dropdown-item{
    padding: 5px 0;
  }
  .dropdown-item-title{
    font-size: 13px;
    padding-bottom:5px;
  }

  .dropdown-item-comment{
    font-style:italic;
    font-size: 12px;
    color: ${t.colors.palette.light[600]};
    letter-spacing: 0;
  }

  .setting-altitude-separator{
    margin: 0 8px 0 4px;
  }

  .alt-wapper {
    align-items: center;
    font-size: 13px;
  }
  .alt-input {
    width: 60px
  }
  `}var ot=o(65283),lt=o.n(ot);const ht=t=>{const{className:e}=t,i=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i}(t,["className"]),s=(0,r.classNames)("jimu-icon-component",e);return r.React.createElement(a.Icon,Object.assign({className:s,icon:lt()},i))};class ct extends r.React.PureComponent{constructor(e){super(e),this.togglePopup=()=>{this.setState({isPopupOpen:!this.state.isPopupOpen})},this.handleActivedRouteChangeBySelect=t=>{const e=t.target.value;this.handleActivedRouteChange(e)},this.handleActivedRouteChange=t=>{this.props.onActivedRouteChange(t)},this.getStyle=()=>r.css`
      .routes-dropdown {
        width: 170px;

        .jimu-dropdown-button,
        .jimu-dropdown-button:hover{
          height: 100%;
          border: none;
        }
      }
      `,this._getItemByActivedItemUuid=()=>{let e=null;return q(this.props.activedItemUuid)&&q(this.props.itemsList)&&(e=this.props.itemsList.find((e=>e.config.uuid===this.props.activedItemUuid&&t.Route===e.config.name))),e},this.getActivedRouteName=t=>{const e=z(null==t?void 0:t.routes,{routeUuid:this.props.activedRouteUuid});return null==e?void 0:e.displayName},this.state={isPopupOpen:!1}}componentDidUpdate(t,e){const i=!t.graphicInteractionManagerRef&&!!this.props.graphicInteractionManagerRef;if(t.itemsList===this.props.itemsList&&!i)return;const s=this._findFirstInUseRoute(this._getRoutesConfig());s&&this.handleActivedRouteChange(s.idx)}getRouteItemStyle(){return r.css`
      .route-item {
        max-width: 120px;
        text-overflow: ellipsis;
        overflow: hidden;
      }
    `}render(){const{isRouteMode:t,isEnable:e,layout:i}=this.props,s=this.props.intl.formatMessage({id:"plannedRoutesTip",defaultMessage:"Routes"}),o=this._getItemByActivedItemUuid(),l=null==o?void 0:o.config,h=this.getActivedRouteName(l),c=this._getRoutesConfig();return t&&(0,r.jsx)("div",{className:"h-100 item",css:this.getStyle()},i===n.Palette&&(0,r.jsx)(a.Dropdown,{isOpen:this.state.isPopupOpen,disabled:!e,toggle:this.togglePopup,className:"btns routes-dropdown dropdowns",activeIcon:!0},(0,r.jsx)(a.DropdownButton,{icon:!0,className:"dropdown-btn",type:"tertiary",arrow:!1,title:null!=h?h:s},(0,r.jsx)(ht,null)),(0,r.jsx)(a.DropdownMenu,{showArrow:!0,css:at(this.props.theme)},c.map(((t,e)=>t.isInUse&&(0,r.jsx)("div",{key:e},(0,r.jsx)(a.DropdownItem,{title:t.displayName,onClick:()=>this.handleActivedRouteChange(t.idx),active:this.props.activedRouteUuid===t.idx},(0,r.jsx)("div",{css:this.getRouteItemStyle()},(0,r.jsx)("div",{className:"mx-2 route-item"},t.displayName)))))))),i===n.Horizontal&&(0,r.jsx)(r.React.Fragment,null,(0,r.jsx)("div",{className:"separator-line"}),(0,r.jsx)(a.Select,{onChange:this.handleActivedRouteChangeBySelect,placeholder:null!=h?h:s,className:"routes-dropdown",disabled:!e},c.map(((t,e)=>t.isInUse&&(0,r.jsx)("option",{key:e,label:t.displayName,title:t.displayName,value:t.idx,selected:this.props.activedRouteUuid===t.idx},(0,r.jsx)("div",{css:this.getRouteItemStyle()},(0,r.jsx)("div",{className:"route-item"},t.displayName))))))))}_getRoutesConfig(){const t=this._getItemByActivedItemUuid(),e=null==t?void 0:t.config;return null==e?void 0:e.routes}_findFirstInUseRoute(t){return t.find((t=>!!t.isInUse))}}class dt{constructor(t){this.GraphicsLayer=null,this.Point=null,this.clearAll=()=>{q(this.auxGraphicsLayer)&&this.auxGraphicsLayer.removeAll(),q(this.auxMovingObjLayer)&&this.auxMovingObjLayer.removeAll()},this.deposeMoving=()=>{this.auxMovingObjLayer.removeAll()},this.drawPoint=(t,e)=>{const i=q(e)?e:"darkgreen",s=new this.Graphic({geometry:t,symbol:{type:"point-3d",symbolLayers:[{type:"icon",size:12,resource:{primitive:"circle"},material:{color:i},outline:{color:"limegreen"}}]}});return this.auxMovingObjLayer.add(s),s},this.drawPointGL=(t,e)=>{const i=D(t,1,this.sceneView),s=new this.Point({x:i[0],y:i[1],z:i[2],spatialReference:this.sceneView.spatialReference});s.z<100&&(s.z=100);const n=q(e)?e:"darkgreen",r=new this.Graphic({geometry:s,symbol:{type:"point-3d",symbolLayers:[{type:"icon",size:12,resource:{primitive:"circle"},material:{color:n},outline:{color:"limegreen"}}]}});return this.auxMovingObjLayer.add(r),r},this.drawLine=(t,e)=>{const i=q(e)?e:"lightblue",s=new this.Graphic({geometry:{type:"polyline",paths:t,spatialReference:this.sceneView.spatialReference},symbol:{type:"line-3d",symbolLayers:[{type:"line",material:{color:i},size:3}]}});return this.auxGraphicsLayer.add(s),s},this.drawLineXY=(t,e)=>{const i=[];for(let e=0,s=t.length;e<s;e++){const s=t[e],n=s[0],r=s[1],a=s[2];0===a?i.push([n,r]):i.push([n,r,a])}const s=q(e)?e:"lightblue",n=new this.Graphic({geometry:{type:"polyline",paths:i,spatialReference:this.sceneView.spatialReference},symbol:{type:"line-3d",symbolLayers:[{type:"line",material:{color:s},size:3}]}});return this.auxGraphicsLayer.add(n),n},this.drawLineGL=(t,e,i)=>{const s=q(i)?i:"lightblue",n=[];for(let i=0,s=t.length;i<s;i++){const s=D(t[i],1,e);n.push(s)}const r=new this.Graphic({geometry:{type:"polyline",paths:n,spatialReference:this.sceneView.spatialReference},symbol:{type:"line-3d",symbolLayers:[{type:"line",material:{color:s},size:3}]}});return this.auxGraphicsLayer.add(r),r},(0,h.loadArcGISJSAPIModules)(["esri/layers/GraphicsLayer","esri/geometry/Point","esri/Graphic","esri/views/3d/support/projectionUtils","esri/geometry/support/webMercatorUtils"]).then((t=>{[this.GraphicsLayer,this.Point,this.Graphic,this.projectionUtils,this.webMercatorUtils]=t,this.auxGraphicsLayer=new this.GraphicsLayer({listMode:"hide"}),this.sceneView.map.add(this.auxGraphicsLayer),this.auxMovingObjLayer=new this.GraphicsLayer({listMode:"hide"}),this.sceneView.map.add(this.auxMovingObjLayer)})),this.sceneView=t.sceneView}}var ut;!function(t){t[t.NONE=0]="NONE",t[t.In=1]="In",t[t.Out=2]="Out",t[t.InOut=3]="InOut",t[t.Linear=4]="Linear"}(ut||(ut={}));var pt=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{l(s.next(t))}catch(t){r(t)}}function o(t){try{l(s.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((s=s.apply(t,e||[])).next())}))};class gt{constructor(){this.easing=(t,e)=>{switch(this.state.mode){case ut.In:return this.easingIn(t,e);case ut.InOut:return this.easingInOut(t,e);case ut.Linear:return this.linear(t,e);case ut.NONE:return this.uniformSpeed(t,e)}},this.uniformSpeed=(t,e)=>{this.updateCurrentDuration(t*e);const i=this.getMovementByFrame(t)*e;return this.state.progress=0,{interp:0,step:i,progress:this.state.progress}},this.linear=(t,e)=>{const i=this.updateCurrentDuration(t*e);let s=0,n=0;return i<this.state.interp.time.duration?(r=i,a=this.state.interp.value.start,o=this.state.interp.value.end,l=this.state.interp.time.duration,s=o*r/l+a,n=s-this.state.interp.cache.lastVal,this.state.interp.cache.lastVal=s,this.state.progress=s/this.state.interp.value.end):this.state.progress=1,{interp:s,step:n,progress:this.state.progress};var r,a,o,l},this.easingIn=(t,e)=>{const i=this.updateCurrentDuration(t*e);let s=0,n=0;return i<this.state.interp.time.duration?(r=i,a=this.state.interp.value.start,o=this.state.interp.value.end,l=this.state.interp.time.duration,s=o*(r/=l)*r+a,n=s-this.state.interp.cache.lastVal,this.state.interp.cache.lastVal=s,this.state.interp.cache.lastStep=n):n=this.state.interp.cache.lastStep*e,this.state.progress=-1,{interp:s,step:n,progress:this.state.progress};var r,a,o,l},this.easingInOut=(t,e)=>{const i=this.updateCurrentDuration(t*e);let s=0,n=0;return i<this.state.interp.time.duration?(r=i,a=this.state.interp.value.start,o=this.state.interp.value.end,l=this.state.interp.time.duration,s=(r/=l/2)<1?o/2*r*r+a:-o/2*(--r*(r-2)-1)+a,n=s-this.state.interp.cache.lastVal,this.state.interp.cache.lastVal=s,this.state.progress=s/this.state.interp.value.end):this.state.progress=1,{interp:s,step:n,progress:this.state.progress};var r,a,o,l},this.getMovementByFrame=t=>this.getSpeed()/(1e3/t)}setup(){return pt(this,void 0,void 0,(function*(){return yield(0,h.loadArcGISJSAPIModules)(["esri/core/scheduling"]).then((t=>{[this.scheduling]=t})),this.state={speed:b,mode:ut.NONE,progress:0,amount:-1,interp:{time:{begin:0,currentDuration:0,duration:1e4},value:{start:0,end:0},cache:{lastVal:0,lastStep:0}}},this.animatHandler=null,this}))}getState(){return this.state}setState(t){this.state=t}init(t,e,i,s){this.state.mode=t,this.state.interp.value.start=e,this.state.interp.value.end=i,this.state.interp.time.duration=s}reset(){this.state.interp.time.begin=0,this.state.interp.time.currentDuration=0,this.state.progress=0}computeDuration(){return this.state.amount/this.state.speed*1e3}getDuration(){return this.state.interp.time.duration}setAmount(t){return this.state.amount=t,this}getAmount(){return this.state.amount}getProgress(){return this.state.progress}progressForward(){return this.state.progress+=1e-4,this.state.progress}progressBackward(){return this.state.progress-1e-4}updateCurrentDuration(t){return this.state.interp.time.currentDuration=this.state.interp.time.currentDuration+t,isNaN(this.state.interp.time.currentDuration)&&(this.state.interp.time.currentDuration=0),this.state.interp.time.currentDuration}getSpeed(){return this.state.speed}setSpeed(t){this.state.speed=t}update(t){return pt(this,void 0,void 0,(function*(){null===this.animatHandler&&(this.animatHandler=this.scheduling.addFrameTask({update:e=>{t(e)}}))}))}stop(){null!==this.animatHandler&&(this.animatHandler.pause(),this.animatHandler.remove(),this.animatHandler=null)}insertAnExtraFrame(t){var e;null===(e=this.scheduling)||void 0===e||e.schedule((e=>{t(e)}))}}class vt{constructor(){return this.abort(),this.update(),this}destructor(){this.signalHandler&&(this.signalHandler.abort(),this.signalHandler=null)}update(){return this.signalHandler=null,this.signalHandler=new AbortController,this.signalHandler.signal}abort(){var t;(null===(t=this.signalHandler)||void 0===t?void 0:t.signal)&&this.signalHandler.abort()}}class mt{constructor(){this.DEFAULT_SPEED=(w+P)/2,this.state=mt._getDefualtLiveviewSetting()}static _getDefualtLiveviewSetting(){return{speedFactor:.5,fixHeading:NaN,fixTilt:NaN,fixAltitude:0,initCamOffset:{height:60,distance:90}}}getState(){return this.state}setState(t){this.state=t}getCamOffsetHeight(){return this.state.initCamOffset.height}getCamOffsetDistance(){return this.state.initCamOffset.distance}setSpeedFactor(t){let e;e=void 0===t?this.DEFAULT_SPEED:t,this.state.speedFactor=parseFloat(e)}getSpeedFactor(){return void 0===this.state.speedFactor?.5:this.state.speedFactor}getMappingSpeedFactor(){return void 0===this.state.speedFactor?this.DEFAULT_SPEED:E(this.state.speedFactor)}setHeadingFactor(t){let e=0;void 0!==t&&(e=t),this.state.fixHeading=e}getHeadingFactor(){return q(this.state.fixHeading)?this.state.fixHeading:0}setTiltFactor(t){let e=0;void 0!==t&&(e=t),this.state.fixTilt=e}getTiltFactor(t){return t||q(this.state.fixTilt)?this.state.fixTilt:0}setAltitudeFactor(t){let e=0;void 0!==t&&(e=t),this.state.fixAltitude=e}getAltitudeFactor(t){return t||q(this.state.fixAltitude)?this.state.fixAltitude:0}}var yt,ft,wt=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{l(s.next(t))}catch(t){r(t)}}function o(t){try{l(s.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((s=s.apply(t,e||[])).next())}))};!function(t){t.Rotate="ROTATE",t.Smoothed="CURVED",t.RealPath="LINE"}(yt||(yt={})),function(t){t[t.INITED=-1]="INITED",t[t.PREPARING=0]="PREPARING",t[t.PREPARED=1]="PREPARED",t[t.RUNNING=2]="RUNNING",t[t.STOPPED=3]="STOPPED"}(ft||(ft={}));class Pt{constructor(){this.Camera=null,this._resume=t=>wt(this,void 0,void 0,(function*(){return yield this.preparing(),!!(yield t)&&(yield this.prepared(),this._doFly(),!0)})),this.rotateBySceneMode=(t,e,i,s)=>{const n=this.vec3d.fromValues(t[0],t[1],t[2]),r=this.vec3d.create();q(s)&&(this.vec3.negate(r,s),this.vec3.add(n,n,r));const a=this.mat4d.create();return this.mat4.rotate(a,a,k(i),e),this.vec3.transformMat4(n,n,a),q(s)&&this.vec3.subtract(n,n,r),n},this.queryGeometryElevInfo=t=>{var e;return q(null===(e=this.sceneView.groundView)||void 0===e?void 0:e.elevationSampler)?this.sceneView.groundView.elevationSampler.queryElevation(t):t.hasZ?t:void 0},this._coordsToGeoArray=t=>{const e=[];let i;for(let s=0,n=t.length;s<n;s++)i=this.vec3d.fromValues(t[s].x,t[s].y,t[s].z),e.push(i);return e},this.getPrepareGoToOptionsBeforeTerrainLoaded=t=>{const e={animate:!0,maxDuration:4e3,easing:"out-expo",signal:this.abortSignalHandler.update()};return t&&!t.animate&&(e.animate=!1,delete e.maxDuration,delete e.easing),e},this.getPrepareGoToOptionsAfterTerrainLoaded=t=>{const e={animate:!0,maxDuration:1e3,easing:"out-expo",signal:this.abortSignalHandler.update()};return t&&!t.animate&&(e.animate=!1,delete e.maxDuration,delete e.easing),e}}setup(t){return wt(this,void 0,void 0,(function*(){return yield(0,h.loadArcGISJSAPIModules)(["esri/core/libs/gl-matrix-2/vec3f64","esri/core/libs/gl-matrix-2/mat4f64","esri/core/libs/gl-matrix-2/vec3","esri/core/libs/gl-matrix-2/mat4","esri/core/libs/gl-matrix-2/quatf64","esri/core/libs/gl-matrix-2/quat","esri/views/3d/externalRenderers","esri/views/3d/support/cameraUtils","esri/views/3d/webgl-engine/lib/Camera","esri/geometry/Point","esri/views/3d/support/mathUtils","esri/core/watchUtils","esri/Camera"]).then((e=>wt(this,void 0,void 0,(function*(){[this.libVec3f64,this.libMat4f64,this.libVec3,this.libMat4,this.libQuatf64,this.libQuat,this.externalRenderers,this.cameraUtils,this.GLCamera,this.Point,this.esriMathUtils,this.watchUtils,this.Camera]=e,this.vec3=this.libVec3.vec3,this.vec3d=this.libVec3f64.vec3f64,this.mat4=this.libMat4.mat4,this.mat4d=this.libMat4f64.mat4f64,this.quat=this.libQuat.quat,this.quatd=this.libQuatf64.quatf64,yield this.clear();const{id:i,type:s,geometry:n,direction:r,config:a,sceneView:o,flyCallbacks:l}=t;this.id=i,this.type=s,this.geometry=n,this.direction=r,this.cameraInfo=a.cameraInfo,q(a.liveviewSettingState)&&this.liveviewSetting.setState(a.liveviewSettingState),this.sceneView=o,this.flyCallbacks=l,this._isDebug=!1,this._isDebug&&(this.auxHelper=new dt({sceneView:this.sceneView})),this.DEBUG={planTime:0,startTime:0,endTime:0},this.eventHandlers.push(this.sceneView.on("drag",(t=>{this.flyState<=ft.RUNNING&&"start"===t.action&&this.pause()}))),this.eventHandlers.push(this.sceneView.on("mouse-wheel",(t=>{this.flyState<=ft.RUNNING&&this.pause()})))})))),this}))}destructor(){this.onStop(),this.clear()}isInited(){return this.flyState>=ft.INITED}isEnableToFly(){const t=this.flyState;return t===ft.PREPARED||t===ft.STOPPED||t===ft.PREPARING}isEnableToPause(){return this.flyState>=ft.PREPARING}init(){this.flyState=ft.INITED,this.animate.reset()}preparing(){var t;return wt(this,void 0,void 0,(function*(){this.flyState=ft.PREPARING,"function"==typeof(null===(t=this.flyCallbacks)||void 0===t?void 0:t.onPreparing)&&this.flyCallbacks.onPreparing()}))}prepared(){return wt(this,void 0,void 0,(function*(){return this.flyState=ft.PREPARED,setTimeout((()=>{}),50)}))}_doFly(){this.isLiveviewMode||this.onStart()}setConfig(t){this.cameraInfo=t.cameraInfo,this.liveviewSetting.setState(t.liveviewSettingState)}getConfig(){return{cameraInfo:this.cameraInfo,liveviewSettingState:this.liveviewSetting.getState()}}pause(){return wt(this,void 0,void 0,(function*(){return!!this.isEnableToPause()&&(this.stopAnimat(),this.onPause(),!0)}))}resume(t){return wt(this,void 0,void 0,(function*(){}))}stop(){this.stopAnimat(),this.onStop()}clear(){var t,e,i,s;return wt(this,void 0,void 0,(function*(){q(this.eventHandlers)&&this.eventHandlers.forEach((t=>{t.remove()})),this.eventHandlers=null,this.eventHandlers=[],this.abortSignalHandler&&this.abortSignalHandler.abort(),this.abortSignalHandler=null,this.abortSignalHandler=new vt,this._isDebug&&(null===(t=this.auxHelper)||void 0===t||t.clearAll()),q(null===(e=this._cache)||void 0===e?void 0:e.paths)&&(null===(i=this._cache)||void 0===i||i.paths.destructor()),this.id=null,this.type=null,this.geometry=null,this.direction=null,this.cameraInfo=null,this.sceneView=null,this.flyCallbacks=null,this.auxHelper=null,null===(s=this.animate)||void 0===s||s.stop(),this.animate=null,this.animate=yield(new gt).setup(),this.liveviewSetting=null,this.liveviewSetting=new mt,this.flyState=null,this.isLiveviewMode=!1,this.shownProgress=0,this._cache={paths:null,cachedGeo:null,cameraGL:{pos:null,upDir:null},lookAtTargetGL:{pos:null,upAxis:null,baseAlt:null}},this._isDebug=!1,this.DEBUG={planTime:null,startTime:null,endTime:null}}))}updateAnimat(t){return wt(this,void 0,void 0,(function*(){return yield this.animate.update((e=>{t(e)}))}))}stopAnimat(){this.animate.stop(),this.updateProgressBar()}setIsLiveview(t){return wt(this,void 0,void 0,(function*(){return this.isLiveviewMode=t,t?yield this.fly({animate:!1}):yield this.pause()}))}setLiveviewSettingInfo(t,e){return wt(this,void 0,void 0,(function*(){if(!q(t))return!1;let i=!1;const s=t.altitude;void 0!==s&&(i=!0,this.liveviewSetting.setAltitudeFactor(s));const n=t.tilt;return void 0!==n&&(i=!0,this.liveviewSetting.setTiltFactor(n)),i&&q(this.animate)&&this.isLiveviewMode&&this.animate.insertAnExtraFrame((t=>wt(this,void 0,void 0,(function*(){yield e(t)})))),!0}))}getDefaultDuration(){return this.flyState>=ft.PREPARED?this.animate.getDuration():null}onStart(){var t;this.flyState=ft.RUNNING,this._isDebug&&(this.DEBUG.planTime=this.animate.state.interp.time.duration,this.DEBUG.startTime=(new Date).getTime()),"function"==typeof(null===(t=this.flyCallbacks)||void 0===t?void 0:t.onFly)&&this.flyCallbacks.onFly()}onPause(){var t;this.abortSignalHandler.abort(),this.flyState=ft.STOPPED,"function"==typeof(null===(t=this.flyCallbacks)||void 0===t?void 0:t.onPause)&&this.flyCallbacks.onPause()}onStop(){var t;if(this.abortSignalHandler.abort(),this.flyState=ft.STOPPED,this._isDebug){this.DEBUG.endTime=(new Date).getTime();const t=(this.DEBUG.endTime-this.DEBUG.startTime)/1e3,e=this.DEBUG.planTime/1e3;console.log("DEBUG 1.fly sum time ==> "+t.toFixed(2)+" s"),console.log("DEBUG 2.plan time ==> "+e.toFixed(2)+" s");const i=(t-e)/e*100;console.log("DEBUG 3.mistake ==> "+i.toFixed(5)+" %")}"function"==typeof(null===(t=this.flyCallbacks)||void 0===t?void 0:t.onFinish)&&this.flyCallbacks.onFinish()}updateProgressBar(){var t,e;if("function"==typeof(null===(t=this.flyCallbacks)||void 0===t?void 0:t.onUpdateProgress)){const t=Math.ceil(100*this.getProgress());let i=!1;(t<=1||t>=99||Math.abs(t-this.shownProgress)>=1)&&(i=!0),i&&(this.shownProgress=t),i&&(null===(e=this.flyCallbacks)||void 0===e||e.onUpdateProgress(this.shownProgress))}}concatGeoPaths(t){let e=[];for(let i=0;i<t.paths.length;i++)e=e.concat(t.paths[i]);return e}geoCoordToRenderCoord(t){const e=[];for(let i=0,s=t.length;i<s;i++){let s=t[i];s=j([s[0],s[1],s[2]],null,this.sceneView),e.push(s)}return e}}var St=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{l(s.next(t))}catch(t){r(t)}}function o(t){try{l(s.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((s=s.apply(t,e||[])).next())}))};class Ct extends Pt{constructor(){super(...arguments),this._updateCamearGlByTilt=(t,e)=>{if(!q(this._cache.lookAtTargetGL.pos))return null;t<1?t=1:t>89&&(t=89);const i=this.vec3d.create();this.vec3.subtract(i,this._cache.cameraGL.pos,this._cache.lookAtTargetGL.pos);const s=this.vec3.length(i),n=this.vec3d.create();this.vec3.normalize(n,this._cache.lookAtTargetGL.upAxis);const r=this.vec3d.create();this.vec3.scale(r,n,s);const a=this.vec3d.create();this.vec3.add(a,this._cache.lookAtTargetGL.pos,r);const o=this.vec3d.create();this.vec3.cross(o,n,i);let l=this.vec3d.create();l=this.rotateBySceneMode(a,o,t,this._cache.lookAtTargetGL.pos);const h=this.mat4d.create();this.mat4.rotate(h,h,k(t),o);const c=this.vec3d.create();this.vec3.subtract(c,l,this._cache.lookAtTargetGL.pos);const d=this.vec3d.create();if(this.vec3.cross(d,c,o),this.vec3.normalize(d,d),this._cache.cameraGL.pos=l,this._cache.cameraGL.upDir=d,null==e?void 0:e.isUpdateCamearConfig){const t=new this.GLCamera(this._cache.cameraGL.pos,this._cache.lookAtTargetGL.pos,this._cache.cameraGL.upDir);this.cameraInfo=this.cameraUtils.internalToExternal(this.sceneView,t),this.cameraInfo=this.cameraInfo.toJSON()}},this._computeCurrentTilt=()=>{const t=this.vec3d.create();this.vec3.subtract(t,this._cache.cameraGL.pos,this._cache.lookAtTargetGL.pos);const e=this.vec3d.create();return this.vec3.normalize(e,this._cache.lookAtTargetGL.upAxis),O(this.vec3.angle(t,e))},this._updateInitCamera=(t,e)=>{let i,s=t;this._isDebug&&this.auxHelper.drawPoint(s),s=this.queryGeometryElevInfo(s),this._cache.lookAtTargetGL.pos=j([s.x,s.y,s.z],null,this.sceneView),this._cache.lookAtTargetGL.upAxis=this.vec3d.create(),this._cache.lookAtTargetGL.baseAlt=s.z,this.sceneView.renderCoordsHelper.worldUpAtPosition(this._cache.lookAtTargetGL.pos,this._cache.lookAtTargetGL.upAxis),i=q(this.cameraInfo)?this.Camera.fromJSON(this.cameraInfo):this.sceneView.camera.clone();const n=this.cameraUtils.externalToInternal(this.sceneView,i);return this._cache.cameraGL.pos=n.eye,this._cache.cameraGL.upDir=n.up,(null==e?void 0:e.isUpdateTilt)&&this._updateCamearGlByTilt(this._getTilt()),s},this.fly=t=>St(this,void 0,void 0,(function*(){return q(null==t?void 0:t.speedFactor)&&this.liveviewSetting.setSpeedFactor(t.speedFactor),this.isInited()?this.isEnableToFly()?yield this.resume(null==t?void 0:t.animate):yield Promise.reject("isEnableToFly() === false"):(yield this.prepare(),yield this.resume(),!0)})),this.getApiCamera=()=>{const t=new this.GLCamera(this._cache.cameraGL.pos,this._cache.lookAtTargetGL.pos,this._cache.cameraGL.upDir),e=this.cameraUtils.internalToExternal(this.sceneView,t);return e.position.z<0&&(e.position.z=0),e},this.resumeCamera=t=>St(this,void 0,void 0,(function*(){const e=t;try{yield this.sceneView.goTo(this.getApiCamera(),{animate:e,signal:this.abortSignalHandler.update()})}catch(t){return"AbortError"===t.name&&(console.log("sceneView.goTo() Aborted"),!1)}return!0})),this.getProgress=()=>0}setIsLiveview(t){const e=Object.create(null,{setIsLiveview:{get:()=>super.setIsLiveview}});return St(this,void 0,void 0,(function*(){return yield e.setIsLiveview.call(this,t),yield this.setLiveviewSettingInfo(this.getLiveviewSettingInfo())}))}setLiveviewSettingInfo(t){const e=Object.create(null,{setLiveviewSettingInfo:{get:()=>super.setLiveviewSettingInfo}});return St(this,void 0,void 0,(function*(){return yield e.setLiveviewSettingInfo.call(this,t,(()=>St(this,void 0,void 0,(function*(){if(q(t)&&q(t.tilt)&&q(this._cache.lookAtTargetGL.pos)&&t.tilt>=0){this._updateCamearGlByTilt(t.tilt,{isUpdateCamearConfig:!0});try{yield this.sceneView.goTo(this.getApiCamera(),{animate:!1,signal:this.abortSignalHandler.update()})}catch(t){return"AbortError"===t.name&&(console.log("sceneView.goTo() Aborted"),!1)}return!0}return!1}))))}))}_getTilt(){let t=this.liveviewSetting.getTiltFactor(!0);return(null==t||isNaN(t))&&(t=this._computeCurrentTilt(),this.liveviewSetting.setTiltFactor(t)),t}getLiveviewSettingInfo(){return{tilt:this._getTilt(),altitude:null,speed:this.liveviewSetting.getSpeedFactor()}}prepare(t){const e=Object.create(null,{preparing:{get:()=>super.preparing},prepared:{get:()=>super.prepared}});var i;return St(this,void 0,void 0,(function*(){const s=this.geometry;q(t)&&(q(t.angleLimit)?(this.optionsAngleLimit=t.angleLimit,this.angleLimitCounter=t.angleLimit):q(this.optionsAngleLimit),q(t.duration)&&(this.duration=t.duration)),e.preparing.call(this),this._updateInitCamera(s,{isUpdateTilt:!1}),q(this.duration)?this.animate.init(ut.Linear,0,null!==(i=this.optionsAngleLimit)&&void 0!==i?i:360,this.duration):this.animate.init(ut.NONE,0,0,this.duration);try{yield this.sceneView.goTo(this.getApiCamera(),this.getPrepareGoToOptionsBeforeTerrainLoaded(t))}catch(t){return"AbortError"===t.name&&console.log("sceneView.goTo() Aborted"),!1}if(null==t?void 0:t.waittingForTerrain){yield this.watchUtils.whenFalseOnce(this.sceneView.groundView,"updating"),this._updateInitCamera(this.geometry,{isUpdateTilt:!0});try{yield this.sceneView.goTo(this.getApiCamera(),this.getPrepareGoToOptionsAfterTerrainLoaded(t))}catch(t){return"AbortError"===t.name&&console.log("sceneView.goTo() Aborted"),!1}yield this.watchUtils.whenFalseOnce(this.sceneView.groundView,"updating")}return yield e.prepared.call(this),!0}))}_doFly(){const t=Object.create(null,{_doFly:{get:()=>super._doFly}});return St(this,void 0,void 0,(function*(){return t._doFly.call(this),yield this.updateAnimat((t=>{const i=this.animate.easing(t.deltaTime,this.liveviewSetting.getMappingSpeedFactor());let s=i.step;const n=i.progress;if(q(this.direction)&&this.direction===e.CW&&(s=-s),this.isLiveviewMode);else if(null===this.optionsAngleLimit||isNaN(this.optionsAngleLimit))this._rotateCam(s);else{n>=1&&(s=this.angleLimitCounter);const t=Math.min(Math.abs(s),this.angleLimitCounter);this.angleLimitCounter-=t,this.angleLimitCounter>0?this._rotateCam(s):this.stop()}this._isDebug&&this.auxHelper.drawPointGL(this._cache.cameraGL.pos,"red");const r=this.getApiCamera();this.sceneView.goTo(r,{animate:!1}).catch((function(t){if("AbortError"!==t.name)throw t;console.log("sceneView.goTo() Aborted")}))}))}))}_rotateCam(t){const e=this._cache.lookAtTargetGL.upAxis;let i=this.vec3d.create();i=this.rotateBySceneMode(this._cache.cameraGL.pos,e,t,this._cache.lookAtTargetGL.pos),this._cache.cameraGL.pos=i;const s=this.mat4d.create();this.mat4.rotate(s,s,k(t),e);const n=this._cache.cameraGL.upDir;this.vec3.transformMat4(n,n,s),this.vec3.normalize(n,n),this._cache.cameraGL.upDir=n}resume(t){const e=Object.create(null,{resume:{get:()=>super.resume}});return St(this,void 0,void 0,(function*(){return e.resume.call(this),yield this._resume(this.resumeCamera(t))}))}clear(){const t=Object.create(null,{clear:{get:()=>super.clear}});return St(this,void 0,void 0,(function*(){yield t.clear.call(this),this._cache.lookAtTargetGL.pos=null}))}}class bt{constructor(t,e){this.points=null!=t?t:[],this.points=this.normalPoints4Bspline(this.points),this.iter=null!=e?e:3}getSpline(){const t=this.bspline(this.points,this.iter);return this.mergePoints(t)}clear(){this.points=null,this.iter=null}normalPoints4Bspline(t){var e;const i=[];for(let s=0,n=t.length;s<n;s++){const n=t[s],r=n[0],a=n[1],o=null!==(e=n[2])&&void 0!==e?e:0;i.push(r,a,o)}return i}mergePoints(t){const e=[];for(let i=0,s=t.length/3;i<s;i++){const s=t[3*i],n=t[3*i+1],r=t[3*i+2],a=[];a.push(s,n,r),e.push(a)}return e}bspline(t,e){if(!q(e)||0===e)return t;const i=t.length/3,s=[t[0],t[1],t[2]],n=.2,r=.8;for(let e=0;e<i-1;e++){const i=3*e;s[3+2*i+0]=r*t[i+0]+n*t[i+3],s[3+2*i+1]=r*t[i+1]+n*t[i+4],s[3+2*i+2]=r*t[i+2]+n*t[i+5],s[3+2*i+3]=n*t[i+0]+r*t[i+3],s[3+2*i+4]=n*t[i+1]+r*t[i+4],s[3+2*i+5]=n*t[i+2]+r*t[i+5]}return s.push(t[t.length-3],t[t.length-2],t[t.length-1]),this.bspline(s,e-1)}}function Mt(t,e,i){const s=void 0!==e?e*e:1;return t=i?t:function(t,e){let i=t[0];const s=[i];let n;for(let r=1,a=t.length;r<a;r++)n=t[r],It(n,i)>e&&(s.push(n),i=n);return i!==n&&s.push(n),s}(t,s),t=function(t,e){const i=t.length,s=new("undefined"!=typeof Uint8Array?Uint8Array:Array)(i);let n=0,r=i-1;const a=[],o=[];let l,h,c,d;for(s[n]=s[r]=1;q(r)&&0!==r;){for(h=0,l=n+1;l<r;l++)c=xt(t[l],t[n],t[r]),c>h&&(d=l,h=c);h>e&&(s[d]=1,a.push(n,d,d,r)),r=a.pop(),n=a.pop()}for(l=0;l<i;l++)q(s[l])&&o.push(t[l]);return o}(t,s),t}function It(t,e){const i=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2];return i*i+s*s+n*n}function xt(t,e,i){let s=e[0],n=e[1],r=e[2],a=i[0]-s,o=i[1]-n,l=i[2]-r;if(0!==a||0!==o||0!==l){const e=((t[0]-s)*a+(t[1]-n)*o+(t[2]-r)*l)/(a*a+o*o+l*l);e>1?(s=i[0],n=i[1],r=i[2]):e>0&&(s+=a*e,n+=o*e,r+=l*e)}return a=t[0]-s,o=t[1]-n,l=t[2]-r,a*a+o*o+l*l}class Gt{constructor(){this.c0=0,this.c1=0,this.c2=0,this.c3=0,this.init=(t,e,i,s)=>{this.c0=t,this.c1=i,this.c2=-3*t+3*e-2*i-s,this.c3=2*t-2*e+i+s},this.initCatmullRom=(t,e,i,s,n)=>{this.init(e,i,n*(i-t),n*(s-e))},this.initNonuniformCatmullRom=(t,e,i,s,n,r,a)=>{let o=(e-t)/n-(i-t)/(n+r)+(i-e)/r,l=(i-e)/r-(s-e)/(r+a)+(s-i)/a;o*=r,l*=r,this.init(e,i,o,l)},this.calc=t=>{const e=t*t,i=e*t;return this.c0+this.c1*t+this.c2*e+this.c3*i}}}class Lt{constructor(t,e,i){this.set=(t,e,i)=>(this.x=t,this.y=e,this.z=i,this),this.add=t=>(this.x+=t.x,this.y+=t.y,this.z+=t.z,this),this.subVectors=(t,e)=>(this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this),this.distanceToSquared=t=>{const e=this.x-t.x,i=this.y-t.y,s=this.z-t.z;return e*e+i*i+s*s},this.distanceTo=t=>Math.sqrt(this.distanceToSquared(t)),this.x=null!=t?t:0,this.y=null!=e?e:0,this.z=null!=i?i:0}}const At=new Lt,Rt=new Gt,Tt=new Gt,jt=new Gt;class Dt{constructor(t,e,i,s){this._geoArrayToCoords=t=>{const e=[];for(let i=0,s=t.length;i<s;i++)e.push(new Lt(t[i][0],t[i][1],t[i][2]));return e},this.getPoint=(t,e)=>{const i=null!=e?e:new Lt,s=this.points,n=s.length,r=(n-(!0===this.closed?0:1))*t;let a,o=Math.floor(r),l=r-o;!0===this.closed?o+=o>0?0:(Math.floor(Math.abs(o)/n)+1)*n:0===l&&o===n-1&&(o=n-2,l=1),!0===this.closed||o>0?a=s[(o-1)%n]:(At.subVectors(s[0],s[1]).add(s[0]),a=At);const h=s[o%n],c=s[(o+1)%n];let d;if(!0===this.closed||o+2<n?d=s[(o+2)%n]:(At.subVectors(s[n-1],s[n-2]).add(s[n-1]),d=At),"centripetal"===this.curveType||"chordal"===this.curveType){const t="chordal"===this.curveType?.5:.25;let e=Math.pow(a.distanceToSquared(h),t),i=Math.pow(h.distanceToSquared(c),t),s=Math.pow(c.distanceToSquared(d),t);i<1e-4&&(i=1),e<1e-4&&(e=i),s<1e-4&&(s=i),Rt.initNonuniformCatmullRom(a.x,h.x,c.x,d.x,e,i,s),Tt.initNonuniformCatmullRom(a.y,h.y,c.y,d.y,e,i,s),jt.initNonuniformCatmullRom(a.z,h.z,c.z,d.z,e,i,s)}else"catmullrom"===this.curveType&&(Rt.initCatmullRom(a.x,h.x,c.x,d.x,this.tension),Tt.initCatmullRom(a.y,h.y,c.y,d.y,this.tension),jt.initCatmullRom(a.z,h.z,c.z,d.z,this.tension));return i.set(Rt.calc(l),Tt.calc(l),jt.calc(l)),i},this.getSpacedPoints=t=>{void 0===t&&(t=5);const e=[];for(let i=0;i<=t;i++)e.push(this.getPointAt(i/t));return e},this.getPointAt=(t,e)=>{const i=this.getUtoTmapping(t);return this.getPoint(i,e)},this.getUtoTmapping=(t,e)=>{const i=this.getLengths();let s=0;const n=i.length;let r;r=q(e)?e:t*i[n-1];let a,o=0,l=n-1;for(;o<=l;)if(s=Math.floor(o+(l-o)/2),a=i[s]-r,a<0)o=s+1;else{if(!(a>0)){l=s;break}l=s-1}if(s=l,i[s]===r)return s/(n-1);const h=i[s];return(s+(r-h)/(i[s+1]-h))/(n-1)},this.getLength=()=>{const t=this.getLengths();return t[t.length-1]},this.getLengths=t=>{if(void 0===t&&(t=this.arcLengthDivisions),q(this.cacheArcLengths)&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const e=[];let i,s,n=this.getPoint(0),r=0;for(e.push(0),s=1;s<=t;s++)i=this.getPoint(s/t),r+=i.distanceTo(n),e.push(r),n=i;return this.cacheArcLengths=e,e},this.points=this._geoArrayToCoords(t),this.closed=null!=e&&e,this.curveType=null!=i?i:"centripetal",this.tension=null!=s?s:.3,this.arcLengthDivisions=2e4}destructor(){}}class kt{constructor(t,e,i,s,n){this.longLineProcessing={threshold:400,distance:150},this.acuteAngleProcessing={angle:90,threshold:300,distance:100},this.geoArrayToCoords=t=>{const e=[];for(let i=0,s=t.length;i<s;i++){let s=t[i];s=j([s[0],s[1],s[2]],null,this.sceneView),e.push(s)}return e},this.getLength=()=>this.curve.getLength(),this.sceneView=e,this.points=this.geoArrayToCoords(t),this.vec3=i,this.vec3d=s,this.esriMathUtils=n;const r=Mt(this.points,5,!0);this.points=this.preProcessing(r);const a=new bt(this.points);this.curve=new Dt(a.getSpline()),a.clear()}destructor(){this.points=null,this.curve=null}getUtoTmapping(t,e){return this.curve.getUtoTmapping(0,e)}getPoint(t){return this.curve.getPoint(t)}preProcessing(t){const e=[];let i=null;for(let s=0;s<t.length-1;s++){const n=t[s],r=t[s+1],a=t[s+2],o=V(n,r),l=q(a)?V(r,a):null;let h=!1;if(q(o)&&q(l)){const t=N(n,r,a,this.vec3,this.vec3d,this.sceneView,this.esriMathUtils);h=Math.abs(t)>this.acuteAngleProcessing.angle}const c=!(0!==s),d=!(t.length-1!==s+1);let u;if(e.push(n),q(i)&&!c&&(e.push(i),i=null),u=this._getInsertControlPointRes(o,h),!0===u.isInsert&&!c&&!d){const t=this._getInsertedPoint(n,r,"forward",u.distance);e.push(t)}u=this._getInsertControlPointRes(l,h),!0!==u.isInsert||d||(i=this._getInsertedPoint(r,a,"backward",u.distance)),d&&e.push(r)}for(let t=0,i=e.length;t<i;t++){let i=e[t];i=D(i,null,this.sceneView),e.splice(t,1,i)}return e}_getInsertControlPointRes(t,e){const i=t>this.acuteAngleProcessing.threshold,s=null!==t&&t>this.longLineProcessing.threshold;return e&&i?{isInsert:!0,distance:this.acuteAngleProcessing.distance}:s?{isInsert:!0,distance:this.longLineProcessing.distance}:{isInsert:!1,distance:0}}_getInsertedPoint(t,e,i,s){const n=this.vec3d.create(),r=this.vec3d.create(),a=this.vec3d.create(),o=this.vec3d.create();return"forward"===i?(this.vec3.subtract(n,t,e),this.vec3.normalize(r,n),this.vec3.scale(a,r,s),this.vec3.add(o,e,a)):(this.vec3.subtract(n,e,t),this.vec3.normalize(r,n),this.vec3.scale(a,r,s),this.vec3.add(o,t,a)),o}_getMidpoint(t,e,i){const s=this.vec3d.create(),n=this.vec3d.create(),r=this.vec3d.create(),a=this.vec3d.create(),o=q(i)?i:V(t,e);return this.vec3.subtract(s,t,e),this.vec3.normalize(n,s),this.vec3.scale(r,n,o/2),this.vec3.add(a,e,r),a}}var Ot=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{l(s.next(t))}catch(t){r(t)}}function o(t){try{l(s.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((s=s.apply(t,e||[])).next())}))};class Vt extends Pt{constructor(){super(...arguments),this._updateInitCamera=t=>{t=this.queryGeometryElevInfo(t),this._cache.cachedGeo=this.concatGeoPaths(t),this._cache.paths=new kt(this._cache.cachedGeo,this.sceneView,this.vec3,this.vec3d,this.esriMathUtils);const e=this._cache.paths.getLength();return this.animate.setAmount(e),t},this.getProgress=()=>this.animate.getProgress(),this.getCameraByProgress=()=>{let t,e;0===this.animate.getProgress()?(t=0*this.animate.getAmount(),this.animate.progressForward(),e=this.animate.getAmount()*this.animate.getProgress()):(t=this.animate.getAmount()*this.animate.progressBackward(),t<0&&(t=0,this.animate.progressForward()),e=this.animate.getAmount()*this.animate.getProgress());let i=this._cache.paths.getUtoTmapping(0,t);i=this._cache.paths.getPoint(i),i=this._coordToGeo(i);let s=this._cache.paths.getUtoTmapping(0,e);s=this._cache.paths.getPoint(s),s=this._coordToGeo(s);const n=parseFloat(i[2])+0,r=j([i[0],i[1],n],null,this.sceneView);let a=this.getCameraPosition(i,s);q(a)||(a=this._cache.cameraGL.pos);const o=this.vec3d.create();this.sceneView.renderCoordsHelper.worldUpAtPosition(a,o);const l=[0,0,0];l[0]=a[0],l[1]=a[1],l[2]=a[2];const h=[0,0,0];return h[0]=r[0],h[1]=r[1],h[2]=r[2],this._cache.cameraGL.pos=l,this._cache.cameraGL.upDir=o,this._cache.lookAtTargetGL.pos=h,this._cache.lookAtTargetGL.upAxis=null,this._cache.lookAtTargetGL.baseAlt=null,{lookAt:h,camPos:l,up:o}},this.getApiCamera=t=>{let e=t.camPos,i=t.lookAt;const s=t.up;if(!q(e)||!q(i)||!q(s))return null;let n=0,r=D(i,1,this.sceneView),a=new this.Point({x:r[0],y:r[1],z:r[2],type:"point",spatialReference:this.sceneView.spatialReference});n=a.z,a.z=parseFloat(a.z)+this.liveviewSetting.getAltitudeFactor(),a.z<0&&(a.z=0),i=j([a.x,a.y,a.z],null,this.sceneView),r=D(e,1,this.sceneView),a=new this.Point({x:r[0],y:r[1],z:r[2],type:"point",spatialReference:this.sceneView.spatialReference}),a.z=n+this.liveviewSetting.getAltitudeFactor()+this.liveviewSetting.getCamOffsetHeight(),e=j([a.x,a.y,a.z],null,this.sceneView);const o=new this.GLCamera(e,i,s);return this.cameraUtils.internalToExternal(this.sceneView,o)},this.getCameraPosition=(t,e)=>{var i,s;if(t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return null;const n=null!==(i=this.liveviewSetting.getCamOffsetHeight())&&void 0!==i?i:100,r=null!==(s=this.liveviewSetting.getCamOffsetDistance())&&void 0!==s?s:100,a=j([t[0],t[1],t[2]],null,this.sceneView),o=j([e[0],e[1],e[2]],null,this.sceneView),l=this.vec3d.create();this.vec3.subtract(l,a,o);const h=this.vec3.length(l),c=this.vec3d.create();this.vec3.normalize(c,l);const d=h+r,u=this.vec3d.create();this.vec3.scale(u,c,d);const p=this.vec3d.create();this.vec3.add(p,o,u);const g=D(p,1,this.sceneView),v=new this.Point({x:g[0],y:g[1],z:g[2],type:"point",spatialReference:this.sceneView.spatialReference});return v.z<n&&(v.z=n),v.z<0&&(v.z=0),this._isDebug&&this.auxHelper.drawPoint(v),j([v.x,v.y,v.z],null,this.sceneView)},this.resumeCamera=t=>Ot(this,void 0,void 0,(function*(){const e=t;try{yield this.sceneView.goTo(this.getApiCamera(this.getCameraByProgress()),{animate:e,signal:this.abortSignalHandler.update()})}catch(t){return"AbortError"===t.name&&(console.log("sceneView.goTo() Aborted"),!1)}return!0})),this._coordToGeo=t=>q(t)?this.vec3d.fromValues(t.x,t.y,t.z):null}setLiveviewSettingInfo(t){const e=Object.create(null,{setLiveviewSettingInfo:{get:()=>super.setLiveviewSettingInfo}});return Ot(this,void 0,void 0,(function*(){return yield e.setLiveviewSettingInfo.call(this,t,(()=>Ot(this,void 0,void 0,(function*(){const t=this.getApiCamera(this.getCameraByProgress());try{yield this.sceneView.goTo(t,{animate:!1,signal:this.abortSignalHandler.update()})}catch(t){return"AbortError"===t.name&&(console.log("sceneView.goTo() Aborted"),!1)}return!0}))))}))}getLiveviewSettingInfo(){return{tilt:null,altitude:this.liveviewSetting.getAltitudeFactor(),speed:this.liveviewSetting.getSpeedFactor()}}prepare(t){const e=Object.create(null,{preparing:{get:()=>super.preparing},prepared:{get:()=>super.prepared}});var i;return Ot(this,void 0,void 0,(function*(){let s=this.geometry;if("polyline"!==(null==s?void 0:s.type))return alert("Wrong geo type!"),!1;if(q(null==t?void 0:t.duration)&&(this.duration=t.duration),e.preparing.call(this),s=this._updateInitCamera(s),!this.isLiveviewMode){const t=this.animate.computeDuration();this.animate.init(ut.Linear,0,this.animate.getAmount(),null!==(i=this.duration)&&void 0!==i?i:t)}this._isDebug&&this.auxHelper.drawLineXY(this._cache.paths,"lightgreen");try{yield this.sceneView.goTo(this.getApiCamera(this.getCameraByProgress()),this.getPrepareGoToOptionsBeforeTerrainLoaded(t))}catch(t){return"AbortError"===t.name&&console.log("sceneView.goTo() Aborted"),!1}if(null==t?void 0:t.waittingForTerrain){yield this.watchUtils.whenFalseOnce(this.sceneView.groundView,"updating"),s=this._updateInitCamera(s);try{yield this.sceneView.goTo(this.getApiCamera(this.getCameraByProgress()),this.getPrepareGoToOptionsAfterTerrainLoaded(t))}catch(t){return"AbortError"===t.name&&console.log("sceneView.goTo() Aborted"),!1}yield this.watchUtils.whenFalseOnce(this.sceneView.groundView,"updating")}return yield e.prepared.call(this),!0}))}fly(t){const e=Object.create(null,{isEnableToFly:{get:()=>super.isEnableToFly}});return Ot(this,void 0,void 0,(function*(){return q(null==t?void 0:t.speedFactor)&&this.liveviewSetting.setSpeedFactor(t.speedFactor),e.isEnableToFly.call(this)?yield this.resume(t.animate):yield Promise.reject()}))}_doFly(){super._doFly(),this.updateAnimat((t=>{if(this.isLiveviewMode||this.animate.easing(t.deltaTime,this.liveviewSetting.getMappingSpeedFactor()),this.updateProgressBar(),this.getProgress()>=1)this.animate.reset(),this.stop();else{const t=this.getCameraByProgress(),e=this.getApiCamera(t);q(e)&&this.sceneView.goTo(e,{animate:!1})}}))}resume(t){const e=Object.create(null,{resume:{get:()=>super.resume}});return Ot(this,void 0,void 0,(function*(){return e.resume.call(this),yield this._resume(this.resumeCamera(t))}))}clear(){const t=Object.create(null,{clear:{get:()=>super.clear}});return Ot(this,void 0,void 0,(function*(){yield t.clear.call(this)}))}}class Ft{constructor(t,e,i,s,n){this.geoArrayToCoords=t=>{const e=[];for(let i=0,s=t.length;i<s;i++){let s=t[i];s=j([s[0],s[1],s[2]],null,this.sceneView),e.push(s)}return e},this.getLength=()=>{this.points.length<2&&alert("line.length < 2");let t=0;for(let e=0,i=this.points.length;e<i-1;e++)t+=this.getLineLen(this.points[e+0],this.points[e+1]),t+=Math.abs(N(this.points[e+0],this.points[e+1],this.points[e+2],this.vec3,this.vec3d,this.sceneView,this.esriMathUtils));return this.length=t,t},this.sceneView=e,this.points=this.geoArrayToCoords(t),this.vec3=i,this.vec3d=s,this.esriMathUtils=n,this.points=Mt(this.points,5,!0)}destructor(){this.points=null}getLineLen(t,e){return V(t,e)}getPoint(t,e){let i=0;for(let t=0,n=this.points.length;t<n-1;t++){const n=this.points[t+0],r=this.points[t+1],a=this.points[t+2],o=this.getLineLen(n,r);if(e<i+o){const t=e-i;return{type:"line",len:t,point:F(n,r,t/o)}}i+=o;const l=N(n,r,a,this.vec3,this.vec3d,this.sceneView,this.esriMathUtils),h=Math.abs(l);if(e<i+h)return{type:"rotate",angle:(e-i)*((s=l)<0?-1:s>0?1:0),point:r,points:{pre:n,base:r,next:a},lastLineLen:i};i+=h}var s}}var Nt=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{l(s.next(t))}catch(t){r(t)}}function o(t){try{l(s.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((s=s.apply(t,e||[])).next())}))};class _t extends Pt{constructor(){super(...arguments),this._updateInitCamera=t=>{t=this.queryGeometryElevInfo(t),this._cache.cachedGeo=this.concatGeoPaths(t),this._cache.paths=new Ft(this._cache.cachedGeo,this.sceneView,this.vec3,this.vec3d,this.esriMathUtils);const e=this._cache.paths.getLength();return this.animate.setAmount(e),t},this.getProgress=()=>this.animate.getProgress(),this.getCameraByProgress=t=>{let e,i;0===this.animate.getProgress()?(e=0*this.animate.getAmount(),this.animate.progressForward(),i=this.animate.getAmount()*this.animate.getProgress()):(e=this.animate.getAmount()*this.animate.progressBackward(),i=this.animate.getAmount()*this.animate.getProgress());const s=this._cache.paths.getPoint(0,e),n=this._cache.paths.getPoint(0,i),r=[0,0,0],a=[0,0,0],o=this.vec3d.create();if("line"===s.type){const t=s.point,e=n.point,i=t;let l=this.getCameraPosition(t,e);q(l)||(l=this._cache.cameraGL.pos),this.sceneView.renderCoordsHelper.worldUpAtPosition(l,o),r[0]=l[0],r[1]=l[1],r[2]=l[2],a[0]=i[0],a[1]=i[1],a[2]=i[2]}else if("rotate"===s.type){const t=s.points.pre,e=s.points.base,i=s.points.next,n=this.vec3d.create();this.vec3.subtract(n,e,t);const l=this.vec3d.create();this.vec3.subtract(l,i,e);const h=s.lastLineLen,c=this._cache.paths.getPoint(0,h-.02),d=this._cache.paths.getPoint(0,h-.01);let u=this.getCameraPosition(c.point,d.point);this.sceneView.renderCoordsHelper.worldUpAtPosition(e,o);const p=s.angle;u=this.rotateBySceneMode(u,o,p,e),r[0]=u[0],r[1]=u[1],r[2]=u[2],a[0]=e[0],a[1]=e[1],a[2]=e[2]}return this._cache.cameraGL.pos=r,this._cache.cameraGL.upDir=o,this._cache.lookAtTargetGL.pos=a,this._cache.lookAtTargetGL.upAxis=null,this._cache.lookAtTargetGL.baseAlt=null,{lookAt:a,camPos:r,up:o,type:s.type}},this.getApiCamera=t=>{let e=t.camPos,i=t.lookAt;const s=t.up;if(!q(e)||!q(i)||!q(s))return null;let n=0,r=D(i,1,this.sceneView),a=new this.Point({x:r[0],y:r[1],z:r[2],type:"point",spatialReference:this.sceneView.spatialReference});n=a.z,a.z=parseFloat(a.z)+this.liveviewSetting.getAltitudeFactor(),a.z<0&&(a.z=0),i=j([a.x,a.y,a.z],null,this.sceneView),r=D(e,1,this.sceneView),a=new this.Point({x:r[0],y:r[1],z:r[2],type:"point",spatialReference:this.sceneView.spatialReference}),a.z=n+this.liveviewSetting.getAltitudeFactor()+this.liveviewSetting.getCamOffsetHeight(),e=j([a.x,a.y,a.z],null,this.sceneView),this._isDebug&&this.auxHelper.drawLineGL([e,i],this.sceneView,"yellow");const o=new this.GLCamera(e,i,s);return this.cameraUtils.internalToExternal(this.sceneView,o)},this.resumeCamera=t=>Nt(this,void 0,void 0,(function*(){const e=t;try{yield this.sceneView.goTo(this.getApiCamera(this.getCameraByProgress()),{animate:e,signal:this.abortSignalHandler.update()})}catch(t){return"AbortError"===t.name&&(console.log("sceneView.goTo() Aborted"),!1)}return!0}))}setLiveviewSettingInfo(t){const e=Object.create(null,{setLiveviewSettingInfo:{get:()=>super.setLiveviewSettingInfo}});return Nt(this,void 0,void 0,(function*(){return yield e.setLiveviewSettingInfo.call(this,t,(()=>Nt(this,void 0,void 0,(function*(){const t=this.getApiCamera(this.getCameraByProgress());try{yield this.sceneView.goTo(t,{animate:!1,signal:this.abortSignalHandler.update()})}catch(t){return"AbortError"===t.name&&(console.log("sceneView.goTo() Aborted"),!1)}return!0}))))}))}getLiveviewSettingInfo(){return{tilt:null,altitude:this.liveviewSetting.getAltitudeFactor(),speed:this.liveviewSetting.getSpeedFactor()}}prepare(t){const e=Object.create(null,{preparing:{get:()=>super.preparing},prepared:{get:()=>super.prepared}});var i;return Nt(this,void 0,void 0,(function*(){let s=this.geometry;if("polyline"!==(null==s?void 0:s.type))return alert("Wrong geo type!"),!1;if(q(null==t?void 0:t.duration)&&(this.duration=t.duration),e.preparing.call(this),s=this._updateInitCamera(s),!this.isLiveviewMode){const t=this.animate.computeDuration();this.animate.init(ut.Linear,0,this.animate.getAmount(),null!==(i=this.duration)&&void 0!==i?i:t)}try{yield this.sceneView.goTo(this.getApiCamera(this.getCameraByProgress()),this.getPrepareGoToOptionsBeforeTerrainLoaded(t))}catch(t){return"AbortError"===t.name&&console.log("sceneView.goTo() Aborted"),!1}if(null==t?void 0:t.waittingForTerrain){yield this.watchUtils.whenFalseOnce(this.sceneView.groundView,"updating"),s=this._updateInitCamera(s);try{yield this.sceneView.goTo(this.getApiCamera(this.getCameraByProgress()),this.getPrepareGoToOptionsAfterTerrainLoaded(t))}catch(t){return"AbortError"===t.name&&console.log("sceneView.goTo() Aborted"),!1}yield this.watchUtils.whenFalseOnce(this.sceneView.groundView,"updating")}return yield e.prepared.call(this),!0}))}fly(t){const e=Object.create(null,{isEnableToFly:{get:()=>super.isEnableToFly}});return Nt(this,void 0,void 0,(function*(){return q(null==t?void 0:t.speedFactor)&&this.liveviewSetting.setSpeedFactor(t.speedFactor),e.isEnableToFly.call(this)?yield this.resume(t.animate):yield Promise.reject()}))}_doFly(){const t=Object.create(null,{_doFly:{get:()=>super._doFly}});return Nt(this,void 0,void 0,(function*(){return t._doFly.call(this),yield this.updateAnimat((t=>{if(this.isLiveviewMode||this.animate.easing(t.deltaTime,this.liveviewSetting.getMappingSpeedFactor()),this.updateProgressBar(),this.animate.getProgress()>=1)this.animate.reset(),this.stop();else{const t=this.getCameraByProgress(),e=this.getApiCamera(t);q(e)&&this.sceneView.goTo(e,{animate:!1})}}))}))}getCameraPosition(t,e){var i,s;if(t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return null;const n=null!==(i=this.liveviewSetting.getCamOffsetHeight())&&void 0!==i?i:100,r=null!==(s=this.liveviewSetting.getCamOffsetDistance())&&void 0!==s?s:100,a=t,o=e,l=this.vec3d.create();this.vec3.subtract(l,a,o);const h=this.vec3.length(l),c=this.vec3d.create();this.vec3.normalize(c,l);const d=h+r,u=this.vec3d.create();this.vec3.scale(u,c,d);const p=this.vec3d.create();this.vec3.add(p,o,u);const g=D(p,1,this.sceneView),v=new this.Point({x:g[0],y:g[1],z:g[2],type:"point",spatialReference:this.sceneView.spatialReference});return v.z<n&&(v.z=n),v.z<0&&(v.z=0),this._isDebug&&this.auxHelper.drawPoint(v,"red"),j([v.x,v.y,v.z],null,this.sceneView)}resume(t){const e=Object.create(null,{resume:{get:()=>super.resume}});return Nt(this,void 0,void 0,(function*(){return e.resume.call(this),yield this._resume(this.resumeCamera(t))}))}clear(){const t=Object.create(null,{clear:{get:()=>super.clear}});return Nt(this,void 0,void 0,(function*(){yield t.clear.call(this)}))}}var Ut,Et=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{l(s.next(t))}catch(t){r(t)}}function o(t){try{l(s.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((s=s.apply(t,e||[])).next())}))};!function(t){t.RawData="rawData",t.DsInfo="dsInfo"}(Ut||(Ut={}));class Ht{constructor(){this.Geometry=null,this.Graphic=null}setup(t,e,i){return Et(this,void 0,void 0,(function*(){return yield(0,h.loadArcGISJSAPIModules)(["esri/geometry","esri/Graphic"]).then((s=>Et(this,void 0,void 0,(function*(){var n,r,a;[this.Geometry,this.Graphic]=s,this.recordConfig=t,this.sceneView=e,this.flyCallbacks=i,this.controller=null;const o=this.recordConfig.type;switch(o){case yt.Rotate:case yt.RealPath:case yt.Smoothed:{let s;if((null===(n=t.storedGraphicsInfo)||void 0===n?void 0:n.type)===Ut.RawData){const e=t.storedGraphicsInfo.rawData.graphics;s=this.Graphic.fromJSON(e[0]).geometry}const o={id:t.idx,type:t.type,geometry:s,direction:t.direction,config:{cameraInfo:null===(r=t.controllerConfig)||void 0===r?void 0:r.cameraInfo,liveviewSettingState:null===(a=t.controllerConfig)||void 0===a?void 0:a.liveviewSettingState},sceneView:e,flyCallbacks:i};this.controller=yield class{static make(t){return e=this,i=void 0,n=function*(){let e;const i=t.type;switch(i){case yt.Rotate:e=yield(new Ct).setup(t);break;case yt.RealPath:e=yield(new _t).setup(t);break;case yt.Smoothed:e=yield(new Vt).setup(t);break;default:console.error("ControllerFactory error type:",i)}return e},new((s=void 0)||(s=Promise))((function(t,r){function a(t){try{l(n.next(t))}catch(t){r(t)}}function o(t){try{l(n.throw(t))}catch(t){r(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(a,o)}l((n=n.apply(e,i||[])).next())}));var e,i,s,n}}.make(o);break}default:console.error("error type: ",o)}})))),this}))}destructor(){var t;null===(t=this.controller)||void 0===t||t.destructor(),this.controller=null,this.recordConfig=null}getConfig(){var t;return this.recordConfig.controllerConfig=this.controller.getConfig(),(isNaN(this.recordConfig.duration)||this.recordConfig.duration<0)&&(null===(t=this.controller)||void 0===t?void 0:t.animate.state.amount)>=0&&(this.recordConfig.duration=this.controller.animate.getDuration()/1e3),this.cachingGraphicsInfo&&(this.recordConfig.storedGraphicsInfo.rawData=this.cachingGraphicsInfo.getConfig()),this.recordConfig}prepare(t){var e;return Et(this,void 0,void 0,(function*(){return q(t)&&!q(t.animate)&&Object.assign(t,{animate:!0}),yield null===(e=this.controller)||void 0===e?void 0:e.prepare(t)}))}fly(t){var e;return Et(this,void 0,void 0,(function*(){q(t.animate)||Object.assign(t,{animate:!0}),yield null===(e=this.controller)||void 0===e?void 0:e.fly(t)}))}pause(){var t;return Et(this,void 0,void 0,(function*(){return yield null===(t=this.controller)||void 0===t?void 0:t.pause()}))}stop(){var t;return Et(this,void 0,void 0,(function*(){yield null===(t=this.controller)||void 0===t?void 0:t.stop()}))}setGraphicsInfo(t){this.cachingGraphicsInfo=t}getGraphicsInfo(){return this.cachingGraphicsInfo}setSpeedFactor(t){var e;return null===(e=this.controller)||void 0===e?void 0:e.liveviewSetting.setSpeedFactor(t)}setIsLiveview(t){return Et(this,void 0,void 0,(function*(){return yield this.controller.setIsLiveview(t)}))}setLiveviewSettingInfo(t){return Et(this,void 0,void 0,(function*(){return yield this.controller.setLiveviewSettingInfo(t)}))}getLiveviewSettingInfo(){var t;return null===(t=this.controller)||void 0===t?void 0:t.getLiveviewSettingInfo()}getDefaultDuration(){return this.controller.getDefaultDuration()}}var Bt=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{l(s.next(t))}catch(t){r(t)}}function o(t){try{l(s.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((s=s.apply(t,e||[])).next())}))};class zt{constructor(){this._redrawAllRecordGraphics=t=>{const e=z(this.itemConfig.routes,t);null==e||e.records.forEach((t=>{t.mapViewId!==this.jimuMapView.id&&t.mapViewId!==$(this.jimuMapView.id)||this.drawOrUpdateGraphics(t)}))}}setup(e,i,s,n,r,a,o,l,h){var c;return Bt(this,void 0,void 0,(function*(){switch(this.type=e.name,this.itemConfig=e,this.flyStateCallbacks=n,this.jimuMapView=s,this.record=null!=h?h:null,this.recordConfig=null!==(c=null==h?void 0:h.getConfig())&&void 0!==c?c:i,this.drawOrUpdateGraphics=r,this.highlightGraphics=a,this.checkAndSwitchJimuMapBeforePlay=o,this.getCurrentSceneView=l,this.type){case t.Rotate:case t.Path:this.itemConfig=e;break;case t.Route:this.itemConfig=this.itemConfig;break;default:console.error("error type:",this.type)}return this._resetPlayingInfo(),this}))}destructor(){var t;this._resetPlayingInfo(),null===(t=this.record)||void 0===t||t.destructor()}handleUpdateJimuMapView(t){var e,i;this.jimuMapView=t,(null===(e=this.playingInfo.currentIds)||void 0===e?void 0:e.ids)&&this._redrawAllRecordGraphics(null===(i=this.playingInfo.currentIds)||void 0===i?void 0:i.ids)}handleUpdateFlyCallbacks(t){this.flyStateCallbacks=t}_getFlyRecordDynamically(t,e,i){return Bt(this,void 0,void 0,(function*(){this.itemConfig=this.itemConfig;const s=W(this.itemConfig.routes,t);return yield(new Ht).setup(s,e,i)}))}_getLimitionParamForPrepare(t,e){var i;const s={},n=t.getConfig().type,r=t.getConfig().duration;let a;if(n===yt.Rotate&&(a=t.getConfig().angle),q(r)&&!isNaN(r)&&r>0&&Object.assign(s,{duration:r*this._computeRouteTaskTimeScale()*1e3}),q(a)&&Object.assign(s,{angleLimit:a}),q(e)){Object.assign(s,{animate:e.animate});const t=null===(i=e.waittingForTerrain)||void 0===i||i;Object.assign(s,{waittingForTerrain:t})}return s}playSpecifiedRecord(){return Bt(this,void 0,void 0,(function*(){const t=this.drawOrUpdateGraphics(this.record.getConfig());this.highlightGraphics(t.getGraphics()),yield this.record.fly({speedFactor:this.getSpeedFactor()})}))}prepare(e){return Bt(this,void 0,void 0,(function*(){switch(yield this._setSpeed(null),this.type){case t.Rotate:case t.Path:{const t=this._getLimitionParamForPrepare(this.record,e);return yield this.record.prepare(t)}case t.Route:{const t=yield this.prepareSpecifiedRecord(e,this.flyStateCallbacks);return!(!t.isCanPlay||!t.prepareState)}default:return console.error("error type:",this.type),!1}}))}fly(e){var i;return Bt(this,void 0,void 0,(function*(){switch(yield this.setSpeedFactor(e.settingSpeed),this.type){case t.Rotate:case t.Path:yield this.record.fly({speedFactor:this.getSpeedFactor()});break;case t.Route:if(q(null===(i=this.playingInfo.currentIds)||void 0===i?void 0:i.ids))return this.flyStateCallbacks.onFly(),void(yield this.playTask());this.flyStateCallbacks.onFly(),!this._isPlayRoute(e.ids)&&e.isPreviewSpecifiedRecord?yield this.playSpecifiedRecord():yield this.playRouteFly({routeUuid:e.ids.routeUuid},0);break;default:console.error("error type:",this.type)}}))}pause(){var e;return Bt(this,void 0,void 0,(function*(){switch(this.type){case t.Rotate:case t.Path:case t.Route:yield null===(e=this.record)||void 0===e?void 0:e.pause();break;default:console.error("fly-route.pause error type:",this.type)}}))}stop(e=!1){var i,s;return Bt(this,void 0,void 0,(function*(){switch(this.type){case t.Rotate:case t.Path:yield null===(i=this.record)||void 0===i?void 0:i.stop();break;case t.Route:if(e)return;yield this.pause(),this.interruptDelayWaiting(),this._onAllRecordsFinish(),yield null===(s=this.record)||void 0===s?void 0:s.stop();break;default:console.error("fly-route.stop error type:",this.type)}}))}setSpeedFactor(e){return Bt(this,void 0,void 0,(function*(){switch(this.type){case t.Rotate:case t.Path:case t.Route:}return yield this._setSpeed(e)}))}getSpeedFactor(){return this.speedFactor}_setSpeed(t){var e;return Bt(this,void 0,void 0,(function*(){null===t&&(t=.5),this.speedFactor=t,this.playingInfo.isWaiting?(this.interruptDelayWaiting(),yield this.playTask()):null===(e=this.record)||void 0===e||e.setSpeedFactor(t)}))}_computeRouteTaskTimeScale(){let t=1;switch(this.speedFactor){case 0:t=8;break;case.25:t=4;break;case.375:t=2;break;default:t=1;break;case.59375:t=1/1.5;break;case.625:t=.5;break;case.75:t=1/4;break;case 1:t=1/8}return t}setIsLiveview(e,i){var s,n;return Bt(this,void 0,void 0,(function*(){switch(this.type){case t.Rotate:case t.Path:return yield this.record.setIsLiveview(e);case t.Route:if(e){const t=yield this.prepareSpecifiedRecord({ids:i},this.flyStateCallbacks);return!(!t.isCanPlay||!t.prepareState)&&(yield null===(s=this.record)||void 0===s?void 0:s.setIsLiveview(e))}return yield null===(n=this.record)||void 0===n?void 0:n.setIsLiveview(e);default:console.error("error type:",this.type)}}))}getLiveviewSettingInfo(){switch(this.type){case t.Rotate:case t.Path:case t.Route:return this.record.getLiveviewSettingInfo();default:console.error("error type:",this.type)}}getDefaultDuration(){switch(this.type){case t.Rotate:case t.Path:case t.Route:return this.record.getDefaultDuration();default:console.error("error type:",this.type)}}setLiveviewSettingInfo(e,i){var s,n;return Bt(this,void 0,void 0,(function*(){switch(this.type){case t.Rotate:case t.Path:case t.Route:{yield null===(s=this.record)||void 0===s?void 0:s.setLiveviewSettingInfo(e),(null===(n=null==i?void 0:i.isUpdateLine)||void 0===n||n)&&this.record.setGraphicsInfo(this.drawOrUpdateGraphics(this.record.getConfig()));const t=this.record.getGraphicsInfo();q(null==i?void 0:i.isNeedHighlight)&&i.isNeedHighlight&&q(t.getGraphics())&&this.highlightGraphics(t.getGraphics());break}default:console.error("error type:",this.type)}}))}_isPlayRoute(t){return q(t.routeUuid)&&!q(t.recordUuid)}prepareSpecifiedRecord(t,e){return Bt(this,void 0,void 0,(function*(){const i=t.ids;if(this._isPlayRoute(t.ids)){const e=J(this.itemConfig.routes,t.ids,0);i.recordUuid=null==e?void 0:e.idx}const{isCanPlay:s}=yield this.checkAndSwitchJimuMapBeforePlay(t.ids);if(!s)return console.error("FlyRoute.prepareSpecifiedRecord(): JimuMap is not matched"),{isCanPlay:!1,prepareState:null};this._redrawAllRecordGraphics(t.ids);let n=e;!!t.isBuilderSettingFlag&&(n={onFly:()=>{e.onFly()},onFinish:()=>{this.highlightGraphics(null),e.onFinish()},onPause:()=>{this.highlightGraphics(null),e.onPause()}}),this.record=yield this._getFlyRecordDynamically(t.ids,this.getCurrentSceneView(),n);const r=this._getLimitionParamForPrepare(this.record,t);return{isCanPlay:!0,prepareState:yield this.record.prepare(r)}}))}playRouteFly(t,e){return Bt(this,void 0,void 0,(function*(){const i=z(this.itemConfig.routes,t),s=i.records.length-e,n=e,r=J(this.itemConfig.routes,t,e);this.initTask({routeUuid:i.idx,recordUuid:null==r?void 0:r.idx},n,s),yield this.playTask({init:!0})}))}initTask(t,e,i){this._resetPlayingInfo(),this.playingInfo.currentIds={ids:t,orderId:e-1},this.playingInfo.maxRecordLen=i,this.playingInfo.isWaiting=!1,this.playingInfo.continueDelay=0;const s=this.getCurrentSceneView(),n=s.on("drag",(t=>{this.playingInfo.isWaiting&&"start"===t.action&&(this.interruptDelayWaiting(),this.flyStateCallbacks.onPause())})),r=s.on("mouse-wheel",(t=>{this.playingInfo.isWaiting&&(this.interruptDelayWaiting(),this.flyStateCallbacks.onPause())}));this.playingInfo.eventHandlers.push(n),this.playingInfo.eventHandlers.push(r),this._nextPlayingInfo()}_nextPlayingInfo(){var t;this.playingInfo.currentIds.orderId++;const e={routeUuid:null===(t=this.playingInfo.currentIds.ids)||void 0===t?void 0:t.routeUuid,recordUuid:null},i=J(this.itemConfig.routes,e,this.playingInfo.currentIds.orderId);this.playingInfo.currentIds.ids={routeUuid:e.routeUuid,recordUuid:null==i?void 0:i.idx}}playTask(t){var e;return Bt(this,void 0,void 0,(function*(){if(this.playingInfo.isWaiting=!1,this.playingInfo.currentIds.orderId>=this.playingInfo.maxRecordLen)return void this._onAllRecordsFinish();const i={onFinish:this._onOneRecordFinish.bind(this,{}),onPause:this._onPause.bind(this,{})},s=J(this.itemConfig.routes,this.playingInfo.currentIds.ids,this.playingInfo.currentIds.orderId);if((null==t?void 0:t.init)||(null===(e=this.record)||void 0===e?void 0:e.getConfig().idx)!==(null==s?void 0:s.idx)){const t=yield this.prepareSpecifiedRecord({ids:this.playingInfo.currentIds.ids},i);if(!t.isCanPlay)return console.warn("playTask: skip a record"),i.onFinish(),!1;if(!t.prepareState)return i.onPause(),!1}const n=this.record.getConfig().endDelay;q(n)?this.playingInfo.continueDelay=n*this._computeRouteTaskTimeScale():this.playingInfo.continueDelay=0,yield this.record.fly({speedFactor:this.getSpeedFactor()})}))}_onOneRecordFinish(){return Bt(this,void 0,void 0,(function*(){if(this._nextPlayingInfo(),q(this.playingInfo.continueDelay)){this.playingInfo.waittingPromise=this._abortWrapper(this.waitDelay(this.playingInfo.continueDelay));try{yield this.playingInfo.waittingPromise,yield this.playTask()}catch(t){}}else yield this.playTask()}))}waitDelay(t){return Bt(this,void 0,void 0,(function*(){return this.playingInfo.isWaiting=!0,yield new Promise(((e,i)=>{setTimeout((()=>{e({})}),1e3*t)}))}))}interruptDelayWaiting(){var t;q(null===(t=this.playingInfo.waittingPromise)||void 0===t?void 0:t.abort)&&this.playingInfo.waittingPromise.abort(),this.playingInfo.isWaiting=!1,this.playingInfo.continueDelay=0}_abortWrapper(t){return Bt(this,void 0,void 0,(function*(){let e;const i=new Promise(((t,i)=>e=i)),s=Promise.race([t,i]);return s.abort=e,s}))}_onPause(){var t;null===(t=this.flyStateCallbacks)||void 0===t||t.onPause()}_onAllRecordsFinish(){var t;this._resetPlayingInfo(),null===(t=this.flyStateCallbacks)||void 0===t||t.onFinish()}_resetPlayingInfo(){var t;q(null===(t=this.playingInfo)||void 0===t?void 0:t.eventHandlers)&&(this.playingInfo.eventHandlers.forEach((t=>{t.remove()})),this.playingInfo.eventHandlers=null,this.playingInfo.eventHandlers=[]),this.playingInfo={currentIds:{ids:null,orderId:0},maxRecordLen:0,waittingPromise:null,isWaiting:!1,continueDelay:0,eventHandlers:[]}}}var Wt=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{l(s.next(t))}catch(t){r(t)}}function o(t){try{l(s.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((s=s.apply(t,e||[])).next())}))};class Jt{constructor(){this.sceneView=null}setup(t){return Wt(this,void 0,void 0,(function*(){return yield(0,h.loadArcGISJSAPIModules)(["esri/core/watchUtils"]).then((e=>{[this.watchUtils]=e,this.sceneView=t.sceneView,this.onTerrainLoaded=t.onTerrainLoaded,this.handleTerrainLoaded()})),this}))}handleTerrainLoaded(){return Wt(this,void 0,void 0,(function*(){yield Promise.race([this.getTerrainLoadedPromise(),this.getTimerPromise(1e4)]),this.onTerrainLoaded()}))}getTerrainLoadedPromise(){return Wt(this,void 0,void 0,(function*(){if(!this.sceneView||!this.sceneView.groundView)return!1;try{yield this.watchUtils.whenTrueOnce(this.sceneView.groundView,"updating"),yield this.watchUtils.whenFalseOnce(this.sceneView.groundView,"updating")}catch(t){return!1}return!0}))}getTimerPromise(t){return Wt(this,void 0,void 0,(function*(){return yield new Promise((e=>setTimeout(e,t)))}))}}var $t=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{l(s.next(t))}catch(t){r(t)}}function o(t){try{l(s.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((s=s.apply(t,e||[])).next())}))};class qt{constructor(e){this.findFirstUsedItem=()=>{for(let t=0,e=this.itemsList.length;t<e;t++){const e=this.itemsList[t];if(e.config.isInUse)return e}return{config:null,routes:null}},this.findFirstRouteItem=()=>{for(const e of this.itemsList)if(e.config.isInUse&&t.Route===e.config.name)return e;return{config:null,routes:null}},this._findItemIdx=t=>this.itemsList.findIndex((e=>e.config.uuid===t)),this.getActiveItem=()=>this.activedItem,this.getActiveItemConfig=()=>{var t;return null===(t=this.activedItem)||void 0===t?void 0:t.config},this.getFlyStyle=()=>{var t;return null===(t=this.activedItem)||void 0===t?void 0:t.config.name},this.getRouteByIdx=t=>this.getActiveItem().routes,this.getRouteConfigByIdx=t=>{var e;const i=this.getActiveItemConfig();return null===(e=null==i?void 0:i.routes)||void 0===e?void 0:e.find((e=>e.idx===t.routeUuid))},this.getRecordConfigByIds=t=>W(this.getActiveItemConfig().routes,t),this.getRecordByIds=t=>{var e;const i=null===(e=this.activedItem.routes)||void 0===e?void 0:e.record;return t.recordUuid===(null==i?void 0:i.getConfig().idx)?i:null},this.isUesRouteFlyMode=()=>{const e=this.getActiveItemConfig();return(null==e?void 0:e.name)===t.Route},this.clear=()=>{},this.checkAndSwitchJimuMapBeforePlay=t=>$t(this,void 0,void 0,(function*(){const e=this.getRecordConfigByIds(t);if(!q(e))return{isCanPlay:!1,hadSwitchedMap:!1};const i=this.isJimuMapViewInGroup(e.mapViewId),s=this.isCurrentJimuMap(e);return s?{isCanPlay:!0,hadSwitchedMap:!1}:i?s?{isCanPlay:!0,hadSwitchedMap:!1}:(this.onBeforeSwitchMap(),yield this.viewGroup.switchMap(),{isCanPlay:!0,hadSwitchedMap:!0}):(console.error("FlyManager.checkAndSwitchJimuMapBeforePlay: this RecordConfig can't fly in this JimuMap"),{isCanPlay:!1,hadSwitchedMap:!1})})),this.isRecordCanPlay=t=>{const e=this.isJimuMapViewInGroup(t.mapViewId);return!!this.isCurrentJimuMap(t)||!!e||(console.error("FlyManager.isRecordCanPlay: this RecordConfig can't fly in this JimuMap"),!1)},this.isJimuMapViewInGroup=t=>{var e;let i=null!=t?t:this.jimuMapView.id;return i=$(i),!!q(Object.keys(null===(e=this.viewGroup)||void 0===e?void 0:e.jimuMapViews).find((t=>$(t)===i)))},this.isCurrentJimuMap=t=>{var e;return t.mapViewId===$(null===(e=this.jimuMapView)||void 0===e?void 0:e.id)},this.getCurrentSceneView=()=>this.sceneView,this.stop(),this.onTerrainLoaded=e.onTerrainLoaded,this.onBeforeSwitchMap=e.onBeforeSwitchMap,this.drawOrUpdateGraphics=e.drawOrUpdateGraphics,this.highlightGraphics=e.highlightGraphics,this.onItemsUpdate=e.onItemsUpdate,this.isBuilderSettingFlag=e.isBuilderSettingFlag,this.updateViewGroup(e.viewGroup),this.updateJimuMapView(e.jimuMapView),this.uiLoadingCallbacks=e.uiLoadingCallbacks,this.flyStateCallbacks=e.flyStateCallbacks,this.updateItems(e.widgetConfig)}updateViewGroup(t){this.viewGroup=t}updateJimuMapView(t){var e;this.jimuMapView=t,this.sceneView=null===(e=this.jimuMapView)||void 0===e?void 0:e.view;const i=this.getActiveItem();q(null==i?void 0:i.routes)&&(null==i||i.routes.handleUpdateJimuMapView(t)),this.getTerrainLoadingHelper(this.sceneView,this.onTerrainLoaded)}updateItems(t){this.itemsList=[];const e=t.itemsList.asMutable({deep:!0});for(const t of e)t.isInUse&&this.itemsList.push({config:t,routes:null});"function"==typeof this.onItemsUpdate&&this.onItemsUpdate(this.itemsList)}destructor(){this.stop()}findItemByUuid(t){var e;let i=null;return i=null===(e=this.itemsList)||void 0===e?void 0:e.find((e=>e.config.uuid===t)),i}registerItem(t){const e=this.findItemByUuid(t);this.activedItem=e}unRegisterItem(){var t;(null===(t=this.activedItem)||void 0===t?void 0:t.routes)&&this.activedItem.routes.destructor(),this.activedItem=null}getControllerTypeByItemData(e){let i;return e.name===t.Rotate?i=yt.Rotate:e.name===t.Path&&(i=e.style),i}buildTemporaryRecordConfig(e,i,s){const n=this.getActiveItemConfig(),r=this.getFlyStyle();let a;return r===t.Rotate?a=yt.Rotate:r===t.Path&&(a=this.getControllerTypeByItemData(n)),{idx:null,type:a,displayName:"runtime",duration:null,startDelay:null,endDelay:null,angle:null,controllerConfig:{cameraInfo:i,liveviewSettingState:null},direction:n.direction,storedGraphicsInfo:{type:Ut.RawData,rawData:e.getConfig()},mapViewId:s.id}}buildTemporaryRecord(t,e,i,s){return $t(this,void 0,void 0,(function*(){const n=yield(new Ht).setup(t,e,i);return q(s)&&n.setGraphicsInfo(s),n}))}prepareRoutePreview(t,e){return $t(this,void 0,void 0,(function*(){if(!this.isUesRouteFlyMode())return!1;const i=this.getActiveItem();return yield this.setupFly(i.config,null,null!=e?e:this.flyStateCallbacks),yield this.prepare({ids:{routeUuid:t.routeUuid},waittingForTerrain:!1})}))}previewSpecifiedRoute(t,e,i){return $t(this,void 0,void 0,(function*(){if(!this.isUesRouteFlyMode())return;const s=this.getActiveItem(),n=null!=i?i:this.flyStateCallbacks;q(s.routes)||(yield this.prepareRoutePreview(e,n)),yield this.fly({ids:e,settingSpeed:t,isPreviewSpecifiedRecord:!1},n)}))}previewSpecifiedRecord(t,e){return $t(this,void 0,void 0,(function*(){if(!this.isUesRouteFlyMode())return;const{isCanPlay:i}=yield this.checkAndSwitchJimuMapBeforePlay(t);if(!i)return;const s=this.getActiveItem();yield this.setupFly(s.config,null,e),(yield this.prepare({ids:t,isBuilderSettingFlag:this.isBuilderSettingFlag}))&&(yield this.fly({ids:t,settingSpeed:null,isPreviewSpecifiedRecord:!0}))}))}setIsLiveviewSpecifiedRecord(t,e){return $t(this,void 0,void 0,(function*(){if(!this.isUesRouteFlyMode())return;const i=this.getActiveItem();if(q(i.routes)||(yield this.setupFly(i.config,null),yield this.prepare({ids:t,animate:!1})),yield this.setIsLiveview(e,t),e){const t=yield this.getLiveviewSettingInfo();this.onLiveviewParamChange(t,{isNeedHighlight:!0})}}))}loadingForUI(t){const e=null!=t?t:this.uiLoadingCallbacks;"function"==typeof e.onLoading&&e.onLoading()}loadedForUI(t){const e=null!=t?t:this.uiLoadingCallbacks;"function"==typeof e.onLoaded&&e.onLoaded()}setupFly(t,e,i,s){return $t(this,void 0,void 0,(function*(){const n=this.getActiveItem();n.routes&&n.routes.destructor();const r=null!=i?i:this.flyStateCallbacks;return n.routes=yield(new zt).setup(t,e,this.jimuMapView,r,this.drawOrUpdateGraphics,this.highlightGraphics,this.checkAndSwitchJimuMapBeforePlay,this.getCurrentSceneView,s),n}))}prepare(t){var e;return $t(this,void 0,void 0,(function*(){const i=this.getActiveItem();return q(i)?yield null===(e=i.routes)||void 0===e?void 0:e.prepare(t):null}))}fly(t,e){var i,s;return $t(this,void 0,void 0,(function*(){const n=this.getActiveItem();if(!q(n))return null;e&&(null===(i=n.routes)||void 0===i||i.handleUpdateFlyCallbacks(e)),yield null===(s=n.routes)||void 0===s?void 0:s.fly(t)}))}pause(){var t;return $t(this,void 0,void 0,(function*(){const e=this.getActiveItem();if(!q(e))return null;yield null===(t=e.routes)||void 0===t?void 0:t.pause()}))}stop(t={isUpdate:!1}){var e;return $t(this,void 0,void 0,(function*(){const i=this.getActiveItem();if(!q(i))return null;yield null===(e=i.routes)||void 0===e?void 0:e.stop(t.isUpdate)}))}getProgress(){}getLiveviewSettingInfo(){const t=this.getActiveItem();return q(t)?t.routes.getLiveviewSettingInfo():null}getDefaultDuration(){var t;const e=this.getActiveItem();return q(e)?null===(t=e.routes)||void 0===t?void 0:t.getDefaultDuration():null}setIsLiveview(t,e){return $t(this,void 0,void 0,(function*(){const i=this.getActiveItem();return q(i)?yield i.routes.setIsLiveview(t,e):null}))}onLiveviewParamChange(t,e){var i;return $t(this,void 0,void 0,(function*(){const s=this.getActiveItem();if(!q(s))return null;yield null===(i=s.routes)||void 0===i?void 0:i.setLiveviewSettingInfo(t,e)}))}setSpeedFactor(t){var e;return $t(this,void 0,void 0,(function*(){const i=this.getActiveItem();if(!q(i))return null;yield null===(e=i.routes)||void 0===e?void 0:e.setSpeedFactor(t)}))}getTerrainLoadingHelper(t,e){return $t(this,void 0,void 0,(function*(){this.terrainLoadingHelper=yield(new Jt).setup({sceneView:t,onTerrainLoaded:e})}))}}var Zt;!function(t){t.RelativeToGround="relative-to-ground",t.OnTheGround="on-the-ground"}(Zt||(Zt={}));class Qt{constructor(){this.widgetId="",this.jimuMapView=null,this.GraphicsLayer=null,this.removeAllGraphics=()=>{var t,e;null===(t=this.layersGroup.layerOnTheGround)||void 0===t||t.removeAll(),null===(e=this.layersGroup.layerRelativeToGround)||void 0===e||e.removeAll()}}setup(t,e){return i=this,s=void 0,r=function*(){return yield(0,h.loadArcGISJSAPIModules)(["esri/layers/GraphicsLayer"]).then((i=>{[this.GraphicsLayer]=i,this.widgetId=e,this.resetJimuMapView(t),this.layersGroup={layerRelativeToGround:null,layerOnTheGround:null},this.resetGraphicsLayers()})),this},new((n=void 0)||(n=Promise))((function(t,e){function a(t){try{l(r.next(t))}catch(t){e(t)}}function o(t){try{l(r.throw(t))}catch(t){e(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof n?i:new n((function(t){t(i)}))).then(a,o)}l((r=r.apply(i,s||[])).next())}));var i,s,n,r}resetJimuMapView(t){var e,i,s,n;return this.jimuMapView&&(null===(e=this.jimuMapView.view)||void 0===e||e.map.remove(null===(i=this.layersGroup)||void 0===i?void 0:i.layerRelativeToGround),null===(s=this.jimuMapView.view)||void 0===s||s.map.remove(null===(n=this.layersGroup)||void 0===n?void 0:n.layerOnTheGround)),this.jimuMapView=t,this}resetGraphicsLayers(){return this._getGraphicsLayer(Zt.RelativeToGround),this._getGraphicsLayer(Zt.OnTheGround),this}_getGraphicsLayer(t){var e;let i=null;const s=t+"-draw-layer-"+this.widgetId+"-"+this.jimuMapView.id;(null===(e=this.jimuMapView.view)||void 0===e?void 0:e.map)&&(i=this.jimuMapView.view.map.findLayerById(s),i||(i=new this.GraphicsLayer({id:s,listMode:"hide",title:s,elevationInfo:{mode:t}}),this.jimuMapView.view.map.add(i))),t===Zt.RelativeToGround?this.layersGroup.layerRelativeToGround=i:t===Zt.OnTheGround&&(this.layersGroup.layerOnTheGround=i)}}var Yt=o(58290),Kt=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{l(s.next(t))}catch(t){r(t)}}function o(t){try{l(s.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((s=s.apply(t,e||[])).next())}))};class Xt extends r.React.PureComponent{constructor(t){super(t),this.Graphic=null,this.Geometry=null,this.Point=null,this.handleDrawToolCreated=t=>Kt(this,void 0,void 0,(function*(){this.jimuDrawToolsRef=t,yield this.jimuDrawToolsRef.complete(),this.props.onDrawHelperCreated(this)})),this.handleDrawToolsActived=t=>{null!==t&&this._drawingModeChange(t)},this.handleDrawCancel=()=>{this._drawingModeChange(me.Null),this.props.onDrawCancel()},this._drawingModeChange=t=>{this.drawingMode=t,this.props.onDrawingModeChanged(t)},this.handleDrawStart=()=>{"function"==typeof this.props.onDrawStart&&this.props.onDrawStart()},this.handleDrawEnd=t=>{},this.handleDrawFinish=({type:t,graphics:e,layer:i})=>{var s,n;if("deleted"===t||"modified"===t)return;if(null==i||i.removeAll(),"aborted"===t)return this.handleDrawCancel();const r=null===(n=null===(s=this.sceneView)||void 0===s?void 0:s.camera)||void 0===n?void 0:n.clone().toJSON(),a=e&&e[0],o=new f({graphics:null,isPicked:!1});this.drawingMode===me.Point&&(a.geometry.z&&(a.geometry.z=0),o.setGraphics(this.doDrawPoint(a)),this.props.onDrawFinish({graphicsInfo:o,cameraInfo:r,drawingMode:this.drawingMode}),this._drawingModeChange(me.Null)),this.drawingMode===me.Line&&(o.setGraphics(this.doDrawLine(a)),this.props.onDrawFinish({graphicsInfo:o,cameraInfo:r,drawingMode:this.drawingMode}),this._drawingModeChange(me.Null))},this.getGraphicsByAttrId=t=>{let e=[];const i=this.props.layersGroup.layerOnTheGround.graphics.toArray().filter((e=>e.attributes.id===t));return i.length>0?(e.push(i[0]),e=e.concat(this.props.layersGroup.layerRelativeToGround.graphics.toArray().filter((e=>e.attributes.id===t))),e):this.props.layersGroup.layerRelativeToGround.graphics.toArray().filter((e=>e.attributes.id===t))},this._removeGraphicsByAttrId=t=>{let e=this.props.layersGroup.layerRelativeToGround.graphics.toArray().filter((e=>e.attributes.id===t.attributes.id));e.length>0&&this.props.layersGroup.layerRelativeToGround.removeMany(e),e=this.props.layersGroup.layerOnTheGround.graphics.toArray().filter((e=>e.attributes.id===t.attributes.id)),e.length>0&&this.props.layersGroup.layerOnTheGround.removeMany(e)},this.setGeoZ=(t,e)=>{t.geometry.z=e},this.doDrawPoint=t=>{const e=t.clone();return this._removeGraphicsByAttrId(t),e.layer=this.props.layersGroup.layerRelativeToGround,this.props.layersGroup.layerRelativeToGround.addMany([e]),[e]},this.doDrawLine=t=>{const e=t.clone();this._removeGraphicsByAttrId(t),e.layer=this.props.layersGroup.layerOnTheGround,this.props.layersGroup.layerOnTheGround.addMany([e]);const i=this.genStartEndPoint(e);this.props.layersGroup.layerRelativeToGround.addMany(i);let s=[];return s.push(e),s=s.concat(i),s},this.genStartEndPoint=t=>{const e=t.geometry.paths[0];return[this.genExtraPoint(e[0],t,this.materials.startPtMarker),this.genExtraPoint(e[e.length-1],t,this.materials.endPtMarker)]},this.genExtraPoint=(t,e,i)=>{let s=t;return"local"===this.sceneView.viewingMode?s=new this.Point({x:s[0],y:s[1],z:0,spatialReference:this.sceneView.spatialReference}):(s=this.webMercatorUtils.xyToLngLat(s[0],s[1]),s=new this.Point({x:s[0],y:s[1],z:s[2]})),s=new this.Graphic({geometry:s,symbol:i,layer:this.props.layersGroup.layerRelativeToGround,attributes:{id:e.attributes.id}}),s},this.updateLineByAltitude=(t,e)=>{var i;const s=0===e,n=this.getGraphicsByAttrId(t.attributes.id),r=n[0].clone(),a=n[1].clone(),o=n[2].clone();if(this._removeGraphicsByAttrId(r),s)r.layer=this.props.layersGroup.layerOnTheGround,this.props.layersGroup.layerOnTheGround.addMany([r]);else{r.layer=this.props.layersGroup.layerRelativeToGround;const t=r.geometry;t.hasZ=!0,q(null===(i=t.paths)||void 0===i?void 0:i.length)&&(t.paths.forEach((t=>{t.forEach((t=>{t[2]=e}))})),this.props.layersGroup.layerRelativeToGround.addMany([r]))}return a.layer=this.props.layersGroup.layerRelativeToGround,o.layer=this.props.layersGroup.layerRelativeToGround,this.setGeoZ(a,e),this.setGeoZ(o,e),this.props.layersGroup.layerRelativeToGround.addMany([a,o]),[r,a,o]},this.startDrawing=t=>{var e,i,s,n;"function"==typeof(null===(e=this.jimuDrawToolsRef)||void 0===e?void 0:e.sketch.cancel)&&(null===(i=this.jimuDrawToolsRef)||void 0===i||i.sketch.cancel()),me.Point===t&&(this.jimuDrawToolsRef.sketch.viewModel.pointSymbol=this.defaultSymbols.getDefaultPointSymbol([54,213,22]),null===(s=this.jimuDrawToolsRef)||void 0===s||s.sketch.create(t)),me.Line===t&&(this.jimuDrawToolsRef.sketch.viewModel.polylineSymbol=this.defaultSymbols.getDefaultLineSymbol([13,137,255]),null===(n=this.jimuDrawToolsRef)||void 0===n||n.sketch.create(t))},this.cancelDrawing=()=>{var t,e,i;this.handleDrawCancel(),"function"==typeof(null===(t=this.jimuDrawToolsRef)||void 0===t?void 0:t.sketch.cancel)&&q(null===(e=this.jimuDrawToolsRef)||void 0===e?void 0:e.sketch.viewModel)&&(null===(i=this.jimuDrawToolsRef)||void 0===i||i.sketch.cancel())},this.createOrUpdateGraphic=(t,e,i)=>{var s,n;t.geometry.paths?t.symbol=this.materials.lineSymbol.toJSON():t.symbol=this.materials.startPtMarker.toJSON();const r="function"==typeof t.clone?t.clone():this.Graphic.fromJSON(t);if("point"===r.geometry.type)return this.doDrawPoint(r);if("polyline"===r.geometry.type){i&&((null===(s=r.layer)||void 0===s?void 0:s.id)===this.props.layersGroup.layerRelativeToGround.id&&(null===(n=r.layer)||void 0===n?void 0:n.id)===this.props.layersGroup.layerOnTheGround.id||(r.geometry=_(r.geometry,this.sceneView)));let t=this.doDrawLine(r);return q(null==e?void 0:e.fixAltitude)&&!isNaN(null==e?void 0:e.fixAltitude)&&(t=this.updateLineByAltitude(r,null==e?void 0:e.fixAltitude)),t}},this.removeGraphics=t=>{q(t)&&(this.props.layersGroup.layerRelativeToGround.removeMany(t),this.props.layersGroup.layerOnTheGround.removeMany(t))},this.removeAll=()=>{var t,e;null===(t=this.props.layersGroup.layerRelativeToGround)||void 0===t||t.removeAll(),null===(e=this.props.layersGroup.layerOnTheGround)||void 0===e||e.removeAll()},this.drawPickedLineStartEndPoints=t=>this.doDrawLine(t),this.removePickedLineStartEndPoints=t=>{this._removeGraphicsByAttrId(t)},this.state={apiLoaded:!1},this.drawingMode=me.Null}componentDidMount(){var t;this.state.apiLoaded||(0,h.loadArcGISJSAPIModules)(["esri/Graphic","esri/geometry/Geometry","esri/geometry/Point","esri/geometry/support/webMercatorUtils"]).then((t=>Kt(this,void 0,void 0,(function*(){[this.Graphic,this.Geometry,this.Point,this.webMercatorUtils]=t,this.defaultSymbols=yield(new y).setup(),this.materials={markerColor:[13,137,255],markerSize:10,outlineColor:"[128, 128, 128, 0.8]",startPtMarker:this.defaultSymbols.getDefaultPointSymbol([54,213,22]),endPtMarker:this.defaultSymbols.getDefaultPointSymbol([255,65,89]),lineColor:[13,137,255,.5],lineSymbol:this.defaultSymbols.getDefaultLineSymbol([13,137,255])},this.setState({apiLoaded:!0})})))),this.sceneView=null===(t=this.props.jimuMapView)||void 0===t?void 0:t.view}componentDidUpdate(t,e){var i;this.props.jimuMapView!==t.jimuMapView&&(this.removeAll(),this.sceneView=null===(i=this.props.jimuMapView)||void 0===i?void 0:i.view)}render(){return this.state.apiLoaded&&this.props.jimuMapView&&this.props.layersGroup.layerOnTheGround&&this.props.layersGroup.layerRelativeToGround&&(0,r.jsx)("div",{style:{display:"none"}},(0,r.jsx)(Yt.Draw,{jimuMapView:this.props.jimuMapView,onDrawToolCreated:this.handleDrawToolCreated,onDrawToolsActived:this.handleDrawToolsActived,onDrawStart:this.handleDrawStart,onDrawEnd:this.handleDrawEnd,onDrawCancel:this.handleDrawCancel,onGraphicEdited:this.handleDrawFinish,creationMode:"update",disableSymbolSelector:!0,updateOnGraphicClick:!1,defaultCreateOptions:{hasZ:!0},defaultUpdateOptions:{enableZ:!1},pointSymbol:this.materials.startPtMarker,polylineSymbol:this.materials.lineSymbol}))}}var te=o(10466),ee=o.n(te);const ie=t=>{const{className:e}=t,i=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i}(t,["className"]),s=(0,r.classNames)("jimu-icon-component",e);return r.React.createElement(a.Icon,Object.assign({className:s,icon:ee()},i))};class se extends r.React.PureComponent{constructor(t){super(t),this.onPickBtnClick=()=>{this.props.onPickingStateCahnged(!this.props.isPicking)},this.insertAttrId=t=>(q(t)&&(q(t.attributes)||(t.attributes={}),q(t.attributes.id)||(t.attributes.id=r.utils.getUUID())),t),this.pointerMoveHandler=t=>{var e;this.props.isPicking&&(null===(e=this.props.jimuMapView)||void 0===e||e.view.hitTest(t).then((t=>{const e=null==t?void 0:t.results;if((null==e?void 0:e.length)>0){const t=e[0].graphic;this.props.onHoverPicking([t])}})))},this.pointerClickHandler=t=>{var e;this.props.isPicking&&(null===(e=this.props.jimuMapView)||void 0===e||e.view.hitTest(t).then((e=>this.clickGraphicsByPick(e,t))))},this.clickGraphicsByPick=(t,e)=>{var i,s;this.props.onPickingStateCahnged(!1);const n=(null===(i=this.props.jimuMapView)||void 0===i?void 0:i.view).camera.clone().toJSON(),r=t.results;if((null==r?void 0:r.length)>0){e.stopPropagation();let t=r[0].graphic;t=this.insertAttrId(t);const i=t.geometry;if(!i)return;if("polyline"===i.type)this.pickAndClickLine(t,n);else if("point"===i.type){let e;i.hasZ||(e=_(i,null===(s=this.props.jimuMapView)||void 0===s?void 0:s.view)),this.pickAndClickPoint(t,n,e)}}},this.pickAndClickPoint=(t,e,i)=>{const s=new f({graphics:[t],isPicked:!0});this.props.onPicked({graphicsInfo:s,cameraInfo:e,hitPointWithZ:i,pickMode:"point"})},this.pickAndClickLine=(t,e)=>{const i=new f({graphics:[t],isPicked:!0});this.props.onPicked({graphicsInfo:i,cameraInfo:e,hitPointWithZ:null,pickMode:"polyline"})},this.state={isPicking:!1},this._clearEvents(),this._resetEvents()}componentWillUnmount(){this._clearEvents()}_clearEvents(){q(this.pointerMoveEvent)&&(this.pointerMoveEvent.remove(),this.pointerMoveEvent=null),q(this.pointerDownEvent)&&(this.pointerDownEvent.remove(),this.pointerDownEvent=null)}_resetEvents(){var t,e;this.pointerMoveEvent=null===(t=this.props.jimuMapView)||void 0===t?void 0:t.view.on("pointer-move",this.pointerMoveHandler),this.pointerDownEvent=null===(e=this.props.jimuMapView)||void 0===e?void 0:e.view.on("pointer-down",this.pointerClickHandler)}componentDidUpdate(t){this.props.jimuMapView!==t.jimuMapView&&(this._clearEvents(),this._resetEvents())}render(){const t=!this.props.isDrawHelperLoaded||this.props.isPlaying,e=this.props.intl.formatMessage({id:"triggerSelectFeature",defaultMessage:"Select a feature"});return(0,r.jsx)(a.Button,{icon:!0,onClick:t=>this.onPickBtnClick(),active:this.props.isPicking,disabled:t,title:e,className:"btns pick-btn",type:"tertiary"},(0,r.jsx)(ie,null))}}class ne extends r.React.PureComponent{constructor(e){super(e),this._resetHightlightCache=()=>{this.highlightCache={hover:{graphic:null,hanlder:null},selected:{graphics:null,hanlder:null}}},this.removeHoverHightlightCache=()=>{q(this.highlightCache.hover.hanlder)&&this.highlightCache.hover.hanlder.remove(),this.highlightCache.hover.graphic=null,this.highlightCache.hover.hanlder=null},this.cacheHoverHightlight=(t,e)=>{this.highlightCache.hover.graphic=e,this.highlightCache.hover.hanlder=t},this.removeSelectedHightlightCache=()=>{q(this.highlightCache.selected.hanlder)&&this.highlightCache.selected.hanlder.remove(),this.highlightCache.selected.graphics=null,this.highlightCache.selected.hanlder=null},this.cacheSelectedHightlight=(t,e)=>{this.highlightCache.selected.graphics=e,this.highlightCache.selected.hanlder=t},this.highlightGraphicsByHover=e=>{var i,s;const n=q(e)?e[0]:null;if(null===n)return;const r=null===(i=null==n?void 0:n.geometry)||void 0===i?void 0:i.type;("polyline"===r&&this.props.flyStyle===t.Path||"point"===r&&this.props.flyStyle===t.Rotate)&&(null===(s=this.props.jimuMapView)||void 0===s||s.view.whenLayerView(n.layer).then((t=>{const e=t;this.cacheHoverHightlight(e.highlight(n),n)})))},this.highlightGraphicsBySelect=t=>{var e;const i=q(t)?t[0]:null;null!==i&&(null===(e=this.props.jimuMapView)||void 0===e||e.view.whenLayerView(i.layer).then((e=>{const s=e.highlight(i);this.cacheSelectedHightlight(s,t)})))},this.clear=()=>{this.removeHoverHightlightCache(),this.removeSelectedHightlightCache()},this._resetHightlightCache()}componentDidUpdate(t){this.props.hoverPickingGraphics!==t.hoverPickingGraphics&&(this.removeHoverHightlightCache(),this.highlightGraphicsByHover(this.props.hoverPickingGraphics)),this.props.selectedPickingGraphics!==t.selectedPickingGraphics&&(this.removeSelectedHightlightCache(),this.highlightGraphicsBySelect(this.props.selectedPickingGraphics))}componentWillUnmount(){this.clear(),this._resetHightlightCache()}render(){return null}}class re extends r.React.PureComponent{constructor(t){super(t),this.componentDidMount=()=>{this.props.onPopupHelperCreated(this)},this.componentWillUnmount=()=>{this.restoreMapPopupHightlightState()},this.clearCacheMapState=()=>{this.mapPopupState={popup:null,hightLight:null}},this.enablePopupAndHighlight=()=>{const t=this.props.jimuMapView;q(t)&&(t.startEdit(),t.enablePopup(),t.enableHighlight(),t.exitEdit())},this.disablePopupAndHighlight=()=>{const t=this.props.jimuMapView;q(t)&&(t.startEdit(),t.disablePopup(),t.disableHighlight(),t.exitEdit())},this.cacheMapPopupHightlightState=()=>{var t,e;this.mapPopupState.popup=null===(t=this.props.jimuMapView)||void 0===t?void 0:t.getIsEnablePopup(),this.mapPopupState.hightLight=null===(e=this.props.jimuMapView)||void 0===e?void 0:e.getIsEnableHighlight()},this.restoreMapPopupHightlightState=()=>{const t=this.props.jimuMapView;if(q(t)){let e=!1;t.startEdit();const i=this.mapPopupState.popup;i?(t.enablePopup(),e=!0):i||(t.disablePopup(),e=!0);const s=this.mapPopupState.hightLight;s?(t.enableHighlight(),e=!0):s||(t.disableHighlight(),e=!0),e&&this.clearCacheMapState(),t.exitEdit()}},this.mapPopupState={popup:null,hightLight:null},this.clearCacheMapState()}render(){return null}}class ae extends r.React.PureComponent{constructor(){super(...arguments),this.TRANSPARENT_GIF="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="}render(){const t={borderRadius:"50%",border:"none",backgroundColor:this.props.theme.colors.palette.light[600]};return(0,r.jsx)(r.React.Fragment,null,(0,r.jsx)(a.Button,{icon:!0,type:"tertiary",className:"btns "+this.props.className,disabled:!0},(0,r.jsx)(a.Icon,{icon:this.TRANSPARENT_GIF,style:t})))}}var oe=o(29786),le=o.n(oe);const he=t=>{const{className:e}=t,i=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i}(t,["className"]),s=(0,r.classNames)("jimu-icon-component",e);return r.React.createElement(a.Icon,Object.assign({className:s,icon:le()},i))};var ce=o(43126),de=o.n(ce);const ue=t=>{const{className:e}=t,i=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i}(t,["className"]),s=(0,r.classNames)("jimu-icon-component",e);return r.React.createElement(a.Icon,Object.assign({className:s,icon:de()},i))};var pe=o(74904),ge=o.n(pe);const ve=t=>{const{className:e}=t,i=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i}(t,["className"]),s=(0,r.classNames)("jimu-icon-component",e);return r.React.createElement(a.Icon,Object.assign({className:s,icon:ge()},i))};var me,ye;!function(t){t.Null="null",t.Point="point",t.Line="polyline"}(me||(me={})),function(t){t.Point="point",t.Line="polyline",t.Pick="pick",t.Clear="clear"}(ye||(ye={}));class fe extends r.React.PureComponent{constructor(e){super(e),this._isInCludeShowItem=t=>this.props.showItems.includes(t),this.handleDrawHelperCreated=t=>{this.drawHelperRef=t,this.setState({isDrawHelperLoaded:!0}),this.props.onRef(this)},this.handleDrawingModeChanged=t=>{me.Null!==t&&this.setState({isPicking:!1}),this.setState({drawingMode:t}),"function"==typeof this.props.onDrawingModeChanged&&this.props.onDrawingModeChanged(t)},this.getDrawBtnContent=()=>{const e=this._isInCludeShowItem(ye.Point),i=this._isInCludeShowItem(ye.Line),s=!!this.props.isDisabled||this.props.isPlaying||!this.state.isDrawHelperLoaded,n=this.props.intl.formatMessage({id:"triggerDrawPoint",defaultMessage:"Draw a point"}),o=this.props.intl.formatMessage({id:"triggerDrawPath",defaultMessage:"Draw a path"}),l=this.props.flyStyle;return(0,r.jsx)(r.React.Fragment,null,e&&(l===t.Rotate||null===l)&&(0,r.jsx)(a.Button,{icon:!0,active:me.Point===this.state.drawingMode,className:"oper-btns btns draw-btn",type:"tertiary",css:this.getBtnStyleForBuilder(),onClick:()=>this.onDrawBtnClick(me.Point,{isTriggerCancel:!0}),disabled:s,title:n},(0,r.jsx)(he,null)),i&&(l===t.Path||null===l)&&(0,r.jsx)(a.Button,{icon:!0,active:me.Line===this.state.drawingMode,className:"oper-btns btns draw-btn",type:"tertiary",css:this.getBtnStyleForBuilder(),onClick:()=>this.onDrawBtnClick(me.Line,{isTriggerCancel:!0}),disabled:s,title:o},(0,r.jsx)(ue,null)))},this.onDrawBtnClick=(t,e)=>{var i,s;(null==e?void 0:e.isTriggerCancel)&&(null===(i=this.drawHelperRef)||void 0===i||i.cancelDrawing()),t===this.state.drawingMode||me.Point!==t&&me.Line!==t||null===(s=this.drawHelperRef)||void 0===s||s.startDrawing(t)},this.handleDrawStart=()=>{this.beforInteract()},this.handleDrawEnd=()=>{},this.handleDrawFinish=t=>{var e;null!==this.state.selectedPickingGraphics&&(null===(e=this.drawHelperRef)||void 0===e||e.removePickedLineStartEndPoints(this.state.selectedPickingGraphics[0])),this.props.onDrawFinish(t,!1),this.highlightGraphics(t.graphicsInfo.getGraphics()),this.focusGraphics(t.graphicsInfo.getGraphics()),this.afterInteract()},this.handleDrawCancel=()=>{this.afterInteract(),"function"==typeof this.props.onDrawCancel&&this.props.onDrawCancel()},this.getPickBtnContent=()=>(0,r.jsx)(se,{jimuMapView:this.props.jimuMapView,intl:this.props.intl,isPlaying:this.props.isPlaying,isDrawHelperLoaded:this.state.isDrawHelperLoaded,drawingMode:this.state.drawingMode,isPicking:this.state.isPicking,onPicked:this.handlePicked,onPickingStateCahnged:this.handlePickingStateCahnged,onHoverPicking:this.handleHoverPicking,hoveredGraphic:this.state.hoveredGraphic}),this.handleHoverPicking=t=>{this.setState({hoverPickingGraphics:t})},this.handlePickingStateCahnged=t=>{t?this.drawHelperRef.cancelDrawing():t||this.setState({hoverPickingGraphics:null}),this.setState({isPicking:t})},this.handlePicked=t=>{if(!this.validPickingByType(t))return;this.clearAll();let e=t.graphicsInfo.getGraphics();const i=e[0];setTimeout((()=>{if("polyline"===i.geometry.type){const t=this.drawHelperRef.drawPickedLineStartEndPoints(i);e=[i,t[1],t[2]]}this.highlightGraphics(e),this.focusGraphics(e),this.props.onPickHanlder(t)}),10)},this.validPickingByType=e=>{let i=!1;return(this.props.flyStyle===t.Rotate&&"point"===e.pickMode||this.props.flyStyle===t.Path&&"polyline"===e.pickMode)&&(i=!0),i},this.highlight=t=>{null===t?this.clearHighlightGraphics():(this.highlightGraphics(t),this.focusGraphics(t))},this.clearHighlightGraphics=()=>{this.setState({selectedPickingGraphics:null}),this.setState({hoverPickingGraphics:null})},this.highlightGraphics=t=>{this.setState({selectedPickingGraphics:t})},this.getClearBtnContent=()=>{const t=this.props.intl.formatMessage({id:"triggerClear",defaultMessage:"Clear drawing or selection"}),e=this.props.isPlaying||null===this.props.focusedGraphic;return(0,r.jsx)(a.Button,{icon:!0,onClick:this.handleClearBtnClick,disabled:e,title:t,className:"btns clear-btn",type:"tertiary"},(0,r.jsx)(ve,null))},this.focusGraphics=t=>{this.props.onFocusedGraphicChanged(null);const e=null===t?null:t[0];this.props.onFocusedGraphicChanged(e)},this.handlePopupHelperCreated=t=>{this.popupHelperRef=t},this.beforInteract=()=>{var t,e;null===(t=this.popupHelperRef)||void 0===t||t.cacheMapPopupHightlightState(),null===(e=this.popupHelperRef)||void 0===e||e.disablePopupAndHighlight()},this.afterInteract=()=>{setTimeout((()=>{this.restoreMapPopupHightlightState()}),10)},this.restoreMapPopupHightlightState=()=>{var t;null===(t=this.popupHelperRef)||void 0===t||t.restoreMapPopupHightlightState()},this.handleClearBtnClick=()=>{this.clearAll(),this.focusGraphics(null),this.props.onClearBtnClick()},this.clearAll=()=>{var t,e;this.highlight(null),null===(t=this.popupHelperRef)||void 0===t||t.restoreMapPopupHightlightState(),null===(e=this.drawHelperRef)||void 0===e||e.removeAll()},this.onRenderStateChange=t=>{void 0!==(null==t?void 0:t.drawingMode)&&(this.handleDrawingModeChanged(t.drawingMode),this.onDrawBtnClick(t.drawingMode,{isTriggerCancel:!1})),null==t||t.isPicking},this.drawOrUpdateGraphics=t=>{var e;const i=t.storedGraphicsInfo.rawData,s=i.graphics[0],n=i.isPicked,r=null===(e=t.controllerConfig)||void 0===e?void 0:e.liveviewSettingState;let a;if(n){const t=s;a="polyline"===t.geometry.type||q(t.geometry.paths)?this.drawHelperRef.createOrUpdateGraphic(t,r,n):i.graphics}else a=this.drawHelperRef.createOrUpdateGraphic(s,r,n);return new f({graphics:a,isPicked:n})},this.removeGraphics=t=>{var e;null===(e=this.drawHelperRef)||void 0===e||e.removeGraphics(t)},this.removeAllGraphics=()=>{var t;null===(t=this.drawLayersGroup)||void 0===t||t.removeAllGraphics()},this.query=()=>null,this.state={apiLoaded:!1,layersGroup:{layerRelativeToGround:null,layerOnTheGround:null},isDrawHelperLoaded:!1,drawingMode:me.Null,isPicking:!1,hoveredGraphic:null,hoverPickingGraphics:null,selectedPickingGraphics:null}}componentDidMount(){return t=this,e=void 0,s=function*(){this.state.apiLoaded||(this.drawLayersGroup=yield(new Qt).setup(this.props.jimuMapView,this.props.widgetId),this.setState({apiLoaded:!0}),this.setState({layersGroup:this.drawLayersGroup.layersGroup}))},new((i=void 0)||(i=Promise))((function(n,r){function a(t){try{l(s.next(t))}catch(t){r(t)}}function o(t){try{l(s.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((s=s.apply(t,e||[])).next())}));var t,e,i,s}componentWillUnmount(){this.clearAll(),this.drawLayersGroup&&(this.drawLayersGroup=null),this.props.onRef(null)}componentDidUpdate(t,e){var i,s;this.props.jimuMapView!==t.jimuMapView&&(this.setState({hoverPickingGraphics:null}),this.setState({selectedPickingGraphics:null}),null===(i=this.drawLayersGroup)||void 0===i||i.resetJimuMapView(this.props.jimuMapView),null===(s=this.drawLayersGroup)||void 0===s||s.resetGraphicsLayers(),this.state.apiLoaded&&this.setState({layersGroup:this.drawLayersGroup.layersGroup}))}render(){let t=null;return t=(0,r.jsx)("div",null,(0,r.jsx)(r.React.Fragment,null,(!this.state.apiLoaded||!this.state.isDrawHelperLoaded||this.props.isDisabled)&&(0,r.jsx)(r.React.Fragment,null,this._isInCludeShowItem(ye.Point)&&(0,r.jsx)(ae,{theme:this.props.theme,className:"draw-btn"}),this._isInCludeShowItem(ye.Pick)&&(0,r.jsx)(ae,{theme:this.props.theme,className:"pick-btn"}),this._isInCludeShowItem(ye.Line)&&(0,r.jsx)(ae,{theme:this.props.theme,className:"clear-btn"})),this.state.apiLoaded&&this.state.isDrawHelperLoaded&&!this.props.isDisabled&&(0,r.jsx)(r.React.Fragment,null,this.getDrawBtnContent(),this._isInCludeShowItem(ye.Pick)&&this.getPickBtnContent(),this._isInCludeShowItem(ye.Clear)&&this.getClearBtnContent()),(0,r.jsx)(Xt,{jimuMapView:this.props.jimuMapView,onDrawHelperCreated:this.handleDrawHelperCreated,onDrawingModeChanged:this.handleDrawingModeChanged,onDrawStart:this.handleDrawStart,onDrawEnd:this.handleDrawEnd,onDrawFinish:this.handleDrawFinish,onDrawCancel:this.handleDrawCancel,layersGroup:this.state.layersGroup}),(0,r.jsx)(ne,{jimuMapView:this.props.jimuMapView,flyStyle:this.props.flyStyle,hoverPickingGraphics:this.state.hoverPickingGraphics,selectedPickingGraphics:this.state.selectedPickingGraphics}),(0,r.jsx)(re,{jimuMapView:this.props.jimuMapView,onPopupHelperCreated:this.handlePopupHelperCreated}))),t}getBtnStyleForBuilder(){var t,e,i;const s=null===(t=this.props.theme)||void 0===t?void 0:t.arcgis,n=null===(e=null==s?void 0:s.components)||void 0===e?void 0:e.button,{default:a}=null!==(i=null==n?void 0:n.variants)&&void 0!==i?i:{},o=null==a?void 0:a.active;return r.css`
      &.btns.active {
        color: ${o.color} !important;
        background-color: ${o.bg} !important;
        border-radius: ${o.borderRadius} !important;
        box-shadow: ${o.shadow} !important;
      }
    `}}var we=o(41553),Pe=o.n(we);const Se=t=>{const{className:e}=t,i=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i}(t,["className"]),s=(0,r.classNames)("jimu-icon-component",e);return r.React.createElement(a.Icon,Object.assign({className:s,icon:Pe()},i))};var Ce=o(56097),be=o.n(Ce);const Me=t=>{const{className:e}=t,i=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i}(t,["className"]),s=(0,r.classNames)("jimu-icon-component",e);return r.React.createElement(a.Icon,Object.assign({className:s,icon:be()},i))};var Ie=o(57986),xe=o.n(Ie);const Ge=t=>{const{className:e}=t,i=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i}(t,["className"]),s=(0,r.classNames)("jimu-icon-component",e);return r.React.createElement(a.Icon,Object.assign({className:s,icon:xe()},i))};var Le=o(65615),Ae=o.n(Le);const Re=t=>{const{className:e}=t,i=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i}(t,["className"]),s=(0,r.classNames)("jimu-icon-component",e);return r.React.createElement(a.Icon,Object.assign({className:s,icon:Ae()},i))};var Te=o(84205),je=o.n(Te);const De=t=>{const{className:e}=t,i=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i}(t,["className"]),s=(0,r.classNames)("jimu-icon-component",e);return r.React.createElement(a.Icon,Object.assign({className:s,icon:je()},i))};var ke=o(82633),Oe=o.n(ke);const Ve=t=>{const{className:e}=t,i=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i}(t,["className"]),s=(0,r.classNames)("jimu-icon-component",e);return r.React.createElement(a.Icon,Object.assign({className:s,icon:Oe()},i))};var Fe=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{l(s.next(t))}catch(t){r(t)}}function o(t){try{l(s.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((s=s.apply(t,e||[])).next())}))};class Ne extends r.React.PureComponent{constructor(e){super(e),this.onTerrainLoaded=()=>{this.setState({isTerrainLoaded:!0})},this.handleFlyManagerItemsUpdate=t=>{this.setState({flyManagerItems:t})},this.handleRefGraphicInteractionManager=t=>{this.setState({graphicInteractionManagerRef:t}),null!==t?this.setState({subCompsLoaded:!0}):this.setState({subCompsLoaded:!1})},this.isAutoControlWidgetIdChanged=t=>t.autoControlWidgetId&&this.props.autoControlWidgetId!==t.autoControlWidgetId,this.handleAutoControlMapPublish=()=>{(0,r.getAppStore)().dispatch(r.appActions.requestAutoControlMapWidget(this.props.useMapWidgetIds[0],this.props.widgetId))},this.resetDefaultUI=t=>{var e,i;this.setState({isFlyStylePopupOpen:!1}),this.setState({isLiveview:!1}),null===(e=this.state.graphicInteractionManagerRef)||void 0===e||e.onRenderStateChange({drawingMode:me.Null,isPicking:!1}),this.handleStop(),(null==t?void 0:t.isCleanGraphics)&&(this.handleFocusedGraphicChanged(null),null===(i=this.state.graphicInteractionManagerRef)||void 0===i||i.clearAll())},this.handleFlyStyleChange=t=>{var e;let i,s;null===t?(s=this.flyManager.findFirstUsedItem(),i=s.config.uuid):(s=this.flyManager.findItemByUuid(t),i=t),this.setState({activedItemUuid:i},(()=>{this.flyManager.isUesRouteFlyMode()||this.handleActivedRouteChange(null)})),this.handleSpeedChange(null),this.resetDefaultUI({isCleanGraphics:!0}),this.flyManager.unRegisterItem(),this.flyManager.registerItem(i),null===(e=this.state.graphicInteractionManagerRef)||void 0===e||e.removeAllGraphics()},this.handlePlayStateBtnClick=()=>{this.state.isPlaying?this.handlePause():this.handlePlay()},this.setPlayStatePlaying=t=>{var e;this.setState({isPlaying:t,isLiveview:!1}),null===(e=this.state.graphicInteractionManagerRef)||void 0===e||e.onRenderStateChange(null)},this.handleFlyLoading=()=>{this.setPlayStatePlaying(!0)},this.handleFlyLoaded=()=>{this.setPlayStatePlaying(!1)},this.handleFlyPlay=()=>{this.state.isLiveview||this.state.isPlaying||this.setPlayStatePlaying(!0)},this.handleFlyPause=()=>{this.setPlayStatePlaying(!1)},this.handleFlyFinish=()=>{this.setPlayStatePlaying(!1)},this.isLiveviewMode=()=>this.state.isLiveview,this.handleUpdateProgress=t=>{this.setState({progress:t})},this.getFlyStyleContent=()=>{const e=this.flyManager.getFlyStyle();let i=null;return e===t.Rotate?i=(0,r.jsx)(Re,null):e===t.Path?i=(0,r.jsx)(De,null):e===t.Route&&(i=(0,r.jsx)(Ve,null)),i},this.toggleFlyStylePopup=()=>{U(this.props.config.itemsList)<=1?this.setState({isFlyStylePopupOpen:!1}):this.state.isPlaying||this.setState({isFlyStylePopupOpen:!this.state.isFlyStylePopupOpen})},this.isDisableButton=t=>{const{isPlaying:e,isLiveview:i,focusedGraphic:s}=t;let n=!this.state.subCompsLoaded;return e&&(n=n&&!this.state.isPlaying),i&&(n=n&&!this.state.isLiveview),s&&(n=n||!q(this.state.focusedGraphic)),n},this.handleFocusedGraphicChanged=t=>{this.setState({focusedGraphic:t})},this.handleGraphicsUpdateHanlder=e=>Fe(this,void 0,void 0,(function*(){this.handleSpeedChange(null);const i=e.graphicsInfo,s=e.cameraInfo,n=this.flyManager.getFlyStyle();n===t.Rotate||n===t.Path&&this.handleAltitudeChange(0,{setToController:!0,isUpdateLine:!1,isNeedHighlight:!1});const r=yield this.flyManager.buildTemporaryRecordConfig(i,s,this.props.jimuMapView),a=yield this.flyManager.buildTemporaryRecord(r,this.props.jimuMapView.view,this.flyStateCallbacks,i),o=this.flyManager.getActiveItemConfig();yield this.flyManager.setupFly(o,null,this.flyStateCallbacks,a),yield this.flyManager.prepare(null)})),this.handlePickHanlder=t=>{this.handleGraphicsUpdateHanlder(t)},this.handleClearBtnClick=()=>{this.resetDefaultUI({isCleanGraphics:!0}),q(this.flyManager)&&this.handleStop()},this.toggleLiveviewSettingPopup=()=>Fe(this,void 0,void 0,(function*(){if(!q(this.state.focusedGraphic))return;const t=!this.state.isLiveview;yield this.flyManager.setIsLiveview(t);const e=yield this.flyManager.getLiveviewSettingInfo();q(e)&&(this.handleTiltChange(e.tilt),this.handleAltitudeChange(e.altitude,{isNeedHighlight:!0}),this.setState({isLiveview:t}))})),this.handleSpeedChange=t=>{var e;null===t&&(t=.5),this.setState({settingSpeed:t}),null===(e=this.flyManager)||void 0===e||e.setSpeedFactor(t)},this.handleTiltChange=(t,e)=>{this.setState({settingTilt:t}),q(this.flyManager)&&(null==e?void 0:e.setToController)&&this.flyManager.onLiveviewParamChange({tilt:t},{isUpdateLine:!1,isNeedHighlight:null==e?void 0:e.isNeedHighlight})},this.handleAltitudeChange=(t,e)=>{const i=function(t){return B((null==t?void 0:t.toFixed)?parseFloat(t.toFixed(T)):NaN)}(t);this.setState({settingAltitude:i}),q(this.flyManager)&&(null==e?void 0:e.setToController)&&this.flyManager.onLiveviewParamChange({altitude:i},{isUpdateLine:null==e?void 0:e.isUpdateLine,isNeedHighlight:null==e?void 0:e.isNeedHighlight})},this.handlePlay=()=>Fe(this,void 0,void 0,(function*(){(q(this.state.focusedGraphic)||this.flyManager.isUesRouteFlyMode())&&(yield this.flyManager.setIsLiveview(!1))&&(this.handleAutoControlMapPublish(),this.flyManager.fly({settingSpeed:this.state.settingSpeed,ids:{routeUuid:this.state.activedRouteUuid,recordUuid:null},isPreviewSpecifiedRecord:!1}))})),this.handleStop=()=>{var t;null===(t=this.flyManager)||void 0===t||t.stop()},this.handlePause=()=>{var t;null===(t=this.flyManager)||void 0===t||t.pause()},this.handleClear=()=>{var t;null===(t=this.flyManager)||void 0===t||t.clear()},this.toggleSpeedPopup=()=>{this.setState({isSpeedPopupOpen:!this.state.isSpeedPopupOpen})},this.isShowDropdownButtonArrow=t=>{var e;return t!==n.Palette&&(null===(e=this.state.flyManagerItems)||void 0===e?void 0:e.length)>1},this.isShowDropdownButtonDot=t=>{var e;return t===n.Palette&&(null===(e=this.state.flyManagerItems)||void 0===e?void 0:e.length)>1},this.handleActivedRouteChange=t=>Fe(this,void 0,void 0,(function*(){var e;null===(e=this.state.graphicInteractionManagerRef)||void 0===e||e.clearAll(),this.handleSpeedChange(null),this.setState({activedRouteUuid:t},(()=>Fe(this,void 0,void 0,(function*(){q(this.state.activedRouteUuid)&&this.flyManager.isUesRouteFlyMode()&&(yield this.flyManager.prepareRoutePreview({routeUuid:t}))}))))})),this.handleDrawOrUpdateGraphics=t=>{var e;if("function"==typeof(null===(e=this.state.graphicInteractionManagerRef)||void 0===e?void 0:e.drawOrUpdateGraphics))return this.state.graphicInteractionManagerRef.drawOrUpdateGraphics(t)},this.highlightGraphics=t=>{var e;"function"==typeof(null===(e=this.state.graphicInteractionManagerRef)||void 0===e?void 0:e.highlight)&&this.state.graphicInteractionManagerRef.highlight(t)};const i=.5,s=0,a=0;this.state={graphicInteractionManagerRef:null,flyManagerItems:null,subCompsLoaded:!1,isTerrainLoaded:!1,focusedGraphic:null,isFlyStylePopupOpen:!1,activedItemUuid:null,isPlaying:!1,isLiveview:!1,settingSpeed:i,settingTilt:s,settingAltitude:a,progress:0,isSpeedPopupOpen:!1,activedRouteUuid:null}}_reset(t){this.uiLoadingCallbacks={onLoading:this.handleFlyLoading,onLoaded:this.handleFlyLoaded},this.flyStateCallbacks={onFly:this.handleFlyPlay,onPause:this.handleFlyPause,onFinish:this.handleFlyFinish,onUpdateProgress:this.handleUpdateProgress},q(t)&&this._resetFlyManager()}_resetFlyManager(){var t;null===(t=this.flyManager)||void 0===t||t.destructor(),this.flyManager=new qt({widgetConfig:this.props.config,isBuilderSettingFlag:!1,jimuMapView:this.props.jimuMapView,viewGroup:this.props.viewGroup,uiLoadingCallbacks:this.uiLoadingCallbacks,flyStateCallbacks:this.flyStateCallbacks,drawOrUpdateGraphics:this.handleDrawOrUpdateGraphics,highlightGraphics:this.highlightGraphics,onItemsUpdate:this.handleFlyManagerItemsUpdate,onBeforeSwitchMap:this.handleAutoControlMapPublish,onTerrainLoaded:this.onTerrainLoaded}),this.flyManager.unRegisterItem(),this.handleFlyStyleChange(null)}getCurrentActiveItemName(){const t=this.flyManager.getActiveItemConfig();return null==t?void 0:t.name}componentDidMount(){this._reset(this.props.jimuMapView)}componentWillUnmount(){var t;this.resetDefaultUI({isCleanGraphics:!0}),null===(t=this.flyManager)||void 0===t||t.destructor()}componentDidUpdate(t,e){this.props.config!==t.config&&(this._resetFlyManager(),this.handleClearBtnClick());const i=this.props.jimuMapView!==t.jimuMapView,{isTriggeredByFly:s,isTriggeredByMapSelf:n}=(r=this.props.widgetId,{isTriggeredByFly:(a=this.props.autoControlWidgetId)===r,isTriggeredByMapSelf:a===this.props.useMapWidgetIds[0]});var r,a;i&&(this.setState({isTerrainLoaded:!1}),!s&&n&&this.handleClearBtnClick(),q(this.flyManager)?this.flyManager.updateJimuMapView(this.props.jimuMapView):this._resetFlyManager()),this.props.viewGroup!==t.viewGroup&&(q(this.flyManager)?this.flyManager.updateViewGroup(this.props.viewGroup):this._resetFlyManager()),i||!this.isAutoControlWidgetIdChanged(t)||n||this.handlePause()}renderFlyStyleSelectorContent(e){const i=this.flyManager.getActiveItemConfig(),s=q(i)&&(n=i.name,o=this.props,n===t.Rotate?o.intl.formatMessage({id:"flyStyleRotate",defaultMessage:d}):n===t.Path?o.intl.formatMessage({id:"flyStylePath",defaultMessage:u}):n===t.Route?o.intl.formatMessage({id:"flyStyleRoute",defaultMessage:p}):null);var n,o;const l=this.props.intl.formatMessage({id:"flyStyleRotate",defaultMessage:d}),h=this.props.intl.formatMessage({id:"flyStylePath",defaultMessage:u}),c=this.props.intl.formatMessage({id:"flyStyleRoute",defaultMessage:p}),g=this.isShowDropdownButtonArrow(e),v=this.isShowDropdownButtonDot(e),m=this.getFlyStyleContent();return(0,r.jsx)(a.Dropdown,{isOpen:this.state.isFlyStylePopupOpen,toggle:this.toggleFlyStylePopup,className:"dropdowns flystyle-btn",activeIcon:!0},(0,r.jsx)(a.DropdownButton,{icon:!0,className:"btns d-flex",title:s,type:"tertiary",arrow:g,dot:v},m),(0,r.jsx)(a.DropdownMenu,{showArrow:!1},this.state.flyManagerItems.map(((e,i)=>{const s=e.config,n=s.name,o=e.config.uuid,d=o===this.state.activedItemUuid;return s.isInUse?t.Rotate===n?(0,r.jsx)("div",{key:i},(0,r.jsx)(a.DropdownItem,{className:"dropdown-items",title:l,onClick:()=>this.handleFlyStyleChange(o),active:d},(0,r.jsx)(Re,null),(0,r.jsx)("span",{className:"mx-2"},l))):t.Path===n?(0,r.jsx)("div",{key:i},(0,r.jsx)(a.DropdownItem,{className:"dropdown-items",title:h,onClick:()=>this.handleFlyStyleChange(o),active:d},(0,r.jsx)(De,null),(0,r.jsx)("span",{className:"mx-2"},h))):t.Route===n?(0,r.jsx)("div",{key:i},(0,r.jsx)(a.DropdownItem,{className:"dropdown-items",title:c,onClick:()=>this.handleFlyStyleChange(o),active:d},(0,r.jsx)(Ve,null),(0,r.jsx)("span",{className:"mx-2"},c))):null:null}))))}renderLiveviewSettingContent(){var e;const i=this.isDisableButton({isPlaying:!0,focusedGraphic:!0}),s=this.props.intl.formatMessage({id:"settings",defaultMessage:a.defaultMessages.settings}),n=this.props.intl.formatMessage({id:"tilt",defaultMessage:a.defaultMessages.tilt}),o=this.props.intl.formatMessage({id:"altitude",defaultMessage:a.defaultMessages.altitude}),l=this.props.intl.formatMessage({id:"degree",defaultMessage:a.defaultMessages.degree}),h=this.props.intl.formatMessage({id:"meter",defaultMessage:a.defaultMessages.meter}),c=this.props.intl.formatMessage({id:"meterAbbr",defaultMessage:a.defaultMessages.meterAbbr}),d=this.props.intl.formatMessage({id:"ground",defaultMessage:a.defaultMessages.ground}),u=this.props.intl.formatMessage({id:"outerSpace",defaultMessage:a.defaultMessages.outerSpace}),p=this.props.intl.formatMessage({id:"relative2Ground",defaultMessage:a.defaultMessages.relative2Ground}),g=null===(e=this.flyManager)||void 0===e?void 0:e.getFlyStyle();return(0,r.jsx)(a.Dropdown,{isOpen:this.state.isLiveview,toggle:this.toggleLiveviewSettingPopup,className:"dropdowns liveview-btn"},(0,r.jsx)(a.DropdownButton,{icon:!0,className:"btns d-flex",disabled:i,title:s,type:"tertiary",arrow:!1},(0,r.jsx)(Se,null)),(0,r.jsx)(a.DropdownMenu,{showArrow:!1,css:at(this.props.theme)},g===t.Rotate&&(0,r.jsx)("div",{className:"d-flex dropdown-items flex-column"},(0,r.jsx)("span",{className:"d-flex dropdown-item-title"},n),(0,r.jsx)(a.Slider,{id:"setting-tilt",className:"d-flex",size:"sm",value:this.state.settingTilt,min:G,max:L,step:A,onChange:t=>this.handleTiltChange(t.target.value,{setToController:!0,isNeedHighlight:!0}),title:H(this.state.settingTilt,l)})),g===t.Path&&(0,r.jsx)(r.React.Fragment,null,(0,r.jsx)("div",{className:"d-flex dropdown-items flex-column"},(0,r.jsx)("span",{className:"d-flex dropdown-item dropdown-item-title"},o),(0,r.jsx)(a.Slider,{id:"setting-altitude",className:"d-flex dropdown-item",size:"sm",value:this.state.settingAltitude,min:M,max:I,step:x,onChange:t=>Fe(this,void 0,void 0,(function*(){return this.handleAltitudeChange(parseFloat(t.target.value),{setToController:!0,isNeedHighlight:!0})})),title:H(this.state.settingAltitude,h)}),(0,r.jsx)("div",{className:"d-flex justify-content-between dropdown-item-comment dropdown-item"},(0,r.jsx)("span",null,d),(0,r.jsx)("span",null,u))),(0,r.jsx)("div",{className:"d-flex dropdown-items flex-column"},(0,r.jsx)("div",{className:"d-flex alt-wapper"},(0,r.jsx)("div",{className:"alt-input"},(0,r.jsx)(a.NumericInput,{defaultValue:"0",size:"sm",value:this.state.settingAltitude,min:M,max:I,onChange:t=>Fe(this,void 0,void 0,(function*(){return this.handleAltitudeChange(t,{setToController:!0,isNeedHighlight:!0})}))})),(0,r.jsx)("span",{className:"setting-altitude-separator"},c),p)))))}renderPlayStateContent(){let t=null;const e=this.isDisableButton({isPlaying:!0,isLiveview:!0,focusedGraphic:!0})&&null===this.state.activedRouteUuid;let i=null;return this.state.isPlaying?(i=(0,r.jsx)(Ge,null),t=this.props.intl.formatMessage({id:"pause",defaultMessage:a.defaultMessages.pause})):(i=(0,r.jsx)(Me,null),t=this.props.intl.formatMessage({id:"play",defaultMessage:a.defaultMessages.play})),(0,r.jsx)(a.Button,{icon:!0,onClick:this.handlePlayStateBtnClick,title:t,disabled:e,className:"btns play-btn",type:"tertiary"},i)}renderProgressBarContent(e){var i;const s=e===n.Palette?"circular":"linear";return(null===(i=this.flyManager)||void 0===i?void 0:i.getFlyStyle())===t.Path?(0,r.jsx)(a.Progress,{type:s,value:this.state.progress,className:"w-100"}):null}renderSpeedControllerContent(){const t=this.props.intl.formatMessage({id:"speed",defaultMessage:g})+": "+this.props.intl.formatNumber(E(this.state.settingSpeed))+"x",e=[0,.25,.375,.5,.59375,.625,.75,1],i=e.length;return(0,r.jsx)("div",{className:"d-flex item align-items-center h-100"},(0,r.jsx)(a.Slider,{id:"setting-speed",className:"d-flex speed-controller",value:e.indexOf(this.state.settingSpeed),min:0,max:i-1,step:1,size:"sm",onChange:t=>this.handleSpeedChange(e[t.target.value]),title:t}))}renderSpeedControllerContentPalette(){const t=this.props.intl.formatMessage({id:"speed",defaultMessage:g}),e=E(this.state.settingSpeed),i=this.props.intl.formatNumber(e),s=t+": "+i+"x";return(0,r.jsx)(a.Dropdown,{isOpen:this.state.isSpeedPopupOpen,toggle:this.toggleSpeedPopup,className:"speedcontroller-btn",direction:"up"},(0,r.jsx)(a.DropdownButton,{icon:!0,className:"d-flex speedcontroller-text",title:s,type:"tertiary",arrow:!1},i+"x"),(0,r.jsx)(a.DropdownMenu,{showArrow:!1,css:r.css`
    min-width: 60px;
    padding: 0;

    .speed-popup-wapper{
      font-size: 12px;

      .dropdown-item{
        padding-left: 0;
        padding-right: 0;
      }
    }`},(0,r.jsx)("div",{className:"speed-popup-wapper"},[0,.25,.375,.5,.59375,.625,.75,1].map(((t,e)=>{const i=t===this.state.settingSpeed,s=this.props.intl.formatNumber(E(t));return(0,r.jsx)("div",{key:e},(0,r.jsx)(a.DropdownItem,{onClick:()=>this.handleSpeedChange(t),active:i},(0,r.jsx)("span",{className:"mx-2"},s+"x")))})))))}render(){if(!this.state.flyManagerItems)return null;const t=this.props.config.layout,e=this.flyManager.getFlyStyle(),i=this.renderFlyStyleSelectorContent(t),s=this.renderLiveviewSettingContent(),a=this.renderPlayStateContent(),o=this.renderProgressBarContent(t),l=this.renderSpeedControllerContent(),h=this.renderSpeedControllerContentPalette(),c=this.flyManager.isUesRouteFlyMode(),d=this.renderRouteFlyModeContent(t),u=c?[]:[ye.Point,ye.Line,ye.Pick,ye.Clear],p=(0,r.jsx)(fe,{onRef:this.handleRefGraphicInteractionManager,widgetId:this.props.widgetId,theme:this.props.theme,intl:this.props.intl,jimuMapView:this.props.jimuMapView,showItems:u,isDisabled:!this.state.isTerrainLoaded,flyStyle:e,isPlaying:this.state.isPlaying,focusedGraphic:this.state.focusedGraphic,onFocusedGraphicChanged:this.handleFocusedGraphicChanged,onDrawFinish:this.handleGraphicsUpdateHanlder,onClearBtnClick:this.handleClearBtnClick,onPickHanlder:this.handlePickHanlder});let g=null;return t===n.Horizontal?g=(0,r.jsx)(tt,{flyStyleContent:i,graphicInteractionManager:p,liveviewSettingContent:s,playStateContent:a,progressBar:o,speedController:l,theme:this.props.theme,isPlaying:this.state.isPlaying,isRouteMode:c,routeListContent:d}):t===n.Palette&&(g=(0,r.jsx)(rt,{flyStyleContent:i,graphicInteractionManager:p,liveviewSettingContent:s,playStateContent:a,progressBar:o,speedController:h,theme:this.props.theme,isPlaying:this.state.isPlaying,isRouteMode:c,routeListContent:d})),(0,r.jsx)("div",{css:r.css`
    height: 100%;

    .fly-error-tips {
      display: flex;
      height: 100%;
      justify-content: center;
      align-items: center;
    }

    .fly-controller {
      height: 32px;
    }

    .fly-wapper {
      white-space: nowrap;
    }
    `,className:"d-flex align-items-center justify-content-center"},g)}renderRouteFlyModeContent(t){const e=this.state.subCompsLoaded;return(0,r.jsx)(ct,{theme:this.props.theme,intl:this.props.intl,layout:t,isEnable:e,itemsList:this.state.flyManagerItems,activedItemUuid:this.state.activedItemUuid,activedRouteUuid:this.state.activedRouteUuid,graphicInteractionManagerRef:this.state.graphicInteractionManagerRef,isRouteMode:this.flyManager.isUesRouteFlyMode(),onActivedRouteChange:this.handleActivedRouteChange})}}class _e extends r.BaseVersionManager{constructor(){super(...arguments),this.versions=[{version:"1.2.0",description:"rename RECORD.records to RECORD.routes",upgrader:t=>{let e=t;const i=e.getIn(["itemsList"]).asMutable({deep:!0});return i.map(((t,e)=>("RECORD"===t.name&&(void 0!==t.records&&delete t.records,t.routes=[]),Object.assign({},t)))),e=e.set("itemsList",i),e}},{version:"1.5.0",description:"config upgrade for 9.2",upgrader:e=>{let i=e;const s=i.getIn(["itemsList"]).asMutable({deep:!0});if(2===s.length){const e={uuid:"2",name:t.Route,isInUse:!1,routes:[]};s.push(e)}return s.map(((e,i)=>(void 0===e.uuid&&(e.uuid=i.toString()),"RECORD"===e.name&&(e.name=t.Route),t.Route===e.name&&(void 0!==e.records&&delete e.records,e.routes=[],e.isInUse=!1),Object.assign({},e)))),i=i.set("itemsList",s),i}}]}}const Ue=new _e;var Ee=o(7182),He=o.n(Ee);class Be extends r.React.PureComponent{constructor(t){super(t),this.handleActiveViewChange=t=>null==t||"2d"===t.view.type?(this.errorTipsManager.setErrorByType(Z.Choose3DMap),void this.setState({jimuMapView:null})):(this.errorTipsManager.setError(""),void this.setState({jimuMapView:t})),this.handleViewGroupCreate=t=>{this.setState({viewGroup:t})},this.errorTipsManager=new Q({widget:this}),this.state={errorTip:this.errorTipsManager.getDefaultError(),jimuMapView:null,viewGroup:null}}componentDidMount(){const{layoutId:t,layoutItemId:e,id:i}=this.props;this.props.dispatch(r.appActions.widgetStatePropChange(i,"layoutInfo",{layoutId:t,layoutItemId:e}))}componentDidUpdate(t,e){this.errorTipsManager.isError()&&this.errorTipsManager.checkErrorInConfig()}renderWidgetPlaceholder(){return(0,r.jsx)(a.WidgetPlaceholder,{icon:He(),widgetId:this.props.id,message:this.state.errorTip,css:r.css`
    .thumbnail-wrapper {
      margin: ${r.polished.rem(5)} 0;
    }
  `})}render(){var t;const e=(0,r.jsx)(h.JimuMapViewComponent,{useMapWidgetId:null===(t=this.props.useMapWidgetIds)||void 0===t?void 0:t[0],onActiveViewChange:this.handleActiveViewChange,onViewGroupCreate:this.handleViewGroupCreate}),{config:i,intl:s,theme:n}=this.props;let a=null;return a=this.errorTipsManager.isError()?this.renderWidgetPlaceholder():(0,r.jsx)(Ne,{config:i,widgetId:this.props.id,theme:n,intl:s,jimuMapView:this.state.jimuMapView,viewGroup:this.state.viewGroup,useMapWidgetIds:this.props.useMapWidgetIds,autoControlWidgetId:this.props.autoControlWidgetId}),(0,r.jsx)("div",{className:"d-flex align-items-center justify-content-center"},a,(0,r.jsx)("div",{className:"fly-map"},(0,r.jsx)("div",null,e)))}}Be.versionManager=Ue,Be.mapExtraStateProps=(t,e)=>{var i;const{useMapWidgetIds:s}=e,n=s&&0!==s.length?s[0]:void 0,r=t&&t.mapWidgetsInfo;return{autoControlWidgetId:n?null===(i=r[n])||void 0===i?void 0:i.autoControlWidgetId:void 0}}})(),l})())}}}));