"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getWidgetsUriFromAppConfig=exports.getThumbnailUpdateMulter=exports.getUploadMulter=exports.deepClone=exports.getIdFromUrl=exports.createFolder=exports.isJson=exports.initTime=exports.writeResponseLog=exports.isHasFolder=exports.getFolderIndex=exports.addItemParamsIsPass=exports.commonResponse=exports.formatJson=exports.readFolder=exports.fuzzyMatching=exports.filterDataByPortalUrl=exports.filterDataByOwner=exports.filterByType=exports.getOwnerFromInfo=exports.getOwner=exports.sortByInitial=exports.sortByNumber=exports.requestException=exports.infoJson=exports.appFolderPath=exports.WIDGET_INFO_PATH=exports.WIDGET_EXISTED_INFO_PATH=exports.YOUR_EXTENSIONS_FOLDER=exports.DIST_FOLDER=exports.CLIENT_PATH=exports.SERVER_PATH=void 0;var path=require("path"),fs=require("fs-extra"),extra=require("fs-extra"),multer=require("@koa/multer");function requestException(e,t,r){return void 0===r&&(r=!1),"object"!=typeof e?!(t.body={error:{message:e,success:!1}}):("object"==typeof e.error&&(e.error.success=r),t.response.body=e,!1)}function sortByNumber(e,r,o){void 0===o&&(o="desc");return e.sort(function(e,t){return"desc"==o?t[r]-e[r]:"asc"==o?e[r]-t[r]:void 0}),e}function sortByInitial(e,r){return e.sort(function(e,t){e=e[r],t=t[r];return e.localeCompare(t)}),e}function getOwner(e){var t,r={owner:"",isNot:!1};return-1!=e.indexOf("owner")&&(t=e.split("owner:")[1].split(" ")[0]),-1!=e.indexOf("NOT owner")&&(r.isNot=!0,r.owner=t),-1==e.indexOf("NOT owner")&&-1!=e.indexOf(" owner")&&(r.owner=t),r}function getOwnerFromInfo(e){var t="",e=exports.appFolderPath+"/"+e+"/info.json";return t=fs.existsSync(e)?JSON.parse(fs.readFileSync(e,"utf-8")).owner:t}function filterByType(e,t){var r=[],o=t.split('"')[1];return o?(e.forEach(function(e){e.type==o&&r.push(e)}),r):[]}function filterDataByOwner(e,t,r){void 0===r&&(r=!1);var o=[],n=t;return-1!=t.indexOf('"')&&(n=t.split('"').join("")),e.forEach(function(e){r&&e.owner!=n&&o.push(e),!r&&t&&e.owner==n&&o.push(e),r||t||o.push(e)}),o}function filterDataByPortalUrl(e,t){if(!t)return e;var r=[];return e.forEach(function(e){(null==e?void 0:e.portalUrl)!=t&&null!=e&&e.portalUrl||r.push(e)}),r}function fuzzyMatching(e,t,r,o){var n=(n=o?null==t?void 0:t.toLowerCase():t).replace(/\"/g,"").replace(/\'/g,""),s=[];return e.forEach(function(e){var t=o?null===(t=e[r])||void 0===t?void 0:t.toLowerCase():e[r];n&&-1==(null==t?void 0:t.indexOf(n))&&e.id!=n||s.push(e)}),s}function readFolder(o,n,e){var s=[];return e&&Array.isArray(e)&&(s=deepClone(e)),fs.readdirSync(o).forEach(function(e){var t=path.join(o,e),r={size:0,created:"",resource:t.split("\\").join("/").split(n)[1]},e=fs.statSync(t);e.isFile()?(r.size=e.size,r.created=e.birthtime.getTime().toLocaleString().split(",").join(""),s.push(r)):s=readFolder(t,n,s)}),s}function formatJson(t,e){if(!e||-1==e.indexOf(".json"))return!1;fs.exists(t,function(e){e&&(e=JSON.parse(fs.readFileSync(t,"utf-8")),e=JSON.stringify(e,null,2),fs.writeFileSync(t,e))})}function commonResponse(e,t){e.response.body=t}function addItemParamsIsPass(e){var t="";return t=!e.title?"no title":t}function getFolderIndex(e,t){return isHasFolder(e,t)?getFolderIndex(e,t+1):t}function isHasFolder(e,t){if(!Array.isArray(e))return!1;var r=!1;return e.forEach(function(e){e==t&&(r=!0)}),r}function writeResponseLog(e,t){void 0===t&&(t=!1)}function initTime(e){if(!e)return!1;e=new Date(e);return e.getFullYear()+"-"+((e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1)+"-")+(e.getDate()+" ")+(e.getHours()+":")+(e.getMinutes()+":")+e.getSeconds()}function isJson(e){return"object"==typeof(e="string"==typeof e?JSON.parse(e):e)&&"[object object]"==Object.prototype.toString.call(e).toLowerCase()&&!e.length}function createFolder(r,e){var e=e.split("/"),o="";e.forEach(function(e){var t=""+r+o+"/"+e;fs.ensureDirSync(t),o=o+"/"+e+"/"})}function getIdFromUrl(e,t){void 0===t&&(t=1);var r=e.request.url,r=(r="/"==r?e.originalUrl:r).split("/");return r[r.length-1-t]}function deepClone(e){var t,r=Array.isArray(e)?[]:{};for(t in e){var o=("object"==typeof e[t]||"function"==typeof e[t])&&null!==e[t];r[t]=o?deepClone(e[t]):e[t]}return r}function getUploadMulter(){var e=multer.diskStorage({destination:function(r,e,o){try{Promise.resolve(!0).then(function(){var e=r.url.split("/"),t=e[e.length-2],e=r.body||{},t=exports.appFolderPath+"/"+t,e="resources/"+e.resourcesPrefix;fs.existsSync(t)?createFolder(t,e):console.log("no item"),o(null,t+"/"+e)})}catch(e){console.log(e)}},filename:function(e,t,r){t=t.originalname.split(".");r(null,(e.body||{}).fileName||Date.now()+"."+t[t.length-1])}});return multer({storage:e})}function getThumbnailUpdateMulter(){var e=multer.diskStorage({destination:function(r,e,o){try{Promise.resolve(!0).then(function(){var e=r.url.split("/"),t=e[e.length-2],e=exports.appFolderPath+"/"+t,t=e+"/thumbnail";fs.existsSync(e)||console.log("no item"),extra.emptyDirSync(t),o(null,t)})}catch(e){console.log(e)}},filename:function(e,t,r){var o=t.originalname.split("."),t=o[o.length-1];1==o.length&&(t="png"),r(null,"thumbnail"+Date.now()+"."+t)}});return multer({storage:e})}function getWidgetsUriFromAppConfig(t){var e=path.join(exports.CLIENT_PATH,exports.DIST_FOLDER),r=[],o=[],e=fs.existsSync(path.join(e,exports.WIDGET_EXISTED_INFO_PATH))?path.join(e,exports.WIDGET_EXISTED_INFO_PATH):path.join(e,exports.WIDGET_INFO_PATH),n=JSON.parse(fs.readFileSync(e,"utf8")).map(function(e){return e.uri});return t.widgets&&Object.keys(t.widgets).forEach(function(e){e=t.widgets[e];n.includes(e.uri)?r.includes(e.uri)||r.push(e.uri):o.includes(e.uri)||o.push(e.uri)}),{coreWidgetsUri:r,customWidgetsUri:o}}exports.SERVER_PATH=path.join(__dirname,"../../../.."),exports.CLIENT_PATH=path.join(exports.SERVER_PATH,"../client"),exports.DIST_FOLDER="dist",exports.YOUR_EXTENSIONS_FOLDER="your-extensions",exports.WIDGET_EXISTED_INFO_PATH="widgets/widgets-info-existed.json",exports.WIDGET_INFO_PATH="widgets/widgets-info.json",exports.appFolderPath=path.join(__dirname,"../../../../public/apps"),console.log("Apps folder:",exports.appFolderPath),exports.infoJson={created:0,description:"",id:"",modified:0,owner:"",tags:[],thumbnail:null,title:"",type:"Web Experience",snippet:"",typeKeywords:["Web Experience","status: Draft"]},exports.requestException=requestException,exports.sortByNumber=sortByNumber,exports.sortByInitial=sortByInitial,exports.getOwner=getOwner,exports.getOwnerFromInfo=getOwnerFromInfo,exports.filterByType=filterByType,exports.filterDataByOwner=filterDataByOwner,exports.filterDataByPortalUrl=filterDataByPortalUrl,exports.fuzzyMatching=fuzzyMatching,exports.readFolder=readFolder,exports.formatJson=formatJson,exports.commonResponse=commonResponse,exports.addItemParamsIsPass=addItemParamsIsPass,exports.getFolderIndex=getFolderIndex,exports.isHasFolder=isHasFolder,exports.writeResponseLog=writeResponseLog,exports.initTime=initTime,exports.isJson=isJson,exports.createFolder=createFolder,exports.getIdFromUrl=getIdFromUrl,exports.deepClone=deepClone,exports.getUploadMulter=getUploadMulter,exports.getThumbnailUpdateMulter=getThumbnailUpdateMulter,exports.getWidgetsUriFromAppConfig=getWidgetsUriFromAppConfig;