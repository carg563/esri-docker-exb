"use strict";var __awaiter=this&&this.__awaiter||function(e,o,a,c){return new(a=a||Promise)(function(r,t){function i(e){try{s(c.next(e))}catch(e){t(e)}}function n(e){try{s(c.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?r(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(i,n)}s((c=c.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(r,i){var n,s,o,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,s&&(o=2&t[0]?s.return:t[0]?s.throw||((o=s.return)&&o.call(s),0):s.next)&&!(o=o.call(s,t[1])).done)return o;switch(s=0,(t=o?[2&t[0],o.value]:t)[0]){case 0:case 1:o=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,s=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(o=0<(o=a.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){a.label=t[1];break}if(6===t[0]&&a.label<o[1]){a.label=o[1],o=t;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(t);break}o[2]&&a.ops.pop(),a.trys.pop();continue}t=i.call(r,a)}catch(e){t=[6,e],s=0}finally{n=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.zipApp=exports.download=void 0;var path=require("path"),fs=require("fs-extra"),AdmZip=require("adm-zip"),fetch=require("cross-fetch"),child_process_1=require("child_process");require("isomorphic-form-data"),require("../../../global");var i18n_utils_1=require("../i18n-utils"),utils_1=require("../../utils"),downloadTimes=0,distFolder="dist",prodDistFolder="dist-prod",serverPath=path.join(__dirname,"../../../.."),clientPath=path.join(serverPath,"../client"),isReleasePackage=fs.existsSync(path.join(clientPath,distFolder,"widgets/widgets-info-existed.json"));function download(o,a){return __awaiter(this,void 0,void 0,function(){var t,r,i,n,s;return __generator(this,function(e){switch(e.label){case 0:return[4,utils_1.checkToken(o.query.token)];case 1:if(!e.sent())return o.body="Please log in.",[2];t=o.params.appId,r=o.query.locale||"en",e.label=2;case 2:return e.trys.push([2,4,,5]),[4,createZipForApp(t,r)];case 3:return(s=e.sent(),i=s.message,n=s.fileName,s=s.zip,i)?(o.body=i,[2]):(n&&(o.response.set("Content-disposition","attachment; filename="+n+".zip"),o.body=s.toBuffer()),[3,5]);case 4:return s=e.sent(),console.error(s),[3,5];case 5:return[4,a()];case 6:return e.sent(),[2]}})})}function zipApp(i,n){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),fs.existsSync(n)?(console.log(n+" exists, please use a new name."),[2]):[4,createZipForApp(i,"en")];case 1:return(r=e.sent(),t=r.message,r=r.zip,t)?(console.log(t),[2]):(r&&r.writeZip(n,function(e){e?console.error(e):console.log("Done.")}),[3,3]);case 2:return r=e.sent(),console.error(r),[3,3];case 3:return[2]}})})}function createZipForApp(j,g){return __awaiter(this,void 0,void 0,function(){var t,r,i,n,s,o,a,c,u,p,l,f,h,d;return __generator(this,function(e){switch(e.label){case 0:return(d=path.join(serverPath,"temp"),t=path.join(serverPath,"public/apps",j),r=path.join(d,j),fs.existsSync(t))?(s=(n=JSON).parse,[4,fs.readFile(path.join(t,"config.json"),"utf-8")]):[2,i18n_utils_1.getMessage("notFound",g).then(function(e){return{message:e,fileName:null,zip:null}})];case 1:return i=s.apply(n,[e.sent()]),c=(a=JSON).parse,[4,fs.readFile(path.join(t,"info.json"),"utf-8")];case 2:return(o=c.apply(a,[e.sent()]),u=path.join(t,"download-times.json"),fs.existsSync(u))?(l=parseInt,[4,fs.readFile(u,"utf-8")]):[3,4];case 3:return p=l.apply(void 0,[e.sent()]),[3,5];case 4:p=0,e.label=5;case 5:return downloadTimes=p,downloadTimes++,!0===i.__not_publish?[2,i18n_utils_1.getMessage("notPublished",g).then(function(e){return{message:e,fileName:null,zip:null}})]:[4,fs.pathExists(r)];case 6:return e.sent()?[4,fs.remove(r)]:[3,8];case 7:e.sent(),e.label=8;case 8:return[4,fs.ensureDir(r)];case 9:return e.sent(),[4,compileWidgets(i)];case 10:return e.sent(),[4,copyAppCode(r,i,o.title)];case 11:return e.sent(),i.attributes.clientId="",i.attributes.title=o.title,i.attributes.description=o.snippet,f=path.join(r,getCDNString()),[4,fs.writeFile(path.join(f,"config.json"),JSON.stringify(i,null,2),"utf-8")];case 12:return e.sent(),[4,fs.copy(path.join(t,"resources"),path.join(f,"resources"))];case 13:return e.sent(),(h=new AdmZip).addLocalFolder(r),d=encodeURI(o.title),fs.writeFileSync(u,downloadTimes+"","utf-8"),[2,Promise.resolve({message:null,fileName:d,zip:h})]}})})}function copyAppCode(s,o,a){return __awaiter(this,void 0,void 0,function(){var t,r,i,n;return __generator(this,function(e){switch(e.label){case 0:return t=path.join(clientPath,distFolder),r=path.join(clientPath,prodDistFolder),[4,fs.copy(path.join(t,"experience/index.html"),path.join(s,"index.html"))];case 1:return e.sent(),[4,fs.copy(path.join(t,"experience/web.config"),path.join(s,"web.config"))];case 2:return e.sent(),[4,fixIndexFile(path.join(s,"index.html"),a)];case 3:return e.sent(),"production"===process.env.NODE_ENV&&fs.existsSync(path.join(t,"service-worker.prod.js"))?[4,fs.copy(path.join(t,"service-worker.prod.js"),path.join(s,"service-worker.js"))]:[3,5];case 4:return e.sent(),[3,7];case 5:return[4,fs.copy(path.join(t,"service-worker.js"),path.join(s,"service-worker.js"))];case 6:e.sent(),e.label=7;case 7:return i=path.join(s,getCDNString()),[4,fs.copy(path.join(t,"experience/index.js"),path.join(i,"index.js"))];case 8:return e.sent(),[4,fs.copy(path.join(t,"experience/assets"),path.join(i,"assets"))];case 9:return e.sent(),[4,fs.copy(path.join(t,"service-worker-registration.js"),path.join(i,"service-worker-registration.js"))];case 10:return e.sent(),[4,fixServiceWorkerFile(path.join(i,"service-worker-registration.js"))];case 11:return e.sent(),[4,fs.copy(path.join(t,"jimu-core"),path.join(i,"jimu-core"))];case 12:return e.sent(),[4,fs.copy(path.join(t,"jimu-ui"),path.join(i,"jimu-ui"))];case 13:return e.sent(),[4,fs.copy(path.join(t,"jimu-layouts"),path.join(i,"jimu-layouts"))];case 14:return e.sent(),[4,fs.copy(path.join(t,"jimu-arcgis"),path.join(i,"jimu-arcgis"))];case 15:return e.sent(),[4,fs.copy(path.join(t,"jimu-theme"),path.join(i,"jimu-theme"))];case 16:return e.sent(),[4,fs.copy(path.join(t,"jimu-for-builder"),path.join(i,"jimu-for-builder"))];case 17:return e.sent(),[4,fs.copy(path.join(t,o.theme),path.join(i,o.theme))];case 18:return e.sent(),[4,fs.pathExists(path.join(t,"arcgis-charts"))];case 19:return e.sent()?[4,fs.copy(path.join(t,"arcgis-charts"),path.join(i,"arcgis-charts"))]:[3,21];case 20:e.sent(),e.label=21;case 21:return n=getWidgetsUriFromAppConfig(o),[4,Promise.all(n.coreWidgetsUri.map(function(e){return fs.copy(path.join(t,e),path.join(i,e))}).concat(n.customWidgetsUri.map(function(e){return"production"===process.env.NODE_ENV&&isReleasePackage?fs.copy(path.join(r,e),path.join(i,e)):fs.copy(path.join(t,e),path.join(i,e))})))];case 22:return e.sent(),[4,Promise.all(n.coreWidgetsUri.concat(n.customWidgetsUri).map(function(e){var t=path.join(i,e,"src"),r=path.join(i,e,"tests"),e=[];return fs.existsSync(t)&&e.push(fs.remove(t)),fs.existsSync(r)&&e.push(fs.remove(r)),Promise.all(e)}))];case 23:return e.sent(),[2]}})})}function compileWidgets(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return"production"!==process.env.NODE_ENV||!isReleasePackage||0===getWidgetsUriFromAppConfig(t).customWidgetsUri.length?[2,Promise.resolve()]:(child_process_1.execSync("npm run build:prod",{cwd:clientPath}),[2])})})}function getWidgetsUriFromAppConfig(t){var r=[],i=[],e=path.join(clientPath,distFolder),e=fs.existsSync(path.join(e,"widgets/widgets-info-existed.json"))?path.join(e,"widgets/widgets-info-existed.json"):path.join(e,"widgets/widgets-info.json"),n=JSON.parse(fs.readFileSync(e,"utf8")).map(function(e){return e.uri});return t.widgets&&Object.keys(t.widgets).forEach(function(e){e=t.widgets[e];n.includes(e.uri)?r.includes(e.uri)||r.push(e.uri):i.includes(e.uri)||i.push(e.uri)}),{coreWidgetsUri:r,customWidgetsUri:i}}function fixIndexFile(r,i){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,fs.readFile(r,"utf-8")];case 1:return t=(t=e.sent()).replace(/<base.*\/>/,'<base href="./'+getCDNString()+'/"/>').replace("var mountPath = '/';","var mountPath = getPath();").replace("var isOutOfExb = false;","var isOutOfExb = true;").replace("var isDevEdition = true;","var isDevEdition = false;").replace("var useStructuralUrl = true;","var useStructuralUrl = false;").replace(/var\sbuildNumber.+;/,"var buildNumber = '"+downloadTimes+"';").replace("var appFolderName = 'experience';","var appFolderName = '.';").replace('<script src="../service-worker-registration.js"><\/script>','<script src="./service-worker-registration.js"><\/script>').replace('<script src="../jimu-core/init.js"><\/script>','<script src="./jimu-core/init.js"><\/script>').replace("<title>Experience</title>","<title>"+i+"</title>"),[4,fs.writeFile(r,t,"utf-8")];case 2:return e.sent(),[2]}})})}function fixServiceWorkerFile(r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,fs.readFile(r,"utf-8")];case 1:return t=(t=e.sent()).replace("register(window.jimuConfig.mountPath + 'service-worker.js')","register('../../service-worker.js')"),[4,fs.writeFile(r,t,"utf-8")];case 2:return e.sent(),[2]}})})}function getCDNString(){return"cdn/"+downloadTimes}global.fetch=fetch,exports.download=download,exports.zipApp=zipApp;