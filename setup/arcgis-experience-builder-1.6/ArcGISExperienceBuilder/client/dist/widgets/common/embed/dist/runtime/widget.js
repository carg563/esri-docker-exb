System.register(["jimu-core","jimu-ui","jimu-layouts/layout-runtime"],(function(e,t){var s={},o={},r={};return{setters:[function(e){s.AppMode=e.AppMode,s.BaseVersionManager=e.BaseVersionManager,s.ExpressionPartType=e.ExpressionPartType,s.React=e.React,s.SessionManager=e.SessionManager,s.getAppStore=e.getAppStore,s.queryString=e.queryString,s.urlUtils=e.urlUtils,s.utils=e.utils},function(e){o.AlertButton=e.AlertButton,o.DynamicUrlResolver=e.DynamicUrlResolver,o.WidgetPlaceholder=e.WidgetPlaceholder},function(e){r.ParentType=e.ParentType,r.ViewVisibilityContext=e.ViewVisibilityContext,r.searchUtils=e.searchUtils,r.utils=e.utils}],execute:function(){e((()=>{var e={27587:e=>{e.exports='<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M2 1a1 1 0 00-1 1v12a1 1 0 001 1h12a1 1 0 001-1V2a1 1 0 00-1-1H2zm0-1h12a2 2 0 012 2v12a2 2 0 01-2 2H2a2 2 0 01-2-2V2a2 2 0 012-2zM1 4h14v1H1V4zm1.5-1a.5.5 0 110-1 .5.5 0 010 1zm2 0a.5.5 0 110-1 .5.5 0 010 1zm2 0a.5.5 0 110-1 .5.5 0 010 1zm-.646 9.646a.5.5 0 11-.708.708l-3-3a.5.5 0 010-.708l3-3a.5.5 0 11.708.708L3.207 10l2.647 2.646zm4.292 0L12.793 10l-2.647-2.646a.5.5 0 11.708-.708l3 3a.5.5 0 010 .708l-3 3a.5.5 0 11-.708-.708zM8.982 6.62a.5.5 0 01.354.613l-1.553 5.795a.5.5 0 11-.966-.259L8.37 6.973a.5.5 0 01.612-.354z" fill="#000" fill-rule="nonzero"></path></svg>'},1810:e=>{"use strict";e.exports=s},29169:e=>{"use strict";e.exports=r},21835:e=>{"use strict";e.exports=o}},t={};function i(s){var o=t[s];if(void 0!==o)return o.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,i),r.exports}i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.p="";var n={};return i.p=window.jimuConfig.baseUrl,(()=>{"use strict";i.r(n),i.d(n,{default:()=>d});var e,t=i(1810),s=i(21835);!function(e){e.Url="url",e.Code="code"}(e||(e={}));const o={_widgetLabel:"Embed",embedHint:"Embed by URL or code",unSupportUrl:"It's not a valid URL.",unSupportIframeUrl:"Sorry, this content could not be embedded. It may restrict the embedding of content from other sites."},r=e=>{try{let t=JSON.stringify(e);return t=encodeURIComponent(t),t}catch(e){console.error(e)}};class a extends t.BaseVersionManager{constructor(){super(...arguments),this.versions=[{version:"1.0.0",description:"The first release.",upgrader:t=>{var s,o;const r=null===(s=null==t?void 0:t.functionConfig)||void 0===s?void 0:s.embedType,i=null===(o=null==t?void 0:t.functionConfig)||void 0===o?void 0:o.content;return r?(t=t.set("embedType",r),t=r===e.Url?t.set("staticUrl",i):t.set("embedCode",i)):t=t.set("embedType",e.Url),t.without("functionConfig")}},{version:"1.4.0",description:"Enhance the URL editor.",upgrader:(s,o)=>{var i,n;const a=null==s?void 0:s.embedType,l=null==s?void 0:s.expression,c=null==s?void 0:s.staticUrl,d=null===(n=null===(i=(0,t.getAppStore)().getState())||void 0===i?void 0:i.appConfig)||void 0===n?void 0:n.widgets[o],u=null==d?void 0:d.useDataSourcesEnabled;if((null==l?void 0:l.name)&&(s=s.set("enableLabel",!0).set("label",l.name)),a===e.Url&&c){const e=`<p>${c}</p>`;s=s.set("expression",e)}else if(a===e.Url&&l&&!1!==u){const e=(e=>{let s="";const{parts:o}=e;if(o.length>0){let e=!1;const i={name:"",parts:[]};let n=0,a=0,l="";o.forEach((o=>{const{type:c,dataSourceId:d,exp:u}=o;if(e){if(i.name+=u,i.parts.push(o),d&&(l=d),c===t.ExpressionPartType.Operator&&"("===u)n++;else if(c===t.ExpressionPartType.Operator&&")"===u&&(a++,a===n)){n=0,a=0,e=!1;const o=t.utils.getUUID(),c=document&&document.createElement("exp");c.setAttribute("data-uniqueid",o),c.setAttribute("data-dsid",l),c.setAttribute("data-expression",r(i)),c.innerHTML=i.name,s+=c.outerHTML}return!1}if(c===t.ExpressionPartType.Field){const e=t.utils.getUUID(),i=document&&document.createElement("exp");i.setAttribute("data-uniqueid",e),i.setAttribute("data-dsid",d),i.setAttribute("data-expression",r({name:u,parts:[o]})),i.innerHTML=u,s+=i.outerHTML}else c===t.ExpressionPartType.String?s+=u.replace(/(^['|"]*|['|"]*$)/g,""):c===t.ExpressionPartType.Number?s+=u:c===t.ExpressionPartType.Function&&(e=!0,i.name=u,i.parts.push(o))}))}return`<p>${s}</p>`})(l);s=s.set("expression",e)}return s}}]}}const l=new a;var c=i(29169);class d extends t.React.PureComponent{constructor(s){super(s),this.isUrlResolved=e=>!/\<p((?!\<p).)+\<\/p\>/gim.test(e),this.iframeOnLoad=e=>{this.setState({isResetting:!1})},this.checkSafeDomain=e=>{let t=!1;if(!e)return t;const s=[".arcgis.com",".esri.com"];let o="";e.includes("https://")&&(o=e.substr(8).split("/")[0]);for(const e of s)if(o.includes(e)){t=!0;break}return t},this.processUrl=e=>{var s,o,r;if(!e)return e;const i=e.toLowerCase();if(/https:\/\/vimeo\.com\/.*/.test(i)){const s=(e=t.urlUtils.removeSearchFromUrl(e)).split("/");return`https://player.vimeo.com/video/${s[s.length-1]}`}if(/https:\/\/www\.youtube\.com\/watch\?.*v=.*/.test(i)){const o=null===(s=t.queryString.parseUrl(e))||void 0===s?void 0:s.query;return`https://www.youtube.com/embed/${null==o?void 0:o.v}`}if(/https:\/\/youtu\.be\/.*/.test(i)){const s=(e=t.urlUtils.removeSearchFromUrl(e)).split("/");return`https://www.youtube.com/embed/${s[s.length-1]}`}if(/https:\/\/www\.facebook\.com\/.*\/videos\/.*/.test(i))return`https://www.facebook.com/plugins/video.php?href=${i}&show_text=0`;this.checkURLFormat(e)||(e="about:blank");const n=[".maps.arcgis.com",".mapsdevext.arcgis.com",".mapsqa.arcgis.com"];let a="";e.includes("https://")&&(a=e.substr(8).split("/")[0]);let l=!1,c="";for(const e of n)if(a.includes(e)){switch(l=!0,e){case".maps.arcgis.com":c="prod";break;case".mapsdevext.arcgis.com":c="dev";break;case".mapsqa.arcgis.com":c="qa"}break}const d=window.jimuConfig.hostEnv;if(l&&c===d){const s=(0,t.getAppStore)().getState();if(s&&s.user){const t=null===(o=null==s?void 0:s.portalSelf)||void 0===o?void 0:o.urlKey,i=null===(r=null==s?void 0:s.portalSelf)||void 0===r?void 0:r.customBaseUrl;a&&t&&i&&(e=e.replace(a,`${t}.${i}`))}}return e},this.checkURLFormat=e=>{if(!e||""===e)return this.setState({errMessage:this.errMessages.unSupportUrl}),!1;if("about:blank"===e)return!1;if(!new RegExp("^(([h][t]{2}[p][s])?://)").test(e))return this.setState({errMessage:this.errMessages.httpsCheck}),!1;if(new RegExp("^(([h][t]{2}[p][s])?://localhost)").test(e))return!0;const t=e.indexOf(".");return!(t<0||t===e.length-1)||(this.setState({errMessage:this.errMessages.unSupportUrl}),!1)},this.formatMessage=e=>this.props.intl.formatMessage({id:e,defaultMessage:o[e]}),this.fetchUrl=(e,s)=>{return o=this,r=void 0,n=function*(){const o=t.SessionManager.getInstance().getMainSession(),r=yield fetch(e,{method:"post",headers:{"Access-Control-Allow-Origin":"*","Content-Type":"application/json"},body:JSON.stringify({token:null==o?void 0:o.token,url:s})}).catch((e=>{console.error(e)}));if(!r)return Promise.resolve(null);const i=yield r.json().catch((e=>{console.error(e)}));return Promise.resolve(i)},new((i=void 0)||(i=Promise))((function(e,t){function s(e){try{l(n.next(e))}catch(e){t(e)}}function a(e){try{l(n.throw(e))}catch(e){t(e)}}function l(t){var o;t.done?e(t.value):(o=t.value,o instanceof i?o:new i((function(e){e(o)}))).then(s,a)}l((n=n.apply(o,r||[])).next())}));var o,r,i,n},this.isUsedDataSource=e=>{e||(e=this.props);const{useDataSources:t,useDataSourcesEnabled:s}=e;return s&&t&&t.length>0},this.reload=()=>{const{config:t}=this.props;if(this.ifr)if(t.embedType===e.Code){const e=this.ifr.srcdoc;this.ifr.srcdoc=e}else{const e=this.ifr.src;this.ifr.src=e}},this.loadContent=()=>{const{config:t}=this.props,{content:s}=this.state,{embedType:o}=t;this.ifr&&(o===e.Code?this.ifr.srcdoc=`<script>\n      if(window !== window.parent || window !== window.top){\n        window.parent = undefined\n        window.top = undefined\n        document.cookie = undefined\n        localStorage = undefined\n        sessionStorage = undefined\n      }\n    <\/script>${s}`:(this.ifr.removeAttribute("srcdoc"),this.ifr.removeAttribute("src"),setTimeout((()=>{this.ifr&&(this.ifr.src=this.processUrl(s))}),100)))},this.onHtmlResolved=e=>{const{config:t}=this.props,{enableLabel:s,label:o}=t,r=e?e.replace(/(^\s*|\s*$)/g,""):"",i=r.indexOf("{")>0&&s&&!!o,n=0===r.indexOf("{")||i;this.setState({content:e,reuseContent:e,resolveErr:n})};const{config:r}=s,{embedType:i,embedCode:n}=r;this.errMessages={httpsCheck:this.formatMessage("httpsUrlMessage"),unSupportUrl:this.formatMessage("unSupportUrl"),unSupportIframeUrl:this.formatMessage("unSupportIframeUrl")},this.checkUrl=this.checkUrl.bind(this);const a={content:i===e.Url?r.expression:n,reuseContent:"",loadErr:!1,resolveErr:!1,refreshFlag:!1,refreshInterval:10,refreshTimer:void 0,changeTimerFlag:!1};this.state=a,this.shouldRenderIframeInView=!1}static getDerivedStateFromProps(e,t){if(!e||0===Object.keys(e).length||!t||0===Object.keys(t).length)return null;const{config:s}=e,{autoRefresh:o=!1,autoInterval:r=10}=s,{refreshFlag:i,refreshInterval:n}=t;return o!==i||r!==n?{refreshFlag:o,refreshInterval:r,changeTimerFlag:!0}:null}componentDidMount(){const{config:t}=this.props,{content:s}=this.state;s&&s.trim().length>0&&this.setState({isResetting:!0},(()=>{t.embedType===e.Url?this.isUrlResolved(s)&&this.checkUrl(this.processUrl(s)):this.loadContent()}))}componentDidUpdate(s,o){var r,i,n,a,l,d,u,p;const{appMode:h,config:f,sectionNavInfos:m,layoutId:v}=this.props,{embedCode:g,embedType:w,autoRefresh:b,autoInterval:y}=f,S=b!==s.config.autoRefresh||y!==s.config.autoInterval,{content:U,reuseContent:x,refreshFlag:R,refreshInterval:I,refreshTimer:M,changeTimerFlag:C}=this.state,{content:E}=o;if((h!==s.appMode&&h===t.AppMode.Design||S)&&this.reload(),w!==s.config.embedType){const t=w===e.Url?x:g;this.setState({loadErr:!1,resolveErr:!1,content:t})}else w===e.Code&&s.config.embedCode!==g&&this.setState({content:g});U!==E&&this.setState({isResetting:!!U,loadErr:!1},(()=>{w===e.Url?this.checkUrl(this.processUrl(U)):this.loadContent()}));const T=s.sectionNavInfos;if(this.needLoadContentInView&&m&&T!==m){const e=[];for(const t in m)m[t]!==(null==T?void 0:T[t])&&e.push(t);const s=(0,t.getAppStore)().getState(),o=null==s?void 0:s.appConfig,h=null===(r=null==s?void 0:s.appRuntimeInfo)||void 0===r?void 0:r.currentPageId,f=c.utils.getCurrentSizeMode(),g=o.mainSizeMode,w=null!==(l=null===(a=null===(n=null===(i=null==o?void 0:o.pages)||void 0===i?void 0:i[h])||void 0===n?void 0:n.layout)||void 0===a?void 0:a[f])&&void 0!==l?l:null===(p=null===(u=null===(d=null==o?void 0:o.pages)||void 0===d?void 0:d[h])||void 0===u?void 0:u.layout)||void 0===p?void 0:p[g],b=c.searchUtils.buildLayoutStructure(o,w,h,c.ParentType.Page,f),{sectionId:y}=c.searchUtils.findParentViewId(v,b);e.includes(y)&&this.loadContent()}if(!M&&R){const t=setInterval((()=>{if(w===e.Url){if(this.ifr){const e=this.ifr.src;this.ifr.src="",setTimeout((()=>{this.ifr&&(this.ifr.src=e)}),100)}}else{const e=this.ifr.srcdoc;this.ifr.srcdoc=e}}),60*I*1e3);this.setState({refreshTimer:t})}else M&&!R&&(clearInterval(M),this.setState({refreshTimer:void 0}));if(C&&!R){M&&clearInterval(M);const t=setInterval((()=>{if(w===e.Url){if(this.ifr){const e=this.ifr.src;this.ifr.src="",setTimeout((()=>{this.ifr&&(this.ifr.src=e)}),100)}}else{const e=this.ifr.srcdoc;this.ifr.srcdoc=e}}),60*I*1e3);this.setState({refreshTimer:t,changeTimerFlag:!1})}}checkUrl(e){var s,o,r;if(!this.checkURLFormat(e))return void this.setState({loadErr:!0});this.setState({loadErr:!1});const i=null===(r=null===(o=null===(s=(0,t.getAppStore)())||void 0===s?void 0:s.getState())||void 0===o?void 0:o.appRuntimeInfo)||void 0===r?void 0:r.appMode;window.jimuConfig.isInBuilder&&i!==t.AppMode.Run&&!window.jimuConfig.isInPortal||this.loadContent(),e.includes("{")?this.setState({resolveErr:!0}):e&&window.jimuConfig.isInBuilder&&i!==t.AppMode.Run&&!window.jimuConfig.isInPortal&&(["https://www.facebook.com/plugins/video.php?show_text=0&href=","https://www.youtube.com/embed/","https://player.vimeo.com/video/"].includes(e)?this.setState({loadErr:!1}):this.fetchUrl(`${window.location.origin}/rest/check_url`,e).then((t=>{var s,o,r;let i=!0;if(t&&t.success){const n=t.data,a=null==n?void 0:n.status,l=['default-src "self"',"frame-ancestors"],c=e=>{let t=!1;return l.forEach((s=>{e.indexOf(s)>0&&(t=!0)})),t};if(a&&a<400){const t=null===(s=null==n?void 0:n.headers)||void 0===s?void 0:s["content-security-policy"];t&&c(t)&&(i=!1);const a=null===(r=null===(o=null==n?void 0:n.headers)||void 0===o?void 0:o["x-frame-options"])||void 0===r?void 0:r.toLowerCase();a&&("deny"===a?i=!1:"sameorigin"===a&&(this.isOriginSameAsLocation(e)||(i=!1)))}else i=!1}else i=!1;const n={loadErr:!i};i?this.loadContent():(n.isResetting=!1,n.errMessage=this.errMessages.unSupportIframeUrl),this.setState(n)})))}isOriginSameAsLocation(e){const t=[".arcgis.com",".esri.com"],s=window.location,o=/(\w+:)?(?:\/\/)([\w.-]+)?(?::(\d+))?\/?/.exec(e)||[],r={protocol:o[1]||"",host:o[2]||"",port:o[3]||""};let i="";for(const e of t)if(s.host.includes(e)){i=e;break}if(o[2].includes(i))return!0;const n=e=>e.port||{"http:":80,"https:":443}[e.protocol||s.protocol];return!!(r.protocol&&r.protocol===s.protocol&&r.host&&r.host===s.host&&r.host&&n(r)===n(s))}render(){const{isResetting:o,loadErr:r,errMessage:n,resolveErr:a,content:l}=this.state,{theme:d,id:u,config:p}=this.props,{embedCode:h,embedType:f,expression:m,enableLabel:v,label:g}=p;if(f===e.Code?!h:!m||"<p><br></p>"===m)return t.React.createElement(s.WidgetPlaceholder,{widgetId:this.props.id,icon:i(27587),message:this.formatMessage("embedHint")});let w=!0;return f===e.Url&&(w=!this.checkSafeDomain(l)),t.React.createElement(c.ViewVisibilityContext.Consumer,null,(({isInView:i,isInCurrentView:c})=>{let h=!0;return this.shouldRenderIframeInView||(h=!i||c,h&&(this.shouldRenderIframeInView=!0)),this.needLoadContentInView=i&&c,t.React.createElement(t.React.Fragment,null,h&&t.React.createElement("div",{style:{width:"100%",height:"100%",position:"relative"},className:"jimu-widget widget-embed"},w?t.React.createElement("iframe",{id:"ifrSandbox",className:`iframe-${u}`,style:{width:"100%",height:"100%"},sandbox:"allow-scripts allow-same-origin allow-forms allow-popups allow-presentation allow-popups-to-escape-sandbox",allowFullScreen:!0,onLoad:this.iframeOnLoad,frameBorder:"0",ref:e=>{this.ifr=e},allow:"geolocation","data-testid":"embedSandbox"}):t.React.createElement("iframe",{id:"ifrSafe",className:`iframe-${u}`,style:{width:"100%",height:"100%"},allowFullScreen:!0,onLoad:this.iframeOnLoad,frameBorder:"0",ref:e=>{this.ifr=e},allow:"geolocation","data-testid":"embedSafe"}),o&&t.React.createElement("div",{className:"jimu-secondary-loading"}),r&&t.React.createElement("div",{className:"mask text-center",style:{position:"absolute",left:0,right:0,top:0,bottom:0,backgroundColor:d.colors.white}},t.React.createElement("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)"}},t.React.createElement(s.AlertButton,{buttonType:"tertiary",size:"small",type:"warning"}),n)),a&&t.React.createElement("div",{"data-testid":"test-expressionMask",className:"mask text-center",style:{position:"absolute",left:0,right:0,top:0,bottom:0,backgroundColor:d.colors.white}},t.React.createElement("div",{className:!(v&&g)&&"text-truncate",style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"50%"},title:v&&g||l},v&&g||l)),f===e.Url&&t.React.createElement(s.DynamicUrlResolver,{widgetId:u,useDataSources:this.props.useDataSources,value:p.expression,onHtmlResolved:this.onHtmlResolved})))}))}}d.versionManager=l,d.mapExtraStateProps=(e,t)=>{var s,o;return{appMode:null===(s=null==e?void 0:e.appRuntimeInfo)||void 0===s?void 0:s.appMode,sectionNavInfos:null===(o=null==e?void 0:e.appRuntimeInfo)||void 0===o?void 0:o.sectionNavInfos}}})(),n})())}}}));